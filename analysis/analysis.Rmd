---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "..")
```

```{r libraries, include=FALSE}
library(tidyverse)
library(reshape2)
library(rstanarm)
library(brms)
library(rstan)
library(tidybayes)
library(mice)
library(klaR)
source("utils/plotting.R")
source("utils/summaries.r")
```


## Data

We analyze the quality of life (QoL) outcomes of tuberculosis (TB) patients 
at the start of, end of, and post treatment in IeDEA-SA cohorts:
South Africa, Malawi, Mozambique, Zambia, and Zimbabwe.
The  data is as of Sep 12, 2024.


```{r data, include=FALSE}
# data of patients with at least one outcome
qol <- readRDS("data-clean/phys-ment-data.rds") %>%
  arrange(time, record_id) %>%
  # cutoffs
  mutate(
    phq9_score_bin = ifelse(phq9_score > 10, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    tb_symp_score_bin = ifelse(tb_symp_score > 4, 1, 0)
  )


qol_start <- filter(qol, time == "Start")
qol_end <- filter(qol, time == "End")
qol_post <- filter(qol, time == "Post")

# labeling
outcome_cont <- c(
  "phq9_score" = "PHQ9-S",
  "sf12_ment" = "SF12-MCS",
  "sf12_phys" = "SF12-PCS",
  "smwt_dist" = "6MWT-D",
  "stst_nr" = "STST-R",
  "sgrq_tot_score" = "SGRQ-TS",
  "tb_symp_score" = "TB-SS"
)
outcome_cont2 <- outcome_cont
names(outcome_cont2) <- gsub("_", "", names(outcome_cont))

outcome_bin <- c(
  "phq9_score_bin" = "PHQ9-S>10",
  "sf12_ment_bin" = "SF12-MCS<42",
  "sf12_phys_bin" = "SF12-PCS<50",
  "smwt_dist_bin" = "6MWT-D<400m",
  "stst_nr_bin" = "STST-R<20",
  "sgrq_tot_score_bin" = "SGRQ-TS>25",
  "tb_symp_score_bin" = "TB-SS>4"
)
outcome_bin2 <- outcome_bin
names(outcome_bin2) <- gsub("_", "", names(outcome_bin))

predictor <- c(
  "age" = "Age",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "Relapse case",
  "as_alc_calc" = "Alcohol score",
  "as_tobacco_calc" = "Tobacco score"
)
predictor_bin <- c(
  "age_bin" = "Age<30",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "Relapse case",
  "alc_bin" = "Drinker",
  "tobacco_bin" = "Smoker"
)

predictor_sub <- predictor[-c(4, 6)]
predictor_bin_sub <- predictor_bin[-c(4, 6)]

sites <- c("South Africa", "Malawi", "Mosambique", "Zambia", "Zimbabwe")

treat_effect_lab <- c("End vs Start treatment", "Post vs End treatment")
```

**Outcomes**:

The quality of life **(QoL)** outcomes:

* PHQ9-S: Patient Health Questionnaire 9 - Score (Range: 0-27)
* SF12-MCS: Short form survey (SF12) - Mental Component Score (Range: 0-100)
* SF12-PCS: Short form survey (SF12) - Physical Component Score (Range: 0-100)
* 6MWT-D: 6 Minute Walk Test - Distance
* STST-R: Sit-to-Stand Test - Number of Repetitions
* SGRQ-S: St. George's Respiratory Questionnaire - Total Score (Range: 0-100)
* TB-SS: TB - Symptom Score (Range: 0-9)

We define impaired QoL per outcome as:

1. PHQ9-S > 10
2. SF12-MCS < 42
3. SF12-PCS < 50
4. 6MWT-D < 400m
5. STST-R < 20
6. SGRQ-TS > 25
7. TB-SS > 4

**Exclusion:**

We exclude observations where we still wait for the next clinical visit.
That is, end of treatment or post treatment is still within 8mo since last visit.

**Missing observations**:

The outcomes can be missing for one of the following reasons:

1. *Death*: The patient died during or post treatment.
2. *Missing follow-up* (MFU): Missing QoL outcome because there was no follow-up visit.
3. *Unrecorded*: One or more QoL outcomes were not recorded.

**Patient characteristics**:

The predictors we consider are:

1. Age
2. Sex
3. HIV test result
4. Multi-drug resistant TB (MDR-TB)
5. Relapse instead of new TB case
6. ASSIST alcohol score
7. ASSIST tobacco score

**Additional variables::**

We further consider:

1. Any serious but non-fatal adverse event (AE) during treatment: 

* Life-threatining.
* Requires in-patient hospitalization or prolongation of existing hospitalization.
* Results in persistent or significant disability/incapacity.
* Results in congenital anomaly/birth defect.
* Other important medical event that may not be immediately life-threatening or result in death, or require hospitalisation, but may jeopardise the participant or may require intervention to prevent one of the other outcomes listed above.

2. Any mental health treatment (therapy or medication) since last visit:

* Mental health counselling, psychiatric medication, or hospital admission for mental illness.
* Treatment from a traditional healer for mental illness.
* Treatment from an outpatient health department (outpatient) for mental illness.
* Admission to a hospital or other health institution (inpatient) at least for one night for the treatment of mental illness
* Any medication for a mental illness.

3. TB treatment outcome:

* The outcome of the last TB treatment categorized into successful (cured) or unsuccessful (failed, death).

Almost all TB treatment failures are death, therefore we do not model TB treatment outcome further.

## Descriptives

### Study population

```{r sample}
print(
  sprintf(
    "Total: %i patients with %i observations.",
    n_distinct(qol$record_id), nrow(qol)
  )
)
```

**Figure:** Number of observations by time of TB treatment.

```{r observations}
qol %>%
  group_by(time) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = time, y = n)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), size = 8 / cm(1), vjust = -1) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.05))
  ) +
  labs(y = "No. of observations") +
  theme_custom() +
  theme(
    axis.title.x = element_blank()
  )
```

**Table**: Number and proportion of patients per site.

```{r sites}
qol_start %>%
  group_by(site) %>%
  summarize(`No. of sites` = n()) %>%
  ungroup() %>%
  mutate(Proportion = round(`No. of sites` / sum(`No. of sites`) * 100)) %>%
  knitr::kable(align = "lrr")
```

**Table**: Number and proportion of patients with missing follow-up (MFU) study visits.

```{r lost-to-follow-up}
qol %>%
  group_by(time) %>%
  summarize(
    `No. of MFU` = sum(mfu),
    `Proportion` = paste0(round(sum(mfu) / n() * 100), "%")
  ) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

**Table**: Number and proportion of patients who died.

```{r deaths}
qol %>%
  group_by(time) %>%
  summarize(
    `No. of deaths` = sum(death),
    `Proportion` = paste0(round(sum(death) / n() * 100), "%")
  ) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

**Table**: Patient characteristics at baseline.

```{r predictors}
qol_start %>%
  dplyr::select(all_of(names(predictor_sub))) %>%
  gather() %>%
  mutate(
    key = recode(key, !!!predictor_sub),
    key = factor(key, levels = predictor_sub)
  ) %>%
  group_by(key) %>%
  summarize_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  arrange(key) %>%
  set_names(c("Variable", "Summary")) %>%
  knitr::kable(align = "lr")
```

**Table**: Distribution of patient characteristics by time.

```{r}
qol %>%
  filter(!mfu, !death) %>%
  mutate(
    age_bin = ifelse(age < 30, 1, 0),
    alc_bin = ifelse(as_alc_calc > 0, 1, 0),
    tobacco_bin = ifelse(as_tobacco_calc > 0, 1, 0)
  ) %>%
  dplyr::select(all_of(c("time", names(predictor_bin)))) %>%
  melt("time") %>%
  mutate(variable = recode(variable, !!!predictor_bin)) %>%
  group_by(time, variable) %>%
  summarise_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = time, values_from = value) %>%
  rename(Variable = variable) %>%
  knitr::kable(align = "lrrr")
```

Note: 

- Only few MDR patients at end of anti-TB treatment and post treatment.
- Lower prevalence of alcohol and tobacco use at the end of treatment (but not post treatment) compared with baseline.

&nbsp;

**Table**: Number of patients with non-fatal serious adverse events (AE). 

```{r no-adverse-events}
qol %>%
  group_by(time) %>%
  summarize(
    n_tot = sum(nf_ae == 1, na.rm = TRUE),
    n_only = sum(nf_ae == 1 & !death & !mfu, na.rm = TRUE),
    n_died = sum(nf_ae == 1 & death, na.rm = TRUE),
    n_mfu = sum(nf_ae == 1 & mfu, na.rm = TRUE)
  ) %>%
  set_names(c("Time", "Total AE", "Only AE", "AE and death", "AE and MFU")) %>%
  knitr::kable(align = "lrrrr")
```

Note:

- Roughly half of patients with AE also died.
- Two patients with AE were MFU.

&nbsp;

**Table**: List of visits of patients with any AE.

```{r list-adverse-events}
qol %>%
  group_by(record_id) %>%
  filter(any(nf_ae == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, date_visit, nf_ae_date) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "Visit date", "AE date")) %>%
  knitr::kable(align = "llrr")
```

**Table**: Number and proportion of patients who received mental health treatments. 

```{r no-mental-health-treatment}
qol %>%
  group_by(time) %>%
  summarize(
    `No. of patients` = sum(ment_trt_yn == 1, na.rm = TRUE),
    `Proportion` = paste0(round(sum(ment_trt_yn == 1, na.rm = TRUE) / n() * 100), "%")
  ) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

Note:

- Very few patients received mental health treatment, most of them at the end of anti-TB treatment.
- Internal check revealted that treatment outcome was success for all patients who received mental health treatment.

&nbsp;

**Table**: List of visits of patients receiving mental health treatment.

```{r list-mental-health-treatment}
qol %>%
  group_by(record_id) %>%
  filter(any(ment_trt_yn == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, phq9_score, sf12_ment, death, mfu, ment_trt_yn) %>%
  mutate(
    death = ifelse(death, "Yes", "No"),
    mfu = ifelse(mfu, "Yes", "No"),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No")
  ) %>%
  mutate(sf12_ment = round(sf12_ment)) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "PHQ9-S", "SF12-MCS", "Death", "MFU", "Mental health treat.")) %>%
  knitr::kable(align = "llrrrr")
```

**Table**: TB Treatment outcomes.

```{r tb-treatment-outcomes}
qol %>%
  filter(time == "End") %>%
  mutate(
    `Treatment outcome` = ifelse(is.na(treat_success), "Not available",
      ifelse(treat_success == 1, "Success",
        ifelse(death, "Death", "Other failure")
      )
    ),
    `Treatment outcome` = factor(`Treatment outcome`,
      levels = c("Success", "Death", "Other failure", "Not available")
    )
  ) %>%
  group_by(`Treatment outcome`) %>%
  summarize(`No. of patients` = n()) %>%
  ungroup() %>%
  mutate(Proportion = round(`No. of patients` / sum(`No. of patients`) * 100)) %>%
  knitr::kable(align = "lrr")
```

Note:

- Almost all treatment failures are death, therefore TB treatment outcome is currently not considered in subsequent modeling analyses.


### Outcomes

#### Summary

**Table**: Descriptive summaries of continuous QoL outcomes.

```{r summaries-1}
# start of treatment
qol_start %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment start")) %>%
  knitr::kable(align = "lr")
```

```{r summaries-2}
# end of treatment
qol_end %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment end")) %>%
  knitr::kable(align = "lr")
```

```{r summaries-3}
# post treatment
qol_post %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) post treatment")) %>%
  knitr::kable(align = "lr")
```

#### Distribution

**Figure**: Boxplots of continuous QoL outcomes by time.

```{r qol-outcomes-boxplot-by-time, fig.height=6.3, fig.width=6.3}
qol_boxplot <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  mutate(
    outcome_cat = ifelse(
      outcome %in% c("PHQ9-S", "SF12-MCS"),
      "Mental health outcomes",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"),
        "Physical health outcomes", "TB symptoms scores"
      )
    ),
    outcome_cat = factor(outcome_cat, levels = c(
      "Mental health outcomes", "Physical health outcomes", "TB symptoms scores"
    ))
  ) %>%
  ggplot(aes(y = value, x = time, fill = time)) +
  facet_wrap(~outcome, scales = "free_y", ncol = 3) +
  geom_boxplot() +
  labs(y = "Score value") +
  scale_fill_brewer(palette = "Set2") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank()
  )

save_plot(
  qol_boxplot,
  pdf_file = "results/outcome-boxplot.png",
  w = 16, h = 16
)
```

**Figure**: Histograms of continuous QoL outcomes by time.

```{r histogram-by-time, fig.width=6.3, fig.height=8.7}
qol_denesity <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value, group = time)) +
  ggh4x::facet_grid2(outcome ~ time, scales = "free", independent = "x") +
  geom_histogram(aes(y = ..density..)) +
  coord_cartesian(expand = FALSE) +
  labs(y = "Density") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

save_plot(
  qol_denesity,
  pdf_file = "results/outcome-density-distribution.png",
  w = 16, h = 22
)
```

**Figure**: Pairwise correlations between QoL outcomes. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r pairwise-correlation, fig.width=7, fig.height=7}
# correlations
cor <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")

# p-values
cor_pval <- function(df) {
  p_value_matrix <- matrix(NA, ncol(df), ncol(df))
  rownames(p_value_matrix) <- colnames(df)
  colnames(p_value_matrix) <- colnames(df)
  for (i in seq_along(df)) {
    for (j in seq_along(df)) {
      tmp <- cor.test(df[[i]], df[[j]])
      p_value_matrix[i, j] <- tmp$p.value
    }
  }
  return(p_value_matrix)
}
cor_p <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()

# Melt the correlation matrix into a long format
cor_melt <- rbind(
  melt(cor) %>% mutate(time = "Overall"),
  melt(cor_start) %>% mutate(time = "Start"),
  melt(cor_end) %>% mutate(time = "End"),
  melt(cor_post) %>% mutate(time = "Post")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c("Overall", "Start", "End", "Post"))
  )

cor_p_melt <- rbind(
  melt(cor_p) %>% mutate(time = "Overall"),
  melt(cor_p_start) %>% mutate(time = "Start"),
  melt(cor_p_end) %>% mutate(time = "End"),
  melt(cor_p_post) %>% mutate(time = "Post")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c("Overall", "Start", "End", "Post"))
  )

cor_rp_melt <- left_join(
  cor_melt,
  cor_p_melt,
  by = c("Var1", "Var2", "time")
) %>%
  rename(value = value.x, p = value.y) %>%
  mutate(
    p_star = ifelse(p < .001, "***",
      ifelse(p < .01, "**",
        ifelse(p < .05, "*", "")
      )
    ),
    lab = paste0(round(value, 2), p_star),
    # lab = ifelse(Var1 == Var2, "", lab),
    across(c(value, lab), ~ ifelse(as.integer(Var1) <= as.integer(Var2), NA, .x))
  )

cor_ov_pl <- ggplot(
  data = filter(cor_rp_melt, time == "Overall"),
  aes(x = Var1, y = Var2, fill = value)
) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Pearson Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_ov_pl,
  pdf_file = "results/outcome-overall-correlation.png",
  w = 12, h = 12
)
```

**Figure**: Pairwise correlations between QoL outcomes by time. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r correlation-overall, fig.width=10, fig.height=10}
# Create the heatmap
cor_pl <- ggplot(data = cor_rp_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  facet_wrap(~time) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Pearson Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_pl,
  pdf_file = "results/outcome-correlation.png",
  w = 12, h = 12
)
```

**Figure:** Proportion of patients with impaired QoL.

```{r proportions, fig.width=6.3, fig.height=3.9}
var_names <- c(
  "Y" = "Yes (impaired QoL)",
  "N" = "No (QoL not impaired)",
  "D" = "Death before visit",
  "L" = "Missing follow-up",
  "U" = "Unrecorded"
)

var_colors <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1]
)

qol_bin_comp <- qol %>%
  dplyr::select(all_of(c("time", "mfu", "death", names(outcome_bin)))) %>%
  melt(c("time", "mfu", "death")) %>%
  group_by(time, variable) %>%
  summarize(
    Y = sum(value, na.rm = TRUE),
    N = sum(value == 0, na.rm = TRUE),
    D = sum(death),
    U = sum(is.na(value) & !mfu & !death, na.rm = TRUE),
    L = sum(mfu, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  rename(outcome = variable) %>%
  melt(c("time", "outcome")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin),
    variable = recode(variable, !!!var_names),
    variable = factor(variable, levels = var_names)
  ) %>%
  group_by(time, outcome) %>%
  mutate(p = value / sum(value) * 100) %>%
  ungroup()

qol_bin_comp_pl <- ggplot(data = qol_bin_comp, mapping = aes(x = time, y = p)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack(reverse = TRUE)
  ) +
  geom_text(
    data = filter(qol_bin_comp, variable == "Yes (impaired QoL)"),
    mapping = aes(group = time, label = paste0(round(p))),
    vjust = -.5, size = 6 / cm(1),
    color = var_colors[1],
    show.legend = FALSE
  ) +
  scale_fill_manual(
    values = var_colors,
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment",
    fill = "a"
  ) +
  theme_custom() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.key.width = unit(.2, "cm"),
    legend.key.height = unit(.4, "cm")
  )

save_plot(
  qol_bin_comp_pl,
  pdf_file = "results/impaired-qol.png",
  w = 16, h = 10
)
```

#### Patient trajectories for depression

**Figure**: Trajectories of patients who were depressed (defined as PHQ9-S > 10) once during the study.

```{r depressed-flow, fig.width=6.3, fig.height=3.9}
var_names_dprs <- c(
  "Y" = "Depressed",
  "N" = "Not depressed",
  "D" = "Death before visit",
  "L" = "Missing follow-up",
  "U" = "Unrecorded"
)

var_colors_dprs <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1]
)

# create links
links_dprs <- qol %>%
  dplyr::select(
    time,
    record_id,
    ment_trt_yn,
    death,
    mfu,
    phq9_score_bin
  ) %>%
  rename(value = phq9_score_bin) %>%
  mutate(
    value =
      ifelse(death == 1 & is.na(value) & time != "Start", var_names_dprs["D"],
        ifelse(mfu, var_names_dprs["L"],
          ifelse(is.na(value), var_names_dprs["U"],
            ifelse(value == 1, var_names_dprs["Y"], var_names_dprs["N"])
          )
        )
      ),
    value = factor(value, levels = var_names_dprs),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No"),
    ment_trt_yn = factor(ment_trt_yn, levels = c("No", "Yes"))
  ) %>%
  # filter patients that were depressed at least once
  group_by(record_id) %>%
  filter(any(value == var_names_dprs["Y"])) %>%
  ungroup() %>%
  group_by(time, value) %>%
  mutate(freq = n()) %>%
  ungroup()

flow_dprs_pl <- links_dprs %>%
  ggplot(aes(
    x = time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = freq
  )) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(stat = "stratum", size = 8 / cm(1)) +
  scale_fill_manual(values = var_colors_dprs) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
  scale_x_discrete(labels = c("Start", "End", "Post")) +
  labs(x = "Treatment") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.title.y = element_blank()
  )

save_plot(
  flow_dprs_pl,
  pdf_file = "results/sankey-depressed.png",
  w = 16, h = 10
)
```


## Imputation

We impute the missing values in the continuous QoL outcomes.
Outcomes missing because of death or missing follow-up visit will not be imputed, only unrecorded ones.
However, we consider subsequent death or missing follow-up visit as a predictor during imputation.
Similarly, we consider any adverse adverse event at the start of, end of, or post treatment as a predictor during imputation.
Finally, we repeat the main analysis with a fully imputed dataset including those with missing follow-up.

**Figure**: Imputation check for a random sample of 30 patients, showing the imputed majority label across datasets.

```{r imputation, fig.height=12}
# wide format
qol_fu <- qol %>%
  group_by(record_id) %>%
  arrange(time) %>%
  mutate(
    mfu_lead = lead(mfu),
    death_lead = lead(death)
  ) %>%
  ungroup() %>%
  mutate(
    across(c(mfu_lead, death_lead), ~ ifelse(is.na(.x), 0, .x))
  ) %>%
  filter(!mfu & !death) %>%
  ungroup() %>%
  arrange(record_id, time) %>%
  mutate(
    across(
      c(
        mfu_lead, death_lead, nf_ae, ment_trt_yn,
        sex, hiv, mdr, cavity, tbd_pat_cat
      ),
      ~ factor(ifelse(.x == 1, "Yes", "No"), levels = c("No", "Yes"))
    )
  ) %>%
  dplyr::select(all_of(c(
    "record_id",
    "time",
    "site",
    "mfu_lead",
    "death_lead",
    "nf_ae",
    "ment_trt_yn",
    names(outcome_cont),
    names(predictor)
  )))

# imputation
n_datasets <- 20
qol_fu_imp <- mice(
  qol_fu[, -1],
  m = n_datasets,
  maxit = 10,
  seed = 12345,
  print = FALSE
)

# plot(qol_fu_imp, layout = c(2, 16))

# data
qol_fu_imp <- complete(qol_fu_imp, "long") %>%
  mutate(record_id = rep(qol_fu$record_id, times = n_datasets))

qol_fu_imp_mode <- qol_fu_imp %>%
  dplyr::select(all_of(c(".imp", "record_id", "time", names(outcome_cont)))) %>%
  melt(c(".imp", "record_id", "time")) %>%
  group_by(record_id, time, variable) %>%
  summarize(
    value = mean(value)
  ) %>%
  rename(imputed = value) %>%
  left_join(
    qol_fu %>%
      dplyr::select(all_of(c("record_id", "time", names(outcome_cont)))) %>%
      melt(c("record_id", "time")) %>%
      rename(observed = value),
    by = c("record_id", "time", "variable")
  ) %>%
  mutate(is_observed = ifelse(is.na(observed), FALSE, TRUE)) %>%
  rename(outcome = variable)

check_imp_pl <- qol_fu_imp_mode %>%
  group_by(record_id) %>%
  filter(any(!is_observed)) %>%
  ungroup() %>%
  filter(record_id %in% sample(unique(record_id), 30)) %>%
  ggplot(aes(
    y = time,
    x = outcome,
    color = is_observed,
    label = round(imputed)
  )) +
  geom_text(size = 8 / cm(1)) +
  facet_wrap(~record_id, ncol = 3) +
  labs(color = "Is observed") +
  scale_x_discrete(labels = function(x) outcome_cont) +
  scale_y_discrete(labels = function(x) c("Start", "End", "Post")) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

save_plot(
  check_imp_pl,
  pdf_file = "results/imputation-check.png",
  w = 16, h = 30
)
```


## Modeling

We model z-scores to make the results across outcomes more comparable.
We invert PHQ9 and TB symptom scores using (max_y - y) so that all changes>0 imply an QoL improvement. 
We report the median and 95% credible interval (CrI) of the posterior draws for each model parameter.

```{r model}
# prepare data
qol_fu_imp_prep <- qol_fu_imp %>%
  mutate(
    alc_bin = ifelse(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = ifelse(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = ifelse(age < 30, "Yes", "No"),
    across(
      c(age_bin, alc_bin, tobacco_bin),
      ~ factor(.x, levels = c("No", "Yes"))
    ),
    site = factor(site, levels = sites)
  ) %>%
  mutate(
    phq9_score = 27 - phq9_score,
    sgrq_tot_score = 100 - sgrq_tot_score,
    tb_symp_score = 9 - tb_symp_score
  ) %>%
  group_by(.imp) %>%
  mutate(
    across(matches(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))
  ) %>%
  ungroup()

# model
mod_qol <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score, tb_symp_score
    )
    ~ site + mfu_lead + death_lead + nf_ae + ment_trt_yn +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = qol_fu_imp_prep %>% split(.$.imp),
  chains = 4,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/gaussian-regression-qol-time"
)

# posterior samples
mod_qol_smpls <- mod_qol %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration"))
```

### QoL changes over time

**Figure**: Estimated change in QoL outcomes between end vs start and post vs end of anti-TB treatment.

```{r modeled-qol-changes, fig.width=6.3, fig.height=4.7}
# posterior samples subset
time_smpls <- mod_qol_smpls %>%
  filter(!grepl(":", variable)) %>%
  filter(grepl("time", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    time = ifelse(grepl("End", variable), "End", "Post")
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = time, values_from = value) %>%
  mutate(
    Post = Post - End
  ) %>%
  ungroup() %>%
  pivot_longer(cols = c(End, Post)) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    name = recode(name, End = "End vs Start", Post = "Post vs End"),
    name = factor(name, levels = c("End vs Start", "Post vs End"))
  )

# plot
treat_effect_pl <- time_smpls %>%
  mutate(pos = ifelse(value > 0, "Y", "N")) %>%
  ggplot(aes(x = value, y = outcome)) +
  facet_wrap(~name) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye(
    aes(fill = after_stat(x < 0)),
    .width = 0.95,
    point_size = 1,
    linewidth = .5,
    position = position_identity()
  ) +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  labs(x = "Estimated change in z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_pl,
  pdf_file = "results/qol-changes.png",
  w = 16, h = 12
)
```

Interpretation:

- All QoL outcomes improved from the start to the end of anti-TB treatment.
- The improvement at the end of treatment was smaller for 6MWT and STSTR. 
- Some outcomes tended to improve further post treatment.


### Sensitivity check for death and MFU patients

As a sensitivity check, we estimate for each outcome the change in QoL that would be needed 
in patients who died or with missing follow-up visits
in order to offset the estimated QoL changes in patients with follow-up visits.
We compute this as *-beta x (n_fu / n_nfu)* for each outcome,
where n_fu is the number of patients *with* and n_nfu is the number of patients *without* follow-up or death.

**Figure:** Estimated change in QoL (grey) for patients with follow-up visits vs offsetting hypothetical change (red) in QoL for patients without missing follow-up visit or death.

```{r sensitivity-check}
n_end <- n_distinct(qol$record_id[qol$time == "End"])
n_end_mfu <- sum(qol$mfu[qol$time == "End"])
n_end_death <- sum(qol$death[qol$time == "End"])
n_end_fu <- n_end - n_end_mfu - n_end_death
scale_fct <- 1

null_treat_effect_pl <- time_smpls %>%
  filter(name == "End vs Start") %>%
  mutate(
    n_nfu = n_end_mfu + n_end_death,
    n_fu = n_end_fu,
    value_zero = -(n_fu / n_nfu) * value
  ) %>%
  dplyr::select(outcome, value_zero, value) %>%
  melt("outcome") %>%
  mutate(
    group = ifelse(variable == "value",
      "Follow-up patients (estimated)",
      "Missing follow-up/death (hypothetical)"
    ),
    group = factor(group, levels = c(
      "Follow-up patients (estimated)",
      "Missing follow-up/death (hypothetical)"
    ))
  ) %>%
  ggplot(aes(x = value, y = outcome, fill = group)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye() +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  labs(x = "Estimated difference in z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  null_treat_effect_pl,
  pdf_file = "results/sensitivity-check-mfu-hypothetical-effect.png",
  w = 16, h = 14
)
```

Interpretation:

- QoL decrease for patients without follow-up would need to be extremely large to offset improvements in patients with follow-up visits.
- We could assume that is unlikely that patients without would have such diametrically different changes in QoL than patients with follow-up.

### Sensitivity check with fully imputed dataset 

As another sensitivity check, we estimate QoL changes using a fully imputed dataset, including patients with missing follow-up or death.

**Figure**: Estimated change in QoL outcomes for fully-imputed dataset including patients with missing follow-up visits or death.

```{r sensitivity-full-imputation}
# imputation
qol_full <- qol %>%
  group_by(record_id) %>%
  arrange(time) %>%
  mutate(
    mfu_lead = lead(mfu),
    death_lead = lead(death)
  ) %>%
  ungroup() %>%
  mutate(
    across(c(mfu_lead, death_lead), ~ ifelse(is.na(.x), 0, .x))
  ) %>%
  ungroup() %>%
  arrange(record_id, time) %>%
  mutate(
    across(
      c(
        mfu_lead, death_lead, nf_ae, ment_trt_yn,
        sex, hiv, mdr, cavity, tbd_pat_cat
      ),
      ~ factor(ifelse(.x == 1, "Yes", "No"), levels = c("No", "Yes"))
    )
  ) %>%
  dplyr::select(all_of(c(
    "record_id",
    "time",
    "site",
    "mfu_lead",
    "death_lead",
    "nf_ae",
    "ment_trt_yn",
    names(outcome_cont),
    names(predictor)
  )))

qol_full_imp <- mice(
  qol_full[, -1],
  m = n_datasets,
  maxit = 10,
  seed = 12345,
  print = FALSE
)

qol_full_imp <- complete(qol_full_imp, "long") %>%
  mutate(record_id = rep(qol_full_imp$record_id, times = n_datasets)) %>%
  mutate(
    alc_bin = ifelse(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = ifelse(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = ifelse(age < 30, "Yes", "No"),
    across(
      c(age_bin, alc_bin, tobacco_bin),
      ~ factor(.x, levels = c("No", "Yes"))
    ),
    site = factor(site, levels = sites)
  ) %>%
  mutate(
    phq9_score = 27 - phq9_score,
    sgrq_tot_score = 100 - sgrq_tot_score,
    tb_symp_score = 9 - tb_symp_score
  ) %>%
  group_by(.imp) %>%
  mutate(across(matches(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))) %>%
  ungroup()

mod_qol_full <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score, tb_symp_score
    )
    ~ site + mfu_lead + death_lead + nf_ae + ment_trt_yn +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = qol_full_imp %>% split(.$.imp),
  chains = 1,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/sensitivity-gaussian-regression-qol-time-fully-imputed"
)

# posterior samples
time_full_smpls <- mod_qol_full %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration")) %>%
  filter(!grepl(":", variable)) %>%
  filter(grepl("time", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    time = ifelse(grepl("End", variable), "End", "Post")
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = time, values_from = value) %>%
  mutate(
    Post = Post - End
  ) %>%
  ungroup() %>%
  pivot_longer(cols = c(End, Post)) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    name = recode(name, End = "End vs Start", Post = "Post vs End"),
    name = factor(name, levels = c("End vs Start", "Post vs End"))
  )

# plot
treat_effect_full_pl <- time_full_smpls %>%
  mutate(pos = ifelse(value > 0, "Y", "N")) %>%
  ggplot(aes(x = value, y = outcome)) +
  facet_wrap(~name) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye(
    aes(fill = after_stat(x < 0)),
    .width = 0.95,
    point_size = 1,
    linewidth = .5,
    position = position_identity()
  ) +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  labs(x = "Estimated difference in z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_full_pl,
  pdf_file = "results/sensitivity-qol-changes-full.png",
  w = 16, h = 8
)
```

Interpretation:

- Changes are similar with a stronger tendency for further improvements post treatment.


### Association with patient characteristics

We define significant associations as those with a 95%-CrI not overlapping zero.
Since we report many associations, there is a risk of false positives and significant ones have to be interpreted with caution.

The following predictors were transformed:

- Age: dichotomized into age < 30 and age >= 30.
- Drinker and Smoker: dichotomized into any alcohol or tobacco use denoted as an ASSIST score greater than zero.

We include time interaction effects for all predictors to estimate the association with baseline, end of treatment, and post treatment QoL. 

The following variables are also included:

- Subsequent MFU: To check whether missing follow-up is associated with QoL.
- Subsequent death: To check whether subsequent death is associated with QoL.
- Mental health treatment: To check whether received mental health treatment is associated with QoL.
- Serious adverse events: To check whether experiencing any non-fatal serious adverse events is associated with QoL.

**Figure**: Estimated change in QoL outcomes for each patient characteristic. 

```{r association-by-outcome, fig.height=12, fig.width=10}
# associations of binary predictors
assoc_smpls <- mod_qol_smpls %>%
  filter(grepl(paste0(names(predictor_bin), collapse = "|"), variable)) %>%
  mutate(
    time = ifelse(
      grepl("End", variable), "End",
      ifelse(grepl("Post", variable), "Post",
        "Start"
      )
    ),
    predictor = stringi::stri_extract(
      variable,
      regex = paste0(names(predictor_bin), collapse = "|")
    ),
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    )
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(
    names_from = time, values_from = value
  ) %>%
  mutate(
    End = Start + End,
    Post = Start + Post
  ) %>%
  pivot_longer(cols = c(Start, End, Post)) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    name = factor(name, levels = c("Start", "End", "Post")),
    predictor = recode(predictor, !!!predictor_bin),
    predictor = factor(predictor, levels = predictor_bin_sub)
  )

require(scales)
sqrt_sign <- function(x) sign(x) * sqrt(abs(x))
sqrt_sign_inv <- function(x) sign(x) * x^2
sqrt_sign_trans <- function() trans_new("sqrt_sign", sqrt_sign, sqrt_sign_inv)

assoc_pl <- assoc_smpls %>%
  ggplot(aes(x = value, y = outcome, color = name)) +
  facet_wrap(~predictor, ncol = 3) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_pointinterval(
    .width = .95,
    position = position_dodge(width = .5),
    point_size = 1,
    linewidth = .5
  ) +
  labs(x = "Estimated change in z-score") +
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(trans = "sqrt_sign") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  assoc_pl,
  pdf_file = "results/association.png",
  w = 16, h = 21
)
```

Interpretation: 

- The plot shows the estimated change in the z-score for each outcome and binary predictor per time point.
- For example, female sex was associated with a decrease of roughly 0.25 standard deviation in the STST-R at all time points.
- We subsequently summarise how each predictor is associated with QoL outcomes overall and by category. 

&nbsp;

**Figure** Probability for a positive (right) or negative (left) association with QoL by category.

```{r assoc-prob-overall, fig.height=6.3, fig.width=6.3}
assoc_overall_pl <- assoc_smpls %>%
  group_by(name, predictor) %>%
  summarise(
    p_n = 100 * mean(value < 0),
    p_p = 100 * mean(value > 0)
  ) %>%
  ungroup() %>%
  ggplot(aes(y = fct_rev(predictor), linetype = fct_rev(name))) +
  geom_vline(aes(xintercept = 0), color = "grey") +
  geom_segment(
    aes(x = -p_n, xend = p_p),
    position = position_dodge(width = .5)
  ) +
  geom_point(
    aes(x = p_p, color = "positive"),
    position = position_dodge(width = .5)
  ) +
  geom_point(
    aes(x = -p_n, color = "negative"),
    position = position_dodge(width = .5)
  ) +
  geom_text(
    aes(x = p_p, color = "positive", label = round(p_p)),
    position = position_dodge(width = .5),
    hjust = -1, size = 8 / cm(1), show.legend = FALSE
  ) +
  geom_text(
    aes(x = -p_n, color = "negative", label = round(p_n)),
    position = position_dodge(width = .5),
    hjust = 2, size = 8 / cm(1), show.legend = FALSE
  ) +
  labs(x = "Probability (%) for a negative/positive assocation with QoL score") +
  scale_color_manual(
    values = c(
      "positive" = "skyblue",
      "negative" = "rosybrown2"
    )
  ) +
  scale_x_continuous(
    labels = function(x) abs(x),
    limits = c(-100, 100),
    expand = expansion(add = c(10, 10))
  ) +
  scale_linetype_manual(values = rev(c("solid", "dashed", "dotted"))) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  ) +
  guides(
    linetype = guide_legend(reverse = TRUE, order = 2)
  )

save_plot(
  assoc_overall_pl,
  pdf_file = "results/association-prob-overall.png",
  w = 16, h = 16
)
```

Interpretation:

- Female sex, relapse TB cases, and female sex were more likely associated with overall QoL decrease.  

&nbsp;

**Figure:** Probability for a positive (right) or negative (left) association with QoL by category.

```{r assoc-prob-category, fig.height=6.3, fig.width=6.3}
assoc_cat_pl <- assoc_smpls %>%
  mutate(
    category = ifelse(outcome %in% c("PHQ9-S", "SF12-MCS"),
      "Mental health scores", ifelse(outcome %in% c("SGRQ-TS", "TB-SS"),
        "TB symptom scores", "Physicial health scores"
      )
    ),
    category = factor(category, levels = c(
      "Mental health scores", "Physicial health scores", "TB symptom scores"
    ))
  ) %>%
  group_by(category, name, predictor) %>%
  summarise(
    p_n = 100 * mean(value < 0),
    p_p = 100 * mean(value > 0)
  ) %>%
  ungroup() %>%
  ggplot(aes(y = fct_rev(predictor), linetype = fct_rev(name))) +
  facet_wrap(~category) +
  geom_vline(aes(xintercept = 0), color = "grey") +
  geom_segment(
    aes(x = -p_n, xend = p_p),
    position = position_dodge(width = .5)
  ) +
  geom_point(
    aes(x = p_p, color = "positive"),
    position = position_dodge(width = .5)
  ) +
  geom_point(
    aes(x = -p_n, color = "negative"),
    position = position_dodge(width = .5)
  ) +
  geom_text(
    aes(x = p_p, color = "positive", label = round(p_p)),
    position = position_dodge(width = .5),
    hjust = -1, size = 6 / cm(1), show.legend = FALSE
  ) +
  geom_text(
    aes(x = -p_n, color = "negative", label = round(p_n)),
    position = position_dodge(width = .5),
    hjust = 2, size = 6 / cm(1), show.legend = FALSE
  ) +
  labs(x = "Probability (%) for a negative/positive assocation with QoL score") +
  scale_color_manual(
    values = c(
      "increased" = "skyblue",
      "decreased" = "rosybrown2"
    )
  ) +
  scale_x_continuous(
    labels = function(x) abs(x),
    limits = c(-100, 100),
    breaks = seq(-100, 100, 50),
    expand = expansion(add = c(60, 60))
  ) +
  scale_linetype_manual(values = rev(c("solid", "dashed", "dotted"))) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.spacing = unit(0.1, "cm")
  ) +
  guides(
    linetype = guide_legend(reverse = TRUE, order = 2)
  )

save_plot(
  assoc_cat_pl,
  pdf_file = "results/association-prob-by-category.png",
  w = 16, h = 16
)
```

Interpretation:

- Some variables show varying effects by type of QoL outcome.
- Age<30 was more likely associated with physical health and TB symptom score increases.
- Relapse TB cases was more likely associated with mental health and TB symptom score decreases.

&nbsp;

**Table**: Estimated association of subsequent death with QoL.

```{r assoc-subsequent-death}
mod_qol_smpls %>%
  filter(grepl("death", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent death was associated with worse QoL outcomes.

&nbsp;

**Table**: Estimated association of subsequent missing follow-up with QoL.

```{r assoc-subsequent-mfu}
mod_qol_smpls %>%
  filter(grepl("mfu", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent missing follow-up was *not* associated with QoL outcomes.


**Table**: Estimated association of non-fatal adverse events with QoL.

```{r assoc-adverse-events}
mod_qol_smpls %>%
  filter(grepl("nf_ae", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Any non-fatal adverse events was *not* associated with QoL outcomes.

&nbsp;

**Table**: Estimated association of meantal health treatment with QoL.

```{r assoc-mental-health-treatment}
mod_qol_smpls %>%
  filter(grepl("ment", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Mental health treatment was *not* associated with QoL outcomes.


### QoL impairement over time

**Figure**: Estimated proportion of patients with impaired QoL. Pr = Bayesian probability that the proportions are smaller at the end vs start of and end of vs post treatment.

```{r model-qol-impairment, results = 'hide'}
# prepare data
qol_imp_bin <- qol_fu_imp %>%
  dplyr::select(
    .imp,
    record_id,
    time,
    names(outcome_cont)
  ) %>%
  mutate(
    phq9_score_bin = ifelse(phq9_score > 10, 1, 0),
    phq9_score_bin_alt = ifelse(phq9_score > 7, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    tb_symp_score_bin = ifelse(tb_symp_score > 4, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0)
  ) %>%
  group_by(.imp, time) %>%
  summarize(
    across(c(names(outcome_bin), "phq9_score_bin_alt"), sum),
    N = n()
  ) %>%
  melt(c(".imp", "time", "N")) %>%
  ungroup() %>%
  rename(n = value) %>%
  mutate(
    end = ifelse(time %in% c("End", "Post"), 1, 0),
    post = ifelse(time == "Post", 1, 0)
  ) %>%
  dplyr::select(-time) %>%
  nest(data = -.imp)

# run models
qol_bin_smpls <- tibble(
  outcome = c(),
  end_v_start = c(),
  post_v_end = c(),
)
for (out in c(names(outcome_bin), "phq9_score_bin_alt")) {
  mod_out <- brm_multiple(
    formula = bf(
      n | trials(N) ~ end + post,
      family = binomial
    ),
    data = lapply(qol_imp_bin$data, function(x) filter(x, variable == out)),
    iter = 1000,
    chains = 1,
    cores = 1,
    seed = 12345,
    file = paste0("fitted-models/", out, ".rds")
  )
  qol_bin_smpls_out <- tibble(
    outcome = out,
    end_v_start = unlist(posterior_samples(mod_out, "b_end")),
    post_v_end = unlist(posterior_samples(mod_out, "b_post"))
  )
  qol_bin_smpls <- rbind(qol_bin_smpls, qol_bin_smpls_out)
}
```

```{r qol-impairment-over-time, fig.width=7.9, fig.height=4}
# Bayesian posterior probability
qol_bin_pp <- qol_bin_smpls %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin)
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr" = value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
qol_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin)
  ) %>%
  arrange(outcome, time)

pval_ypos_end <- qol_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post <- qol_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos <- rbind(
  pval_ypos_end %>% mutate(time = "End"),
  pval_ypos_post %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_comp <- qol_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = qol_bin_pp,
    y_position = pval_ypos,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6, 6.75, 7),
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25, 7, 7.25),
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_comp,
  pdf_file = "results/qol-impairment-prevalence-by-time.pdf",
  w = 20, h = 10
)
```

Intepretation:

- Prevalence of impaired QoL decreased from the start to the end of treatment for all outcomes.
- Prevalene decreased further post treatment for physical scores and TB symptom scores.
- Mental scores (PHQ9-S and SF12-MCS) did not decrease further, but there was only little potential for improvement because they were already low at the end of treatment. 

&nbsp;

**Figure**: Estimated proportion (in %) of patients with depression for different cutoff values. Pr = Bayesian probability that the proportions are smaller at the end of and post treatment vs the start and end of treatment, respectively.

```{r sensitivity-phq9-cutoff, fig.height=4, fig.width=4}
# Bayesian posterior probability
phq9_bin_pp <- qol_bin_smpls %>%
  filter(grepl("phq9", outcome)) %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = ifelse(grepl("alt", outcome), "PHQ9-S>7", "PHQ9-10>10"),
    outcome = factor(outcome, levels = c("PHQ9-S>7", "PHQ9>10"))
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr" = value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
phq9_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(grepl("phq9", outcome)) %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = ifelse(grepl("alt", outcome), "PHQ9-S>7", "PHQ9>10")
  ) %>%
  arrange(outcome, time)

pval_ypos_end_phq9 <- phq9_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post_phq9 <- phq9_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_phq9 <- rbind(
  pval_ypos_end_phq9 %>% mutate(time = "End"),
  pval_ypos_post_phq9 %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_phq9_comp <- phq9_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = phq9_bin_pp,
    y_position = pval_ypos_phq9,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6, 6.75, 7)[1:4],
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25, 7, 7.25)[1:4],
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)", x = "Pericardial changes") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_phq9_comp,
  pdf_file = "results/sensitivity-depression-prevalence-by-time.png",
  w = 10, h = 10
)
```

Interpretation:

- Extremely similar results for PHQ9 cutoff of 7 or 10.
- No further analysis thus conducted.


### Quantile regression

We are primarily interested in patients whose QoL did not improve through anti-TB treatment. 
To investigate, we estimate the association of patient characteristics with different quantiles 
of the QoL score distribution at the end of anti-TB treatment using quantile regression.
We adjust for the baseline QoL score, non-fatal serious adverse events and mental health treatment.


**Figure**: Estimated change in z-score (median as dot, 95%-CrI as lines) per quantile of the QoL score at treatment end.

```{r quantile-regression, fig.width=7.9, fig.height=7.9}
qol_fu_change <- qol_fu_imp_prep %>%
  filter(time != "Post") %>%
  group_by(.imp, record_id) %>%
  filter(n() == 2) %>%
  ungroup()

qr_post_draws <- tibble(
  outcome = character(),
  predictor = character(),
  quantile = numeric(),
  .chain = numeric(),
  .iteration = numeric(),
  .draw = numeric(),
  value = numeric()
)

for (out in names(outcome_cont)) {
  qol_fu_change_out <- left_join(
    qol_fu_change %>%
      filter(time == "End") %>%
      dplyr::select(all_of(c(
        ".imp", "record_id", out,
        "nf_ae", "ment_trt_yn"
      ))) %>%
      rename(End = !!sym(out)),
    qol_fu_change %>%
      filter(time == "Start") %>%
      dplyr::select(all_of(c(
        ".imp", "record_id", "site", out, names(predictor_bin_sub)
      ))) %>%
      rename(Start = !!sym(out)),
    by = c(".imp", "record_id")
  ) %>%
    dplyr::select(-record_id) %>%
    split(.$.imp)

  for (q in c(0.1, 0.25, 0.5, 0.75, 0.9)) {
    qr_tc <- brm_multiple(
      bf(End ~ Start + site +
        nf_ae + ment_trt_yn +
        age_bin + sex + hiv + mdr + tbd_pat_cat +
        alc_bin + tobacco_bin, quantile = q),
      data = qol_fu_change_out,
      family = asym_laplace(),
      prior = c(
        set_prior("normal(0, 1)", class = "sigma"),
        set_prior("student_t(3, 0, 2.5)", class = "b")
      ),
      chains = 4,
      iter = 1000,
      cores = 4,
      seed = 12345,
      open_progress = FALSE,
      recompile = FALSE,
      file = paste("fitted-models/quantile-regression", out, 100 * q, sep = "-")
    )

    post_draws <- qr_tc %>%
      spread_draws(`b_.*`, regex = TRUE) %>%
      melt(c(".chain", ".draw", ".iteration")) %>%
      mutate(
        variable = gsub("b_", "", variable),
        variable = gsub("Yes", "", variable),
        outcome = out,
        quantile = q
      ) %>%
      filter(variable %in% names(predictor_bin_sub)) %>%
      rename(predictor = variable) %>%
      dplyr::select(
        outcome, predictor, quantile,
        .chain, .iteration, .draw, value
      )

    qr_post_draws <- rbind(qr_post_draws, post_draws)
  }
}

qr_post_sum <- qr_post_draws %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont),
    predictor = recode(predictor, !!!predictor_bin_sub),
    predictor = factor(predictor, levels = predictor_bin_sub)
  ) %>%
  group_by(outcome, predictor, quantile) %>%
  summarise(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  ungroup()

qr_assoc_pl <- qr_post_sum %>%
  ggplot(aes(x = quantile)) +
  facet_grid(outcome ~ predictor) +
  geom_point(aes(y = median)) +
  geom_segment(aes(y = lower, yend = upper)) +
  scale_y_continuous(trans = "sqrt_sign") +
  scale_x_continuous(
    labels = function(x) x * 100,
    breaks = c(0.1, 0.25, 0.5, 0.75, 0.9)
  ) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "grey") +
  labs(x = "Quantile", y = "Estimated change in z score") +
  theme_custom() +
  theme(
    panel.spacing = unit(0.5, "cm")
  )


save_plot(
  qr_assoc_pl,
  pdf_file = "results/quantile-regression-association.png",
  w = 20, h = 20
)
```

Interpretation:

- We focus on associations that vary between quantiles.
- Low PHQ9-S (Q10 and Q25) at treatment end is associated with female sex, HIV+, and relapse TB cases.
- Low mental health and TB symptom scores are associated with relapse TB cases.