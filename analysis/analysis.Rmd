---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "..")
```

```{r libraries, include=FALSE}
library(tidyverse)
library(reshape2)
library(rstanarm)
library(brms)
library(rstan)
library(tidybayes)
library(mice)
library(klaR)
library(knitr)
library(stringr)
source("utils/plotting.R")
source("utils/summaries.r")
```


## Data

We analyze the quality of life (QoL) outcomes of tuberculosis (TB) patients 
at the start of (baseline / diagnosis), end of (typically six months after baseline), and six months post anti-TB treatment in IeDEA-SA cohorts:
South Africa, Malawi, Mozambique, Zambia, and Zimbabwe.
The  data is as of January 30, 2025.

```{r data, include=FALSE}
# data of patients with at least one outcome
qol <- readRDS("../tb_care/data-clean/clean-cohort-data.rds") %>%
  mutate(time = factor(time, levels = c("Start", "End", "Post"))) %>%
  arrange(time, record_id) %>%
  rename(
    phq9_score = qol_phq9,
    sf12_ment = qol_sf12_ment,
    sf12_phys = qol_sf12_phys,
    sgrq_tot_score = qol_sgrq,
    smwt_dist = qol_smwt,
    stst_nr = qol_stst,
    age = dem_age,
    sex = dem_sex,
    hiv = hiv_test_result,
    highbact = mb_highbact,
    mdr = mb_mdr,
    cavity = xr_cavitation_yn
  ) %>%
  mutate(
    across(c(smwt_dist, stst_nr), ~ if_else(site == "Mozambique", NA, .x)),
    phq9_score_bin = if_else(phq9_score >= 7, 1, 0),
    sf12_phys_bin = if_else(sf12_phys < 50, 1, 0),
    sf12_ment_bin = if_else(sf12_ment < 50, 1, 0),
    smwt_dist_bin = if_else(smwt_dist < 400, 1, 0),
    stst_nr_bin = if_else(stst_nr < 20, 1, 0),
    sgrq_tot_score_bin = if_else(sgrq_tot_score > 25, 1, 0),
    across(
      c(as_alc_calc, as_tobacco_calc),
      ~ factor(if_else(.x > 0, "Yes", "No"),
        levels = c("No", "Yes")
      ),
      .names = "{.col}_bin"
    ),
    age_bin = factor(if_else(age < 30, "Yes", "No"), levels = c("No", "Yes")),
    tobacco_bin = factor(
      if_else(as_tobacco_calc > 0, "Yes", "No"),
      levels = c("No", "Yes")
    ),
    alc_bin = factor(
      if_else(as_alc_calc > 0, "Yes", "No"),
      levels = c("No", "Yes")
    ),
    across(
      c(
        age, age_bin, sex, hiv, highbact, cavity, tbd_pat_cat,
        mdr, as_alc_calc, as_tobacco_calc, alc_bin, tobacco_bin
      ),
      ~ if_else(time == "Start", .x, NA)
    )
  ) %>%
  group_by(record_id) %>%
  fill(
    age, age_bin, sex, hiv, highbact, cavity, tbd_pat_cat,
    mdr, as_alc_calc, as_tobacco_calc, alc_bin, tobacco_bin,
    .direction = "downup"
  ) %>%
  ungroup()


qol_start <- filter(qol, time == "Start")
qol_end <- filter(qol, time == "End")
qol_post <- filter(qol, time == "Post")

# labeling
outcome_cont <- c(
  "phq9_score" = "PHQ-9",
  "sf12_ment" = "SF12-MCS",
  "sf12_phys" = "SF12-PCS",
  "smwt_dist" = "6MWT",
  "stst_nr" = "STST",
  "sgrq_tot_score" = "SGRQ"
)
outcome_cont2 <- outcome_cont
names(outcome_cont2) <- gsub("_", "", names(outcome_cont))

outcome_cont3 <- c(
  "phq9_score" = "Symptoms of depression\n(PHQ-9)",
  "sf12_ment" = "Mental health\n(SF12-MCS)",
  "sf12_phys" = "Physical health\n(SF12-PCS)",
  "smwt_dist" = "Phsyical fitness\n(6MWT)",
  "stst_nr" = "Physical fitness\n(STST)",
  "sgrq_tot_score" = "Respiratory health\n(SGRQ)"
)
outcome_cont4 <- outcome_cont3
names(outcome_cont4) <- gsub("_", "", names(outcome_cont))

outcome_bin <- c(
  "phq9_score_bin" = "PHQ-9\u22657",
  "sf12_ment_bin" = "SF12-MCS<42",
  "sf12_phys_bin" = "SF12-PCS<50",
  "smwt_dist_bin" = "6MWT<400m",
  "stst_nr_bin" = "STST<20",
  "sgrq_tot_score_bin" = "SGRQ>25"
)
outcome_bin2 <- outcome_bin
names(outcome_bin2) <- gsub("_", "", names(outcome_bin))

outcome_bin3 <- c(
  "phq9_score_bin" = "Symptoms of\ndepression\n(PHQ-9)",
  "sf12_ment_bin" = "Impaired\nmental health\n(SF12-MCS)",
  "sf12_phys_bin" = "Impaired\nphysical health\n(SF12-PCS)",
  "smwt_dist_bin" = "Impaired\nphsyical fitness\n(6MWT)",
  "stst_nr_bin" = "Impaired\nphysical fitness\n(STST)",
  "sgrq_tot_score_bin" = "Impaired\nrespiratory health\n(SGRQ)"
)

predictor <- c(
  "age" = "Age",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "History of TB",
  "as_alc_calc" = "Alcohol score",
  "as_tobacco_calc" = "Tobacco score"
)
predictor_bin <- c(
  "age_bin" = "Age<30",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "History of TB",
  "alc_bin" = "Drinking",
  "tobacco_bin" = "Smoking"
)

predictor_sub <- predictor[-c(4, 6)]
predictor_bin_sub <- predictor_bin[-c(4, 6)]

treat_effect_lab <- c("End vs Start treatment", "Post vs End treatment")
```

**Outcomes**:

The quality of life **(QoL)** outcomes are:

* PHQ9-S: Patient Health Questionnaire 9 - Score (Range: 0-27; lower scores are better)
* SF12-MCS: Short form survey (SF12) - Mental Component Score (Range: 0-100; higher scores are better)
* SF12-PCS: Short form survey (SF12) - Physical Component Score (Range: 0-100; higher scores are better)
* 6MWT-D: 6 Minute Walk Test - Distance (longer distances are better)
* STST-R: Sit-to-Stand Test - Number of Repetitions (more repititions are better)
* SGRQ-S: St. George's Respiratory Questionnaire - Total Score (Range: 0-100; lower scores are better)
* ~~TB-SS: TB - Symptom Score (Range: 0-9)~~

We define impaired QoL per outcome as:

1. PHQ9-S â‰¥ 7
2. SF12-MCS < 50
3. SF12-PCS < 50
4. 6MWT-D < 400m
5. STST-R < 20
6. SGRQ-TS > 25
7. ~~TB-SS > 4~~

Note that during modelling, we transform PHQ9-S and SGRQ-S so that for all outcomes positive changes imply a QoL improvement.

**Exclusion:**

We exclude pending visits, i.e. if the patient is still within eight months for the follow-up visit.
Note that only the pending visit is excluded, *not* any previous visits from the patient. 

**Missing observations**:

The outcomes can be missing for one of the following reasons:

1. *Pending visit*: Follow-up visit still expected (within eight months since the last visit). 
2. *Death*: The patient died before the visit.
3. *Missing follow-up* (MFU): Patient did not come for a follow-up visit within eight months since the last visit.
4. *Unrecorded*: Patient visited the clinic but one or several QoL outcomes were not recorded.

We exclude pending visits.
Missing outcomes due to death or MFU are fully imputed and only used during sensitivity analyses.
Unrecorded outcomes are imputed and together with complete cases used in the main analyses. 

**Patient characteristics**:

The main predictors are:

1. Age
2. Sex
3. HIV test result
4. Multi-drug resistant TB (MDR-TB)
5. Relapse instead of new TB case
6. ASSIST alcohol score
7. ASSIST tobacco score

Age (<30) and ASSIST scores (>0) will be dichotomized during modeling. 

**Additional variables::**

We further consider:

1. Any serious but non-fatal adverse event (AE) during TB treatment: 

* Life-threatining.
* Requires in-patient hospitalization or prolongation of existing hospitalization.
* Results in persistent or significant disability/incapacity.
* Results in congenital anomaly/birth defect.
* Other important medical event that may not be immediately life-threatening or result in death, or require hospitalisation, but may jeopardise the participant or may require intervention to prevent one of the other outcomes listed above.

2. Any mental health treatment (therapy or medication) since last study visit:

* Mental health counselling, psychiatric medication, or hospital admission for mental illness.
* Treatment from a traditional healer for mental illness.
* Treatment from an outpatient health department (outpatient) for mental illness.
* Admission to a hospital or other health institution (inpatient) at least for one night for the treatment of mental illness
* Any medication for a mental illness.

3. TB treatment outcome:

* The outcome of the last TB treatment. 
* Can be categorized into successful (cured) or unsuccessful (failed, death).
* Almost all TB treatment failures are death, therefore we do not consider the TB treatment outcome further other than with death.

&nbsp;

## Descriptives

### Follow-up time

```{r follow-up-time}
tot_fup <- qol %>%
  mutate(across(contains("date"), as.Date)) %>%
  group_by(record_id) %>%
  tidyr::fill(death_date, .direction = "downup") %>%
  arrange(time) %>%
  mutate(
    visit_date = if_else(missing_fup_yn, NA, visit_date),
    visit = if_else(death_yn, "Death",
      if_else(missing_fup_yn, "MFU", "Visit")
    )
  ) %>%
  ungroup() %>%
  dplyr::select(record_id, time, visit_date, death_date, visit) %>%
  pivot_wider(values_from = c(visit_date, visit), names_from = time) %>%
  mutate(
    study_end = as.Date("2025-01-30"),
    next_visit = pmax(
      visit_date_Start,
      visit_date_End,
      na.rm = TRUE
    ) + months(6),
    expected_visit = next_visit > study_end,
    first_visit = visit_date_Start,
    last_visit = pmax(visit_date_End, visit_date_Post, na.rm = TRUE),
    last_visit = if_else(is.na(last_visit) & visit_End == "MFU",
      visit_date_Start, last_visit
    ),
    time1 = last_visit - first_visit,
    time2 = study_end - first_visit,
    time = if_else(expected_visit, time2, time1),
    time = as.numeric(time)
  )

time_btw_visits <- tot_fup %>%
  mutate(
    time_end = visit_date_End - visit_date_Start,
    time_post = visit_date_Post - visit_date_End,
    across(starts_with("time_"), as.integer)
  ) %>%
  filter(!expected_visit)

tot_fup <- tot_fup %>%
  mutate(
    time = ifelse(
      !is.na(time), time,
      median(time_btw_visits$time_end, na.rm = TRUE) *
        (visit_End == "Visit") +
        median(time_btw_visits$time_post, na.rm = TRUE) *
          (visit_Post == "Visit")
    )
  )

sprintf(
  "Total follow-up time: %s person-days with a median per person of %i (IQR %i-%i)",
  format(sum(tot_fup$time), big.mark = ","),
  round(median(tot_fup$time)),
  round(quantile(tot_fup$time, .25)),
  round(quantile(tot_fup$time, .75))
)
```

### Study population

**Table 1**: Number and proportion of completed visits, deceased patients before visit, missing follow-up visits, and pending visits over time.

```{r sample}
qol %>%
  group_by(time) %>%
  summarise(
    N = sum(!pending_visit_yn & !missing_fup_yn & !death_yn),
    MFU = sum(missing_fup_yn),
    Death = sum(death_yn),
    WFU = sum(pending_visit_yn)
  ) %>%
  ungroup() %>%
  mutate(
    Total = N + MFU + Death + WFU,
    N = paste0(N, " (", round(100 * N / Total), "%)"),
    Death = paste0(Death, " (", round(100 * Death / Total), "%)"),
    MFU = paste0(MFU, " (", round(100 * MFU / Total), "%)"),
    WFU = paste0(WFU, " (", round(100 * WFU / Total), "%)")
  ) %>%
  dplyr::select(time, N, Death, MFU, WFU) %>%
  set_names(c(
    "Time",
    "Completed visit",
    "Deceased before visit",
    "Missing follow-up",
    "Pending visit"
  )) %>%
  knitr::kable()
```

**Table 2**: Number and proportion of patients per site.

```{r sites}
qol_start %>%
  group_by(site) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  rename(Site = site) %>%
  mutate(Proportion = round(Count / sum(Count) * 100)) %>%
  knitr::kable(align = "lrr")
```

**Table 3**: Patient characteristics at baseline overall and by site.

```{r baseline}
base_df <- qol_start %>%
  mutate(
    hiv = if_else(is.na(hiv), "Unknown", hiv),
    hiv = factor(hiv, levels = c("Negative", "Positive", "Unknown"))
  ) %>%
  dplyr::select(
    record_id,
    site,
    age,
    sex,
    tbd_pat_cat,
    tbd_diagnosis,
    mdr,
    hiv,
    hiv_cd4_mm3_nr,
    hiv_viral_load,
    hiv_viral_load_nr,
    cavity,
    highbact,
    ce_bmi_cat,
    alc_bin,
    tobacco_bin
  ) %>%
  left_join(
    qol %>%
      group_by(record_id) %>%
      summarise(
        ment_trt_yn = if_else(any(ment_trt_yn == "Yes"), "Yes", "No")
      ) %>%
      ungroup(),
    by = "record_id"
  ) %>%
  mutate(ment_trt_yn = factor(ment_trt_yn, levels = c("Yes", "No"))) %>%
  dplyr::select(-record_id)

var_names <- c(
  "age" = "Age",
  "sex" = "Sex",
  "tbd_pat_cat" = "Type of case",
  "tbd_diagnosis" = "TB manifestation",
  "mdr" = "Multi-drugresistance",
  "hiv" = "HIV status",
  "hiv_cd4_mm3_nr" = "CD4 cell count",
  "hiv_viral_load" = "Detectable HIV viral load",
  "hiv_viral_load_nr" = "HIV viral load",
  "highbact" = "High bacterial load",
  "cavity" = "Cavitation",
  "ce_bmi_cat" = "BMI",
  "tobacco_bin" = "Smoking",
  "alc_bin" = "Drinking",
  "ment_trt_yn" = "Mental treatment"
)

base_tbl <- list()
for (v in colnames(base_df)[-1]) {
  if (is.numeric(base_df[[v]])) {
    cty <- var_names[v]
  } else {
    cty <- levels(base_df[[v]])
  }
  values <- matrix(
    NA,
    nrow = length(cty),
    ncol = 3 + n_distinct(base_df$site),
    dimnames = list(
      cty,
      c("Variable", "Category", "All", levels(base_df$site))
    )
  )
  values[, 1] <- v
  values[, 2] <- cty
  for (s in c("All", levels(base_df$site))) {
    if (s == "All") {
      sub <- levels(base_df$site)
    } else {
      sub <- s
    }
    if (cty[1] == var_names[v]) {
      values[cty, s] <- paste0(
        round(median(base_df[[v]][base_df$site %in% sub], na.rm = TRUE)),
        " (IQR ",
        round(quantile(base_df[[v]][base_df$site %in% sub], .25, na.rm = TRUE)),
        " - ",
        round(quantile(base_df[[v]][base_df$site %in% sub], .75, na.rm = TRUE)),
        ")"
      )
    } else {
      n_c <- table(base_df[[v]][base_df$site %in% sub])
      N_c <- sum(n_c)
      for (c in cty) {
        values[c, s] <- paste0(
          n_c[c],
          "/",
          N_c,
          " (",
          round(n_c[c] / N_c * 100, 0),
          "%)"
        )
      }
    }
  }
  base_tbl[[v]] <- values
}

do.call(rbind, base_tbl) %>%
  as.data.frame() %>%
  `rownames<-`(NULL) %>%
  mutate(
    Variable = recode(Variable, !!!var_names)
  ) %>%
  knitr::kable(align = "llrrrrr")
```

**Table 4**: Distribution of patient characteristics by time as the composition of patients changes due to missing follow-up visits.

```{r patient-characteristics-by-time}
qol %>%
  filter(!missing_fup_yn, !death_yn, !pending_visit_yn) %>%
  dplyr::select(all_of(c("time", names(predictor_bin)))) %>%
  mutate(across(-time, ~ as.integer(.x) - 1)) %>%
  melt("time") %>%
  mutate(variable = recode(variable, !!!predictor_bin)) %>%
  group_by(time, variable) %>%
  summarise_all(
    ~ if_else(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = time, values_from = value) %>%
  rename(Variable = variable) %>%
  knitr::kable(align = "lrrr")
```

Note: 

- Few MDR patients at baseline, proportionally even less at the end of anti-TB treatment and post treatment.

&nbsp;

**Table 5**: Number of patients with non-fatal serious adverse events during treatment. 

```{r no-adverse-events}
qol %>%
  filter(time == "End") %>%
  summarize(
    n_tot = sum(tbt_adv_event, na.rm = TRUE),
    n_only = sum(tbt_adv_event & pending_visit_yn, na.rm = TRUE),
    n_died = sum(tbt_adv_event & death_yn, na.rm = TRUE),
    n_mfu = sum(tbt_adv_event & missing_fup_yn, na.rm = TRUE)
  ) %>%
  gather() %>%
  mutate(key = dplyr::recode(key, !!!c(
    "n_tot" = "All adverse events",
    "n_only" = "Adverse events with pending visits",
    "n_died" = "Adverse events followed by death",
    "n_mfu" = "Adverse events with missing follow-up visits"
  ))) %>%
  set_names("Adverse event", "Count") %>%
  knitr::kable(align = "lr")
```

Note:

- Roughly a third of patients with any adverse event also died.

&nbsp;

**Table 6**: Number and proportion of patients who received mental health treatments. 

```{r no-mental-health-treatment}
qol %>%
  group_by(time) %>%
  summarize(
    `No. of patients` = sum(ment_trt_yn == "Yes", na.rm = TRUE),
    `Proportion` = paste0(
      round(sum(ment_trt_yn == "Yes", na.rm = TRUE) / n() * 100),
      "%"
    )
  ) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

Note:

- Only very few patients reported receiving mental health treatment.

&nbsp;

**Table 7**: List of all visits of patients receiving mental health treatment. Also shown are their mental health outcomes (PHQ9-S and SF12-MCS), TB treatment outcome, and whether they died or did not return for follow-up visits (MFU).

```{r list-mental-health-treatment}
qol %>%
  group_by(record_id) %>%
  filter(any(ment_trt_yn == "Yes")) %>%
  ungroup() %>%
  dplyr::select(
    record_id, time, ment_trt_yn,
    phq9_score, sf12_ment,
    tbt_outcome,
    death_yn, missing_fup_yn
  ) %>%
  mutate(
    death_yn = if_else(death_yn, "Yes", "No"),
    missing_fup_yn = if_else(missing_fup_yn, "Yes", "No")
  ) %>%
  mutate(sf12_ment = round(sf12_ment)) %>%
  arrange(record_id, time) %>%
  set_names(c(
    "Record ID", "Time", "Mental health treat.",
    "PHQ9-S", "SF12-MCS",
    "Treatment outcome",
    "Death", "MFU"
  )) %>%
  knitr::kable(align = "llrrrr")
```

**Table 8**: TB Treatment outcomes.

```{r tb-treatment-outcomes}
qol %>%
  filter(time == "End") %>%
  group_by(tbt_outcome) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(p = round(n / sum(n) * 100)) %>%
  dplyr::select(tbt_outcome, n, p) %>%
  set_names(c("Anti-TB treatment outcome", "No. of patients", "Proportion")) %>%
  knitr::kable(align = "lrr")
```

Note:

- Almost all treatment failures are death, therefore TB treatment outcome is currently not considered separately in subsequent modeling analyses.

&nbsp;

### Outcomes

#### Summary

**Table 9**: QoL scores at the start of anti-TB treatment.

```{r summaries-1}
qol_start %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR)")) %>%
  knitr::kable(align = "lr")
```

**Table 10**: QoL scores at the end of anti-TB treatment.

```{r summaries-2}
qol_end %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR)")) %>%
  knitr::kable(align = "lr")
```

**Table 11**: QoL scores post anti-TB treatment.

```{r summaries-3}
qol_post %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR)")) %>%
  knitr::kable(align = "lr")
```

#### Distribution

**Figure 1**: QoL scores by time.

```{r qol-outcomes-boxplot-by-time, fig.height=6.3, fig.width=6.3}
qol_boxplot <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  mutate(
    outcome_cat = ifelse(
      outcome %in% c("PHQ9-S", "SF12-MCS"),
      "Mental health outcomes",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"),
        "Physical health outcomes", "TB symptoms scores"
      )
    ),
    outcome_cat = factor(outcome_cat, levels = c(
      "Mental health outcomes", "Physical health outcomes", "TB symptoms scores"
    )),
    outcome = recode(outcome, !!!setNames(outcome_cont3, outcome_cont))
  ) %>%
  ggplot(aes(y = value, x = time, fill = time)) +
  facet_wrap(~outcome, scales = "free_y", ncol = 3) +
  geom_boxplot() +
  labs(y = "Score value", x = "Treatment") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(limits = c(0, NA)) +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

save_plot(
  qol_boxplot,
  pdf_file = "results/outcome-boxplot.png",
  w = 16, h = 16
)
```

**Figure 2**: Histogram of QoL scores by time.

```{r histogram-by-time, fig.width=6.3, fig.height=8.7}
qol_denesity <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value, group = time)) +
  ggh4x::facet_grid2(outcome ~ time, scales = "free", independent = "x") +
  geom_histogram(aes(y = ..density..)) +
  coord_cartesian(expand = FALSE) +
  labs(y = "Density", x = "Number of patients") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank()
  )

save_plot(
  qol_denesity,
  pdf_file = "results/outcome-density-distribution.png",
  w = 16, h = 22
)
```

**Figure 3**: Pairwise correlations between QoL scores. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r pairwise-correlation, fig.width=7, fig.height=7}
# correlations
cor <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")

# p-values
cor_pval <- function(df) {
  p_value_matrix <- matrix(NA, ncol(df), ncol(df))
  rownames(p_value_matrix) <- colnames(df)
  colnames(p_value_matrix) <- colnames(df)
  for (i in seq_along(df)) {
    for (j in seq_along(df)) {
      tmp <- cor.test(df[[i]], df[[j]])
      p_value_matrix[i, j] <- tmp$p.value
    }
  }
  return(p_value_matrix)
}
cor_p <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()

# Melt the correlation matrix into a long format
cor_melt <- rbind(
  melt(cor) %>% mutate(time = "Overall"),
  melt(cor_start) %>% mutate(time = "Start of treatment"),
  melt(cor_end) %>% mutate(time = "End of treatment"),
  melt(cor_post) %>% mutate(time = "Post treatment")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c(
      "Overall",
      "Start of treatment",
      "End of treatment",
      "Post treatment"
    ))
  )

cor_p_melt <- rbind(
  melt(cor_p) %>% mutate(time = "Overall"),
  melt(cor_p_start) %>% mutate(time = "Start of treatment"),
  melt(cor_p_end) %>% mutate(time = "End of treatment"),
  melt(cor_p_post) %>% mutate(time = "Post treatment")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c(
      "Overall",
      "Start of treatment",
      "End of treatment",
      "Post treatment"
    ))
  )

cor_rp_melt <- left_join(
  cor_melt,
  cor_p_melt,
  by = c("Var1", "Var2", "time")
) %>%
  rename(value = value.x, p = value.y) %>%
  mutate(
    p_star = ifelse(p < .001, "***",
      ifelse(p < .01, "**",
        ifelse(p < .05, "*", "")
      )
    ),
    lab = paste0(round(value, 2), p_star),
    across(
      c(value, lab),
      ~ ifelse(as.integer(Var1) <= as.integer(Var2), NA, .x)
    )
  )

cor_ov_pl <- ggplot(
  data = filter(cor_rp_melt, time == "Overall") %>%
    mutate(across(
      c(Var1, Var2),
      ~ recode(.x, !!!setNames(gsub("\n", " ", outcome_cont3), outcome_cont))
    )),
  aes(x = Var1, y = Var2, fill = value)
) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(.9, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_ov_pl,
  pdf_file = "results/outcome-overall-correlation.png",
  w = 12, h = 12
)
ggsave(
  plot = cor_ov_pl,
  filename = "results/outcome-overall-correlation.tif",
  width = 12 / cm(1), height = 12 / cm(1)
)
```

**Figure 4**: Pairwise correlations between QoL scores by time. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r correlation-overall, fig.width=10, fig.height=10}
# Create the heatmap
cor_pl <- cor_rp_melt %>%
  mutate(across(
    c(Var1, Var2),
    ~ recode(.x, !!!setNames(gsub("\n", " ", outcome_cont3), outcome_cont))
  )) %>%
  ggplot(aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  facet_wrap(~time) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_pl,
  pdf_file = "results/outcome-correlation.png",
  w = 20, h = 20
)
```

**Figure 5:** Proportion of patients with impaired QoL.

```{r proportions, fig.width=6.3, fig.height=3.9}
var_names <- c(
  "Y" = "Yes (impaired QoL)",
  "N" = "No (not impaired)",
  "D" = "Deceased",
  "L" = "Missing follow-up",
  "U" = "Unrecorded",
  "W" = "Pending visit"
)

var_colors <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1],
  "grey"
)

qol_bin_comp <- qol %>%
  dplyr::select(all_of(c(
    "time",
    "missing_fup_yn", "death_yn", "pending_visit_yn",
    names(outcome_bin)
  ))) %>%
  melt(c("time", "missing_fup_yn", "death_yn", "pending_visit_yn")) %>%
  group_by(time, variable) %>%
  summarize(
    Y = sum(value, na.rm = TRUE),
    N = sum(value == 0, na.rm = TRUE),
    D = sum(death_yn),
    U = sum(is.na(value) & !missing_fup_yn & !death_yn & !pending_visit_yn),
    L = sum(missing_fup_yn),
    W = sum(pending_visit_yn)
  ) %>%
  ungroup() %>%
  rename(outcome = variable) %>%
  melt(c("time", "outcome")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin3),
    outcome = factor(outcome, levels = outcome_bin3),
    variable = recode(variable, !!!var_names),
    variable = factor(variable, levels = var_names)
  ) %>%
  group_by(time, outcome) %>%
  mutate(p = value / sum(value) * 100) %>%
  ungroup()

qol_bin_comp_pl <- ggplot(data = qol_bin_comp, mapping = aes(x = time, y = p)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack(reverse = TRUE)
  ) +
  geom_text(
    data = filter(qol_bin_comp, variable == "Yes (impaired QoL)"),
    mapping = aes(group = time, label = paste0(round(p))),
    vjust = -.5, size = 6 / cm(1),
    color = var_colors[1],
    show.legend = FALSE
  ) +
  scale_fill_manual(
    values = var_colors,
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment",
    fill = "a"
  ) +
  theme_custom() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    legend.key.width = unit(.2, "cm"),
    legend.key.height = unit(.4, "cm")
  ) +
  guides(fill = guide_legend(nrow = 1))

save_plot(
  qol_bin_comp_pl,
  pdf_file = "results/impaired-qol.png",
  w = 18, h = 10
)
```

Here are the counts and proportions shown in the plot:

```{r proportions-table}
qol_bin_comp %>%
  mutate(outcome = gsub("\n", " ", outcome)) %>%
  arrange(outcome, time, variable) %>%
  dplyr::select(
    outcome,
    time,
    variable,
    value,
    p
  ) %>%
  mutate(p = round(p)) %>%
  rename(
    Outcome = outcome,
    Time = time,
    Category = variable,
    Count = value,
    Proportion = p
  ) %>%
  knitr::kable(align = "lllrr")
```

&nbsp;

#### Patient trajectories for depression

**Figure 6**: Trajectories of patients who were depressed (defined as PHQ9-S â‰¥ 7) once during the study.

```{r depressed-flow, fig.width=8, fig.height=10}
var_names_dprs <- c(
  "Y" = "Depressed",
  "N" = "Not depressed",
  "D" = "Deceased",
  "L" = "Missing follow-up",
  "U" = "Unrecorded",
  "W" = "Pending visit"
)

var_colors_dprs <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1],
  "grey"
)

# create links
links_dprs <- qol %>%
  dplyr::select(
    time,
    record_id,
    ment_trt_yn,
    death_yn,
    missing_fup_yn,
    pending_visit_yn,
    phq9_score_bin
  ) %>%
  rename(value = phq9_score_bin) %>%
  mutate(
    value =
      if_else(death_yn & is.na(value) & time != "Start", var_names_dprs["D"],
        if_else(missing_fup_yn, var_names_dprs["L"],
          if_else(pending_visit_yn, var_names_dprs["W"],
            if_else(is.na(value), var_names_dprs["U"],
              if_else(value == 1, var_names_dprs["Y"], var_names_dprs["N"])
            )
          )
        )
      ),
    value = factor(value, levels = var_names_dprs)
  ) %>%
  # filter patients that were depressed at least once
  group_by(record_id) %>%
  filter(any(value == var_names_dprs["Y"])) %>%
  ungroup() %>%
  group_by(time, value) %>%
  mutate(freq = n()) %>%
  ungroup()

flow_dprs_pl <- links_dprs %>%
  ggplot(aes(
    x = time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = freq
  )) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(stat = "stratum", size = 8 / cm(1)) +
  scale_fill_manual(values = var_colors_dprs) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
  scale_x_discrete(labels = c(
    "Start of treatment",
    "End of treatment",
    "Post treatment"
  )) +
  labs(y = "Number of patients") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.title.x = element_blank()
  ) +
  guides(fill = guide_legend(nrow = 2))

save_plot(
  flow_dprs_pl,
  pdf_file = "results/sankey-depressed.png",
  w = 16, h = 18
)
```

&nbsp;

## Imputation

We impute missing values in continuous QoL scores using multivariate imputation by chained equations.
We impute data in the wide format, i.e. one row per patient. 
Data are imputed using all QoL outcomes at each time point, patient characteristics at baseline, mental health treatment since last visit, and non-fatal serious adverse events during treatment.
Alcohol and tobacco use were also considered only at baseline because they were too often missing at the end of and post treatment.
Patients who died or did not return for a follow-up visit were not considered in the imputation model. 
However, their missing QoL scores were fully imputed as they were included in sensitivity analyses. 
We generate 20 datasets during imputation. Subsequent estimation results are pooled across imputed datasets.

**Figure 7**: Imputation check for a random sample of 30 patients with complete follow-up visits. Shown is the mean of the imputed scores across datasets.

```{r imputation, fig.height=12}
# wide format
qol_fu <- qol %>%
  dplyr::select(all_of(c(
    "record_id", "time",
    names(outcome_cont),
    "ment_trt_yn",
    "tbt_adv_event",
    "missing_fup_yn",
    "death_yn",
    "pending_visit_yn"
  ))) %>%
  pivot_wider(
    names_from = time,
    values_from = c(
      names(outcome_cont),
      "ment_trt_yn",
      "tbt_adv_event",
      "missing_fup_yn",
      "death_yn",
      "pending_visit_yn"
    )
  ) %>%
  left_join(
    qol %>%
      filter(time == "Start") %>%
      dplyr::select(all_of(c(
        "record_id", "site",
        names(predictor_sub)
      ))),
    by = "record_id"
  ) %>%
  mutate(
    tbt_adv_event_Start = FALSE,
    tbt_adv_event_Post = FALSE,
    across(
      starts_with("tbt_adv_"),
      ~ factor(if_else(.x, "Yes", "No"), levels = c("No", "Yes"))
    )
  )

# complete patients used for imputation model
complete_patients <- qol %>%
  group_by(record_id) %>%
  summarise(
    died = any(death_yn),
    mfu = any(missing_fup_yn),
    wfv = any(pending_visit_yn)
  ) %>%
  ungroup() %>%
  mutate(
    not_complete = (died | mfu | wfv),
    complete = !not_complete
  )
complete_patients <- left_join(
  qol_fu %>% dplyr::select(record_id),
  complete_patients,
  by = "record_id"
)


# matrix which values should be imputed
where_impute <- is.na(qol_fu)
colnames(where_impute) <- colnames(qol_fu)
row.names(where_impute) <- qol_fu$record_id
where_impute[, grepl("death_yn", colnames(where_impute))] <- FALSE
where_impute[, grepl("missing_fup_yn", colnames(where_impute))] <- FALSE
where_impute[, grepl("pending_visit_yn", colnames(where_impute))] <- FALSE

# predictor matrix
pred_mat <- matrix(1, ncol = ncol(qol_fu), nrow = ncol(qol_fu))
colnames(pred_mat) <- colnames(qol_fu)
row.names(pred_mat) <- colnames(qol_fu)
pred_mat[, 1] <- 0
pred_mat[1, ] <- 0
diag(pred_mat) <- 0
not_impute_cols <- c(
  paste("missing_fup_yn", levels(qol$time), sep = "_"),
  paste("death_yn", levels(qol$time), sep = "_"),
  paste("pending_visit_yn", levels(qol$time), sep = "_")
)
pred_mat[not_impute_cols, ] <- 0
pred_mat[, not_impute_cols] <- 0

# imputation
n_datasets <- 20
qol_fu_imp <- mice(
  qol_fu,
  # method = imp_meth, # defaults to pmm
  predictorMatrix = pred_mat,
  m = n_datasets,
  maxit = 10,
  seed = 12345,
  print = FALSE,
  ignore = complete_patients$not_complete,
  where = where_impute
)

# plot(qol_fu_imp, layout = c(2, 16))

# data
qol_fu_imp_long <- complete(qol_fu_imp, "long") %>%
  pivot_longer(
    cols = ends_with("_End") | ends_with("_Post") | ends_with("_Start"),
    names_to = c(".value", "time"),
    names_pattern = "(.*)_(.*)"
  ) %>%
  mutate(time = factor(time, levels = c("Start", "End", "Post"))) %>%
  group_by(.imp, record_id) %>%
  tidyr::fill(c(names(predictor_sub), "site"), .direction = "downup") %>%
  ungroup()

qol_fu_imp_mode <- qol_fu_imp_long %>%
  filter(!pending_visit_yn, !missing_fup_yn, !death_yn) %>%
  dplyr::select(all_of(c(".imp", "record_id", "time", names(outcome_cont)))) %>%
  melt(c(".imp", "record_id", "time")) %>%
  group_by(record_id, time, variable) %>%
  summarize(
    value = mean(value)
  ) %>%
  rename(imputed = value) %>%
  left_join(
    qol %>%
      dplyr::select(all_of(c("record_id", "time", names(outcome_cont)))) %>%
      melt(c("record_id", "time")) %>%
      rename(observed = value),
    by = c("record_id", "time", "variable")
  ) %>%
  mutate(is_observed = ifelse(is.na(observed), FALSE, TRUE)) %>%
  rename(outcome = variable)

check_imp_pl <- qol_fu_imp_mode %>%
  group_by(record_id) %>%
  filter(any(!is_observed)) %>%
  ungroup() %>%
  filter(record_id %in% sample(unique(.$record_id), 30)) %>%
  ggplot(aes(
    y = time,
    x = outcome,
    color = is_observed,
    label = round(imputed)
  )) +
  geom_text(size = 8 / cm(1)) +
  facet_wrap(~record_id, ncol = 3) +
  labs(color = "Is observed") +
  scale_x_discrete(labels = function(x) outcome_cont) +
  scale_y_discrete(labels = function(x) c("Start", "End", "Post")) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

save_plot(
  check_imp_pl,
  pdf_file = "results/imputation-check.png",
  w = 16, h = 30
)
```

&nbsp;

## Estimation

We exclude visits from patients who died before the last visit or did not return for a follow-up visit. 
We model each QoL outcome separately using Bayesian linear mixed-effects models of the form Y_kit = alpha_i + beta * time_t + lambda * z_i; k = outcome, i = patient, t = time point. 
We include site-specific fixed effects, patient-specific varying intercepts, patient characteristics, adverse events during treatment, and mental health treatment since last visit.
PHQ9-S and SGRQ-TS are inverted using (max_y - y) so that all changes>0 imply an QoL improvement.
Furthermore, to make the estimation results comparable, we compute z-scores: (y - mean(y)) / sd(y). 
We compute the difference between end and start of treatment as beta_end and between post and end of treatment as beta_post - beta_end. 
For each estimate, we report the median and 95% credible interval (CrI) of the posterior draws pooled across the models for each imputed dataset.

```{r model}
# prepare data
qol_fu_imp_prep <- qol_fu_imp_long %>%
  filter(
    !death_yn,
    !missing_fup_yn,
    !pending_visit_yn
  ) %>%
  mutate(
    alc_bin = if_else(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = if_else(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = if_else(age < 30, "Yes", "No"),
    across(
      c(age_bin, alc_bin, tobacco_bin),
      ~ factor(.x, levels = c("No", "Yes"))
    ),
    phq9_score = 27 - phq9_score,
    sgrq_tot_score = 100 - sgrq_tot_score
  ) %>%
  group_by(.imp) %>%
  mutate(across(all_of(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))) %>%
  ungroup()

# model for end vs start of treatment
mod_qol_scores <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score
    )
    ~ (1 | record_id) + site + time +
      tbt_adv_event + ment_trt_yn +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = split(qol_fu_imp_prep, qol_fu_imp_prep$.imp),
  chains = 4,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/estimated-qol-scores"
)

# posterior samples
mod_qol_smpls <- mod_qol_scores %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration"))
```

&nbsp;

### QoL changes excluding missing follow-up visits

**Figure 8**: Estimated changes in QoL outcomes between end vs start and post vs end of anti-TB treatment. Missing follow-up visits were excluded.

```{r modeled-qol-changes, fig.width=6.3, fig.height=4.7}
# posterior samples subset
time_smpls <- mod_qol_smpls %>%
  filter(!grepl(":", variable)) %>%
  filter(grepl("time", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    time = ifelse(grepl("End", variable), "End", "Post")
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = time, values_from = value) %>%
  mutate(
    Post = Post - End
  ) %>%
  ungroup() %>%
  pivot_longer(cols = c(End, Post)) %>%
  mutate(
    name = recode(
      name,
      End = "End vs start of treatment",
      Post = "Post vs end of treatment"
    ),
    name = factor(
      name,
      levels = c(
        "End vs start of treatment",
        "Post vs end of treatment"
      )
    )
  )


# plot
treat_effect_pl <- time_smpls %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont4),
    outcome = factor(outcome, levels = outcome_cont4)
  ) %>%
  ggplot(aes(x = value, y = outcome)) +
  facet_wrap(~name) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "grey") +
  stat_halfeye(
    aes(fill = after_stat(x < 0)),
    .width = 0.95,
    point_size = 1,
    linewidth = .5,
    position = position_identity()
  ) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(
    values = c("skyblue", "rosybrown2"),
    labels = c("Improvement", "Deterioration")
  ) +
  labs(x = "Estimated change in the outcome's z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_pl,
  pdf_file = "results/qol-changes.png",
  w = 16, h = 12
)
```

Interpretation:

- All QoL outcomes improved from the start to the end of anti-TB treatment.
- The improvement at the end of treatment was smaller for 6MWT and STSTR. 
- Only SF12-PCS improved further post treatment.

&nbsp;

Here are the estimated changes shown in the plot:

```{r modeled-qol-changes-table}
time_smpls <- time_smpls %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  )

time_smpls %>%
  group_by(outcome, name) %>%
  median_qi(.width = .95) %>%
  ungroup() %>%
  dplyr::select(
    name,
    outcome,
    value,
    .lower,
    .upper
  ) %>%
  mutate(
    across(c(value, .lower, .upper), round, 2)
  ) %>%
  arrange(name, outcome) %>%
  set_names(c(
    "Comparison", "Outcome",
    "Median", "Lower", "Upper"
  )) %>%
  knitr::kable(align = "llrrr")
```

&nbsp;

### Hypothetical changes in patients without follow-up visits to offset improvements

As a simulation exercise, we estimate for each outcome the change in QoL that would be needed 
in patients who died or did not return for a follow-up visit at the end of treatment 
in order to offset the positive QoL changes as estimated for patients with follow-up visits.
We compute this as b * (n / m), where 

- b is the model-estimated effect
- n is the number of patients *with* 
- m is the number of patients *without* follow-up


**Figure 9:** Estimated change in QoL for patients with follow-up visits (blue) vs hypothetical change in QoL for patients without missing follow-up visit or death so that net effect would be zero (red).

```{r simulation-check}
n_end <- n_distinct(qol$record_id[qol$time == "End"])
n_end_mfu <- sum(qol$missing_fup_yn[qol$time == "End"])
n_end_death <- sum(qol$death_yn[qol$time == "End"])
n_end_fu <- n_end - n_end_mfu - n_end_death
scale_fct <- 1

null_treat_effect <- time_smpls %>%
  filter(name == "End vs start of treatment") %>%
  mutate(
    n_nfu = n_end_mfu + n_end_death,
    n_fu = n_end_fu,
    value_zero = -(n_fu / n_nfu) * value
  ) %>%
  dplyr::select(outcome, value_zero, value) %>%
  melt("outcome") %>%
  mutate(
    group = ifelse(variable == "value",
      "Estimated change for follow-up patients",
      "Hypothetical change for patients with missing follow-up"
    ),
    group = factor(group, levels = c(
      "Estimated change for follow-up patients",
      "Hypothetical change for patients with missing follow-up"
    ))
  )

null_treat_effect_pl <- null_treat_effect %>%
  group_by(outcome, group) %>%
  summarise(
    mid = median(value),
    lower = quantile(value, .025),
    upper = quantile(value, .975)
  ) %>%
  ungroup() %>%
  ggplot(aes(y = outcome, fill = group)) +
  geom_bar(aes(x = mid), stat = "identity", alpha = .5, width = .5) +
  geom_point(aes(x = mid, color = group), size = 2) +
  geom_errorbar(aes(xmin = lower, xmax = upper, color = group), width = .2) +
  geom_vline(aes(xintercept = 0), color = "black") +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  scale_color_manual(values = c("skyblue", "rosybrown2")) +
  scale_y_discrete(limits = rev) +
  labs(x = "Changes in z-scores for a net zero effect in all patients") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  null_treat_effect_pl,
  pdf_file = "results/sensitivity-check-mfu-hypothetical-effect.png",
  w = 16, h = 14
)
```

Interpretation:

- QoL decrease for patients without follow-up would need to be extremely large so that the net effect is zero.
- We can assume that such diametrically different changes in QoL for patients without follow-up visits are unlikely.

&nbsp;

Here are the estimated and hypothetical offsetting changes shown in the plot:

```{r simulation-check-table}
null_treat_effect %>%
  dplyr::select(-variable) %>%
  group_by(outcome, group) %>%
  median_qi(.width = .95) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(
    across(c(value, .lower, .upper), round, 2),
    median_ci = paste0(value, " (95%-CrI ", .lower, "â€“", .upper, ")")
  ) %>%
  dplyr::select(outcome, group, median_ci) %>%
  ungroup() %>%
  pivot_wider(
    names_from = group, values_from = median_ci
  ) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrr")
```

&nbsp;

### Sensitivity analysis including missing follow-up visits

As a sensitivity analysis, we re-estimate changes in QoL scores including missing follow-ups and deaths with their fully imputed outcomes.


**Figure 10**: Estimated change in QoL scores when including patients with missing follow-up visits.

```{r sensitivity-full-imputation}
# data including missing follow-up
qol_fu_imp_prep_incl_mfu <- qol_fu_imp_long %>%
  filter(!pending_visit_yn) %>%
  group_by(record_id) %>%
  arrange(time) %>%
  mutate(
    death_cum = cumsum(death_yn),
    mfu_cum = cumsum(missing_fup_yn)
  ) %>%
  ungroup() %>%
  filter(death_cum < 2, mfu_cum < 2) %>%
  mutate(
    alc_bin = if_else(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = if_else(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = if_else(age < 30, "Yes", "No"),
    across(
      c(age_bin, alc_bin, tobacco_bin),
      ~ factor(.x, levels = c("No", "Yes"))
    ),
    phq9_score = 27 - phq9_score,
    sgrq_tot_score = 100 - sgrq_tot_score
  ) %>%
  group_by(.imp) %>%
  mutate(across(all_of(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))) %>%
  ungroup()

# modeling
mod_qol_full <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score
    )
    ~ (1 | record_id) + site + time +
      tbt_adv_event + ment_trt_yn +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = split(qol_fu_imp_prep_incl_mfu, qol_fu_imp_prep_incl_mfu$.imp),
  chains = 1,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/estimated-qol-scores-including-missing-follow-up"
)

# posterior samples
time_full_smpls <- mod_qol_full %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration")) %>%
  filter(!grepl(":", variable)) %>%
  filter(grepl("time", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    time = ifelse(grepl("End", variable), "End", "Post")
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = time, values_from = value) %>%
  mutate(
    Post = Post - End
  ) %>%
  ungroup() %>%
  pivot_longer(cols = c(End, Post)) %>%
  mutate(,
    name = recode(
      name,
      End = "End vs start of treatment",
      Post = "Post vs end of treatment"
    ),
    name = factor(name, levels = c(
      "End vs start of treatment",
      "Post vs end of treatment"
    ))
  )

# plot
treat_effect_full_pl <- time_full_smpls %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont4),
    outcome = factor(outcome, levels = outcome_cont4)
  ) %>%
  ggplot(aes(x = value, y = outcome)) +
  facet_wrap(~name) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "grey") +
  stat_halfeye(
    aes(fill = after_stat(x < 0)),
    .width = 0.95,
    point_size = 1,
    linewidth = .5,
    position = position_identity()
  ) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(
    values = c("skyblue", "rosybrown2"),
    labels = c("Improvement", "Deterioration")
  ) +
  labs(x = "Estimated change in the outcome's z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_full_pl,
  pdf_file = "results/sensitivity-qol-changes-full.png",
  w = 16, h = 12
)
```

Interpretation:

- Changes are very similar.

&nbsp;

Here are the estimated changes shown in the plot:

```{r sensitivity-full-imputation-table}
time_full_smpls %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome, name) %>%
  median_qi(.width = .95) %>%
  ungroup() %>%
  dplyr::select(
    name,
    outcome,
    value,
    .lower,
    .upper
  ) %>%
  mutate(
    across(c(value, .lower, .upper), round, 2)
  ) %>%
  arrange(name, outcome) %>%
  set_names(c(
    "Comparison", "Outcome",
    "Median", "Lower", "Upper"
  )) %>%
  knitr::kable(align = "llrrr")
```

&nbsp;

### Association of QoL scores with patient characteristics

We modeled QoL scores using patients characteristics at baseline interacted time. Now we look into their association.

Note that the following predictors were transformed during modeling:

- Age: age < 30 vs. age >= 30.
- Drinking and Smoking: any alcohol or tobacco use denoted as an ASSIST score >0.

We report the probability that patient characteristics are associated with lower or higher QoL scores, 
computed as the proportion of posterior draws from the model-estimated parameter 
that are smaller (lower QoL scores) or larger (higher QoL scores) than zero.


**Figure 11**: Probability that patient characteristics are associated with lower (red) or higher (blue) QoL scores. 

```{r association-by-outcome, fig.height=12, fig.width=10}
# associations of binary predictors
assoc_smpls <- mod_qol_smpls %>%
  filter(grepl(paste0(names(predictor_bin), collapse = "|"), variable)) %>%
  mutate(
    time = ifelse(
      grepl("End", variable), "End",
      ifelse(grepl("Post", variable), "Post",
        "Start"
      )
    ),
    predictor = stringi::stri_extract(
      variable,
      regex = paste0(names(predictor_bin), collapse = "|")
    ),
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    )
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(
    names_from = time, values_from = value
  ) %>%
  mutate(
    End = Start + End,
    Post = Start + Post
  ) %>%
  pivot_longer(cols = c(Start, End, Post)) %>%
  mutate(
    name = factor(name, levels = c("Start", "End", "Post")),
    predictor = recode(predictor, !!!predictor_bin),
    predictor = factor(predictor, levels = predictor_bin_sub)
  )

assoc_bin <- assoc_smpls %>%
  group_by(outcome, predictor, name) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100)
  )

assoc_bin_pl <- assoc_bin %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont4),
    outcome = factor(outcome, levels = outcome_cont4)
  ) %>%
  pivot_longer(
    cols = c(p_pos, p_neg),
    names_to = "direction",
    values_to = "prob"
  ) %>%
  mutate(
    direction = factor(
      ifelse(direction == "p_pos", "Positive", "Negative"),
      levels = c("Negative", "Positive")
    )
  ) %>%
  ggplot(aes(x = prob, y = name, fill = direction)) +
  facet_grid(outcome ~ predictor) +
  geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
  geom_vline(aes(xintercept = 20), linetype = "dashed", alpha = .5) +
  geom_vline(aes(xintercept = 50), linetype = "dashed", alpha = .5) +
  geom_vline(aes(xintercept = 80), linetype = "dashed", alpha = .5) +
  scale_x_continuous(expand = c(0, 0), breaks = c(0, 20, 50, 80, 100)) +
  scale_y_discrete(expand = c(0, 0), limits = rev) +
  scale_fill_manual(
    values = c(
      "Positive" = "skyblue",
      "Negative" = "rosybrown2"
    ),
    labels = c(
      "Positive" = "Higher QoL score",
      "Negative" = "Lower QoL score"
    )
  ) +
  labs(
    x = "Probability (%)",
    fill = ""
  ) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.key.width = unit(1, "cm"),
    legend.key.height = unit(.25, "cm"),
    panel.spacing = unit(0.4, "cm"),
    strip.text.y = element_text(margin = margin(l = 10, r = 10))
  )

save_plot(
  assoc_bin_pl,
  pdf_file = "results/association-direction.png",
  w = 20, h = 25
)
ggsave(
  plot = assoc_bin_pl,
  filename = "results/association-direction.tif",
  width = 20 / cm(1), height = 25 / cm(1)
)
```

Interpretation: 

- The plot shows whether patient characteristics are associated with a higher (blue bar left of the middle dashed line) or lower (red bar right of the middle dashed line) QoL scores.
Bars left (20%) or right (80%) of the outer dashed lines show more probable associations, i.e. the odds for the association are greater than 80%/20% = 4.
- Age<30 is typically associated with higher QoL scores. 
- Female sex and relapse TB cases are typically associated with lower QoL scores.

&nbsp;

**Table 12**: Estimated associations by time. Median and 95%-CrI and the posterior probability that change in QoL score "dz" is smaller or greater than zero.

```{r assoc-estimation-results}
assoc_cont <- assoc_smpls %>%
  group_by(outcome, predictor, name) %>%
  median_qi(.width = .95) %>%
  ungroup()

assoc_cont %>%
  dplyr::select(outcome, predictor, name, value, .lower, .upper) %>%
  left_join(assoc_bin, by = c("outcome", "predictor", "name")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    across(c(value, .lower, .upper), round, 2),
    across(c(p_neg, p_pos), round)
  ) %>%
  rename(
    Outcome = outcome,
    Predictor = predictor,
    Time = name,
    Median = value,
    Lower = .lower,
    Upper = .upper,
    `Prob. dz < 0` = p_neg,
    `Prob. dz > 0` = p_pos
  ) %>%
  arrange(Predictor, Outcome, Time) %>%
  dplyr::select(
    Predictor,
    Outcome,
    Time,
    Median,
    Lower,
    Upper,
    `Prob. dz < 0`,
    `Prob. dz > 0`
  ) %>%
  knitr::kable(align = "lllrrrrr")
```


Here are the probabilities across time and outcomes per predictor:

```{r association-across-outcomes}
assoc_smpls %>%
  group_by(predictor) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "lrr")
```

Here are the probabilities across time by outcome category (mental health: PHQ9 and SF12-MCS; physical health: SF12-PCS, SMWT, and STST; overall health: SGRQ) per predictor:

```{r association-across-categories}
assoc_smpls %>%
  mutate(
    category = ifelse(outcome %in% c("PHQ9-S", "SF12-MCS"), "Mental health",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"), "Physical health",
        "Overall health"
      )
    ),
    category = factor(category,
      levels = c("Mental health", "Physical health", "Overall health")
    )
  ) %>%
  group_by(category, predictor) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, category, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Outcome category",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "llrr")
```

Here are the probabilities across outcomes by time and per predictor:

```{r association-across-outcomes-time}
assoc_smpls %>%
  group_by(predictor, name) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, name, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Time",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "llrr")
```

Here are the probabilities by time and outcome category per predictor:

```{r association-across-categories-time}
assoc_smpls %>%
  mutate(
    category = ifelse(outcome %in% c("PHQ9-S", "SF12-MCS"), "Mental health",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"), "Physical health",
        "Overall health"
      )
    ),
    category = factor(category,
      levels = c("Mental health", "Physical health", "Overall health")
    )
  ) %>%
  group_by(category, predictor, name) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, category, name, p_neg, p_pos
  ) %>%
  set_names(c(
    "Predictor",
    "Outcome category",
    "Time",
    "Prob. dz < 0",
    "Prob. dz > 0"
  )) %>%
  knitr::kable(align = "lllrr")
```

&nbsp;

### Association of mental health treatment with QoL scores at subsequent visit

**Table 13**: Estimated association of meantal health treatment with QoL at subsequent visit.

```{r assoc-mental-health-treatment}
mod_qol_smpls %>%
  filter(grepl("ment", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Mental health treatment was *not* associated with QoL outcomes.
- Recall that only few patients received mental health treatment (few cases vs controls).

&nbsp;

### Association of QoL scores at baseline with adverse events, death or missing follow-up during treatment

```{r model-subsequent-event}
# data
qol_fu_imp_lead <- qol_fu_imp_long %>%
  group_by(.imp, record_id) %>%
  arrange(time) %>%
  mutate(
    mfu_lead = lead(missing_fup_yn),
    death_lead = lead(death_yn),
    adv_event_lead = lead(tbt_adv_event) == "Yes",
  ) %>%
  ungroup() %>%
  filter(
    !death_yn,
    !missing_fup_yn,
    !pending_visit_yn,
    time == "Start"
  ) %>%
  mutate(
    alc_bin = if_else(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = if_else(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = if_else(age < 30, "Yes", "No"),
    across(
      c(age_bin, alc_bin, tobacco_bin),
      ~ factor(.x, levels = c("No", "Yes"))
    ),
    phq9_score = 27 - phq9_score,
    sgrq_tot_score = 100 - sgrq_tot_score
  ) %>%
  group_by(.imp) %>%
  mutate(across(all_of(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))) %>%
  ungroup()

# model
mod_qol_lead <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score
    )
    ~ site +
      mfu_lead + death_lead + adv_event_lead +
      age_bin + sex +
      hiv + mdr + tbd_pat_cat +
      alc_bin + tobacco_bin
  )
  + set_rescor(rescor = FALSE),
  data = split(qol_fu_imp_lead, qol_fu_imp_lead$.imp),
  chains = 4,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/estimated-baseline-qol-scores-with-subsequent-event"
)

# posterior samples
mod_qol_lead_smpls <- mod_qol_lead %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration"))
```

**Table 14**: Estimated association of baseline QoL with non-fatal serious adverse events during treatment.

```{r assoc-subsequent-adverse-events}
mod_qol_lead_smpls %>%
  filter(grepl("adv_event", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Non-fatal serious adervse events during treatment were associated with lower SF12-PCS, 6MWT, and SGRQ at baseline.

&nbsp;

**Table 15**: Estimated association of baseline QoL with death during TB treatment.

```{r assoc-subsequent-death}
mod_qol_lead_smpls %>%
  filter(grepl("death", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Death during treatment was associated with lower QoL at baseline.

&nbsp;

**Table 16**: Estimated association of baseline QoL with missing follow-up during TB treatment.

```{r assoc-subsequent-mfu}
mod_qol_lead_smpls %>%
  filter(grepl("mfu", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Missing follow-up at the end of treatment was not associated with any QoL outcome at baseline.
- At most, there was a trend that it was associated with worse QoL outcomes at baseline.

&nbsp;

### QoL impairement over time

We now estimate and compare the proportion of patients with QoL impairment over time.
Again, we exclude visits from deceased patients or patients who did not return for a follow-up visit.


**Figure 12**: Estimated proportion of patients with impaired QoL. Pr = Probability that the proportions are smaller at the end vs start and end vs post treatment.

```{r model-qol-impairment, results = 'hide'}
# prepare data
qol_imp_bin <- qol_fu_imp_long %>%
  filter(!missing_fup_yn, !death_yn, !pending_visit_yn) %>%
  dplyr::select(
    .imp,
    record_id,
    time,
    names(outcome_cont)
  ) %>%
  mutate(
    phq9_score_bin = ifelse(phq9_score >= 7, 1, 0),
    phq9_score_bin_alt = ifelse(phq9_score >= 10, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 50, 1, 0)
  ) %>%
  group_by(.imp, time) %>%
  summarize(
    across(c(names(outcome_bin), "phq9_score_bin_alt"), sum),
    N = n()
  ) %>%
  melt(c(".imp", "time", "N")) %>%
  ungroup() %>%
  rename(n = value) %>%
  mutate(
    end = ifelse(time %in% c("End", "Post"), 1, 0),
    post = ifelse(time == "Post", 1, 0)
  ) %>%
  dplyr::select(-time) %>%
  nest(data = -.imp)

# run models
qol_bin_smpls <- tibble(
  outcome = c(),
  end_v_start = c(),
  post_v_end = c(),
)
for (out in c(names(outcome_bin), "phq9_score_bin_alt")) {
  mod_out <- brm_multiple(
    formula = bf(
      n | trials(N) ~ end + post,
      family = binomial
    ),
    data = lapply(qol_imp_bin$data, function(x) filter(x, variable == out)),
    iter = 1000,
    chains = 1,
    cores = 1,
    seed = 12345,
    file = paste0("fitted-models/estimated-prevalence-impairment-", out, ".rds")
  )
  qol_bin_smpls_out <- tibble(
    outcome = out,
    end_v_start = unlist(posterior_samples(mod_out, "b_end")),
    post_v_end = unlist(posterior_samples(mod_out, "b_post"))
  )
  qol_bin_smpls <- rbind(qol_bin_smpls, qol_bin_smpls_out)
}
```

```{r qol-impairment-over-time, fig.width=7.9, fig.height=4}
# Bayesian posterior probability
qol_bin_pp <- qol_bin_smpls %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin3),
    outcome = factor(outcome, levels = outcome_bin3)
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr=", value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
qol_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin3)
  ) %>%
  arrange(outcome, time)

pval_ypos_end <- qol_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post <- qol_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos <- rbind(
  pval_ypos_end %>% mutate(time = "End"),
  pval_ypos_post %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_comp <- qol_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = qol_bin_pp,
    y_position = pval_ypos,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6),
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25),
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_comp,
  pdf_file = "results/qol-impairment-prevalence-by-time.png",
  w = 20, h = 10
)
ggsave(
  plot = pl_comp,
  filename = "results/qol-impairment-prevalence-by-time.tif",
  width = 20 / cm(1), height = 10 / cm(1)
)
```

Intepretation:

- Prevalence of impaired QoL decreased from the start to the end of treatment for all outcomes.
- Prevalene decreased further post treatment for all outcomes except PHQ9, which was already low.

&nbsp;

Here are the mean and SD of the proportions across imputed datasets shown in the plot:

```{r qol-impairment-over-time-table}
qol_imp_prop %>%
  mutate(outcome = gsub("\n", " ", outcome)) %>%
  arrange(outcome, time) %>%
  mutate(p_m = round(p_m), p_s = round(p_s, 1)) %>%
  set_names(c(
    "Outcome",
    "Time",
    "Mean proportion",
    "SD proportion"
  )) %>%
  knitr::kable(align = "llrr")
```

&nbsp;

**Figure 13**: Estimated proportion of patients with impaired QoL by country. Pr = Probability that the proportions are smaller at the end vs start and end vs post treatment.

```{r qol-impairment-by-country}
# prepare data
qol_imp_bin_ctry <- qol_fu_imp_long %>%
  filter(!missing_fup_yn, !death_yn, !pending_visit_yn) %>%
  dplyr::select(
    .imp,
    record_id,
    site,
    time,
    names(outcome_cont)
  ) %>%
  mutate(
    phq9_score_bin = ifelse(phq9_score >= 7, 1, 0),
    phq9_score_bin_alt = ifelse(phq9_score >= 10, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 50, 1, 0)
  ) %>%
  group_by(.imp, site, time) %>%
  summarize(
    across(c(names(outcome_bin), "phq9_score_bin_alt"), sum),
    N = n()
  ) %>%
  melt(c(".imp", "site", "time", "N")) %>%
  ungroup() %>%
  rename(n = value) %>%
  mutate(
    end = ifelse(time %in% c("End", "Post"), 1, 0),
    post = ifelse(time == "Post", 1, 0)
  ) %>%
  dplyr::select(-time) %>%
  nest(data = -.imp)

# run models
qol_bin_smpls_ctry <- tibble(
  country = c(),
  outcome = c(),
  end_v_start = c(),
  post_v_end = c(),
)
for (ctry in levels(qol$site)) {
  for (out in c(names(outcome_bin), "phq9_score_bin_alt")) {
    mod_out <- brm_multiple(
      formula = bf(
        n | trials(N) ~ end + post,
        family = binomial
      ),
      data = lapply(
        qol_imp_bin_ctry$data,
        function(x) filter(x, variable == out, site == ctry)
      ),
      iter = 1000,
      chains = 1,
      cores = 1,
      seed = 12345,
      file = paste0(
        "fitted-models/estimated-prevalence-impairment",
        out, "-", ctry,
        ".rds"
      )
    )
    qol_bin_smpls_out <- tibble(
      country = ctry,
      outcome = out,
      end_v_start = unlist(posterior_samples(mod_out, "b_end")),
      post_v_end = unlist(posterior_samples(mod_out, "b_post"))
    )
    qol_bin_smpls_ctry <- rbind(qol_bin_smpls_ctry, qol_bin_smpls_out)
  }
}

# Bayesian posterior probability
qol_bin_pp_ctry <- qol_bin_smpls_ctry %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(country, outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin3),
    outcome = factor(outcome, levels = outcome_bin3)
  ) %>%
  melt(c("country", "outcome")) %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr=", value))
  ) %>%
  rename(time = variable) %>%
  arrange(country, outcome, time)


# proportion of impairments
qol_imp_prop_ctry <- qol_imp_bin_ctry %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  rename(country = site) %>%
  group_by(country, outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin3)
  ) %>%
  arrange(country, outcome, time)

pval_ypos_end_ctry <- qol_imp_prop_ctry %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(country, outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post_ctry <- qol_imp_prop_ctry %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(country, outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_ctry <- rbind(
  pval_ypos_end_ctry %>% mutate(time = "End"),
  pval_ypos_post_ctry %>% mutate(time = "Post")
) %>%
  group_by(country, outcome) %>%
  arrange(time) %>%
  mutate(p_pos = if_else(
    is.na(lead(p_pos)), p_pos, if_else(p_pos == lead(p_pos), p_pos + 10, p_pos)
  )) %>%
  ungroup() %>%
  arrange(country, outcome, time)

# plot
for (ctry in levels(qol$site)) {
  pl_comp_ctry <- qol_imp_prop_ctry %>%
    filter(country == ctry) %>%
    ggplot(aes(x = outcome, fill = time, y = p_m)) +
    geom_bar(
      stat = "identity",
      position = position_dodge(width = .66),
      width = .5
    ) +
    geom_errorbar(
      aes(ymin = p_m - p_s, ymax = p_m + p_s),
      position = position_dodge(width = .66),
      width = .2
    ) +
    ggsignif::geom_signif(
      annotations = pull(
        filter(qol_bin_pp_ctry, country == ctry),
        value
      ),
      y_position = pull(
        filter(pval_ypos_ctry, country == ctry),
        p_pos
      ),
      xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6),
      xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25),
      textsize = 8 / cm(1)
    ) +
    scale_y_continuous(
      breaks = scales::breaks_pretty(5),
      expand = expansion(mult = c(0, 0.025))
    ) +
    scale_fill_brewer(palette = "Set2") +
    coord_cartesian(ylim = c(0, NA), clip = "off") +
    labs(y = "Proportion (%)", title = ctry) +
    theme_custom(8) +
    theme(
      legend.position = "bottom", legend.title = element_blank(),
      axis.title.x = element_blank(),
      plot.title = element_text(face = 2, size = 8, margin = margin(b = 20)),
      strip.text = element_text(face = 2),
      legend.key.height = unit(0.3, "cm"),
      legend.key.width = unit(0.5, "cm"),
      plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
    )

  save_plot(
    pl_comp_ctry,
    pdf_file = paste0(
      "results/qol-impairment-prevalence-by-time_", ctry, ".png"
    ),
    w = 20, h = 10
  )
}
```

&nbsp;

**Figure 14**: Estimated proportion of patients with depression for different cutoff values. Pr = Probability that the proportions are smaller at the end vs start and end vs post treatment.

```{r sensitivity-phq9-cutoff, fig.height=4, fig.width=4}
# Bayesian posterior probability
phq9_bin_pp <- qol_bin_smpls %>%
  filter(grepl("phq9", outcome)) %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = ifelse(grepl("alt", outcome), "PHQ-9\u226510", "PHQ-9\u22657"),
    outcome = factor(outcome, levels = c("PHQ-9\u22657", "PHQ-9\u226510"))
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr=", value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
phq9_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(grepl("phq9", outcome)) %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = ifelse(grepl("alt", outcome), "PHQ-9\u226510", "PHQ-9\u22657")
  ) %>%
  arrange(outcome, time)

pval_ypos_end_phq9 <- phq9_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post_phq9 <- phq9_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_phq9 <- rbind(
  pval_ypos_end_phq9 %>% mutate(time = "End"),
  pval_ypos_post_phq9 %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_phq9_comp <- phq9_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = phq9_bin_pp,
    y_position = pval_ypos_phq9,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6)[1:4],
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25)[1:4],
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)", x = "Pericardial changes") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_phq9_comp,
  pdf_file = "results/sensitivity-depression-prevalence-by-time.png",
  w = 10, h = 10
)
```

Interpretation:

- Naturally, there are fewer depressed patients because of the lower cutoff.
- But otherwise, the changes over time are very similar.

&nbsp;

Here are the mean (SD) of the proportions across imputed datasets shown in the plot:

```{r sensitivity-phq9-cutoff-table}
phq9_imp_prop %>%
  rowwise() %>%
  mutate(
    p_m = round(p_m),
    p_s = round(p_s, 1),
    mean_sd = paste0(p_m, " (", p_s, ")")
  ) %>%
  ungroup() %>%
  dplyr::select(-p_m, -p_s) %>%
  pivot_wider(
    names_from = outcome,
    values_from = mean_sd
  ) %>%
  arrange(time) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

&nbsp;

### Quantile regression

We are primarily interested in patients whose QoL did not improve through anti-TB treatment. 
To investigate, we estimate the association of patient characteristics with different quantiles 
of the QoL score distribution at the end of anti-TB treatment using quantile regression.
We adjust for the baseline QoL score, non-fatal serious adverse events and mental health treatment.
Again, we exclude visits from deceased patients or patients who did not return for a follow-up visit.


**Figure 15**: Estimated change in QoL z-score (median as dot, 95%-CrI as lines) per quantile of the QoL score distribution at the end of anti-TB treatment by patient characteristic.

```{r quantile-regression, fig.width=7.9, fig.height=7.9}
qol_fu_change <- qol_fu_imp_prep %>%
  filter(
    !missing_fup_yn,
    !death_yn,
    !pending_visit_yn,
    time != "Post"
  ) %>%
  group_by(.imp, record_id) %>%
  filter(n() == 2) %>%
  ungroup()

qr_post_draws <- tibble(
  outcome = character(),
  predictor = character(),
  quantile = numeric(),
  .chain = numeric(),
  .iteration = numeric(),
  .draw = numeric(),
  value = numeric()
)

for (out in names(outcome_cont)) {
  qol_fu_change_out <- left_join(
    qol_fu_change %>%
      filter(time == "End") %>%
      dplyr::select(all_of(c(
        ".imp", "record_id", out,
        "tbt_adv_event", "ment_trt_yn"
      ))) %>%
      rename(End = !!sym(out)),
    qol_fu_change %>%
      filter(time == "Start") %>%
      dplyr::select(all_of(c(
        ".imp", "record_id", "site", out, names(predictor_bin_sub)
      ))) %>%
      rename(Start = !!sym(out)),
    by = c(".imp", "record_id")
  ) %>%
    dplyr::select(-record_id) %>%
    split(.$.imp)

  for (q in c(0.1, 0.25, 0.5, 0.75, 0.9)) {
    qr_tc <- brm_multiple(
      bf(End ~ Start + site +
        tbt_adv_event + ment_trt_yn +
        age_bin + sex + hiv + mdr + tbd_pat_cat +
        alc_bin + tobacco_bin, quantile = q),
      data = qol_fu_change_out,
      family = asym_laplace(),
      prior = c(
        set_prior("normal(0, 1)", class = "sigma"),
        set_prior("student_t(3, 0, 2.5)", class = "b")
      ),
      chains = 4,
      iter = 1000,
      cores = 4,
      seed = 12345,
      open_progress = FALSE,
      recompile = FALSE,
      file = paste("fitted-models/quantile-regression", out, 100 * q, sep = "-")
    )

    post_draws <- qr_tc %>%
      spread_draws(`b_.*`, regex = TRUE) %>%
      melt(c(".chain", ".draw", ".iteration")) %>%
      mutate(
        variable = str_extract(variable, "(?<=b_)[^A-Z]+"),
        outcome = out,
        quantile = q
      ) %>%
      filter(variable %in% names(predictor_bin_sub)) %>%
      rename(predictor = variable) %>%
      dplyr::select(
        outcome, predictor, quantile,
        .chain, .iteration, .draw, value
      )

    qr_post_draws <- rbind(qr_post_draws, post_draws)
  }
}

qr_post_sum <- qr_post_draws %>%
  mutate(
    predictor = recode(predictor, !!!predictor_bin_sub),
    predictor = factor(predictor, levels = predictor_bin_sub)
  ) %>%
  group_by(outcome, predictor, quantile) %>%
  summarise(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  ungroup()

qr_assoc_pl <- qr_post_sum %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont3),
    outcome = factor(outcome, levels = outcome_cont3),
    q_cat = ifelse(
      quantile < 0.5, "Bottom",
      ifelse(quantile > 0.5, "Top",
        "Middle"
      )
    ),
    q_cat = factor(q_cat, levels = c("Bottom", "Middle", "Top"))
  ) %>%
  ggplot(aes(x = quantile, color = q_cat, shape = q_cat)) +
  facet_grid(outcome ~ predictor) +
  geom_point(aes(y = median)) +
  geom_segment(aes(y = lower, yend = upper)) +
  scale_y_continuous(
    trans = "sqrt_sign",
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    labels = function(x) x * 100,
    breaks = c(0.1, 0.25, 0.5, 0.75, 0.9)
  ) +
  scale_color_manual(
    values = c(
      "Bottom" = wes_palette("Royal1")[2],
      "Middle" = "black",
      "Top" = "grey"
    )
  ) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "grey") +
  labs(
    x = "Quantile",
    y = "Estimated change in outcome's z score",
    color = "Quantile",
    shape = "Quantile"
  ) +
  theme_custom() +
  theme(
    panel.spacing = unit(0.25, "cm"),
    legend.position = "top",
    strip.text.y = element_text(margin = margin(l = 10, r = 10))
  )


save_plot(
  qr_assoc_pl,
  pdf_file = "results/quantile-regression-association.png",
  w = 20, h = 25
)
```

Interpretation:

- We focus on associations that vary between quantiles, with a focus on the bottom (red quantiles).
- Poor PHQ9 (Q10 and Q25) at end of treatment was associated with HIV+ and TB history, and inversely with MDR.
- Poor QoL was generally associated with female sex and TB history.
- Physical health of patients with low scores was better if age<30.

&nbsp;

Here are the numeric estimation results of the quantile regression shown in the plot:

```{r quantile-regression-table}
qr_post_sum %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont),
    across(c(median, lower, upper), round, 2)
  ) %>%
  rename(
    Predictor = predictor,
    Outcome = outcome,
    Quantile = quantile,
    Median = median,
    Lower = lower,
    Upper = upper
  ) %>%
  dplyr::select(
    Predictor,
    Outcome,
    Quantile,
    Median,
    Lower,
    Upper
  ) %>%
  arrange(Predictor, Outcome, Quantile) %>%
  knitr::kable(align = "lllrrr")
```