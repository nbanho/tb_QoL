---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "..")
```

```{r libraries, include=FALSE}
library(tidyverse)
library(reshape2)
library(rstanarm)
library(brms)
library(rstan)
library(tidybayes)
library(mice)
library(klaR)
source("utils/plotting.R")
source("utils/summaries.r")
```


## Data

We analyze the quality of life (QoL) outcomes of tuberculosis (TB) patients 
at the start of, end of, and post treatment in IeDEA-SA cohorts:
South Africa, Malawi, Mozambique, Zambia, and Zimbabwe.
The  data is as of April 5, 2024.


```{r data, include=FALSE}
# data of patients with at least one outcome
qol <- readRDS("data-clean/phys-ment-data.rds") %>%
  arrange(time, record_id) %>%
  # cutoffs
  mutate(
    phq9_score_bin = ifelse(phq9_score > 10, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    tb_symp_score_bin = ifelse(tb_symp_score > 4, 1, 0)
  )
qol_start <- filter(qol, time == "Start")
qol_end <- filter(qol, time == "End")
qol_post <- filter(qol, time == "Post")

# labeling
outcome_cont <- c(
  "phq9_score" = "PHQ9-S",
  "sf12_ment" = "SF12-MCS",
  "sf12_phys" = "SF12-PCS",
  "smwt_dist" = "6MWT-D",
  "stst_nr" = "STST-R",
  "sgrq_tot_score" = "SGRQ-TS",
  "tb_symp_score" = "TB-SS"
)

outcome_bin <- c(
  "phq9_score_bin" = "PHQ9-S>10",
  "sf12_ment_bin" = "SF12-MCS<42",
  "sf12_phys_bin" = "SF12-PCS<50",
  "smwt_dist_bin" = "6MWT-D<400m",
  "stst_nr_bin" = "STST-R<20",
  "sgrq_tot_score_bin" = "SGRQ-TS>25",
  "tb_symp_score_bin" = "TB-SS>4"
)

predictor <- c(
  "age" = "Age",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "Relapse case",
  "as_alc_calc" = "Alcohol score",
  "as_tobacco_calc" = "Tobacco score"
)
predictor_bin <- c(
  "age_bin" = "Age<30",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "Relapse case",
  "alc_bin" = "Drinker",
  "tobacco_bin" = "Smoker"
)

sites <- c("South Africa", "Malawi", "Mosambique", "Zambia", "Zimbabwe")

treat_effect_lab <- c("End vs Start treatment", "Post vs End treatment")
```

**Outcomes**:

The quality of life **(QoL)** outcomes:

* PHQ9-S: Patient Health Questionnaire 9 - Score (Range: 0-27)
* SF12-MCS: Short form survey (SF12) - Mental Component Score (Range: 0-100)
* SF12-PCS: Short form survey (SF12) - Physical Component Score (Range: 0-100)
* 6MWT-D: 6 Minute Walk Test - Distance
* STST-R: Sit-to-Stand Test - Number of Repetitions
* SGRQ-S: St. George's Respiratory Questionnaire - Total Score (Range: 0-100)
* TB-SS: TB - Symptom Score (Range: 0-9)

We define impaired QoL per outcome as:

1. PHQ9-S > 10
2. SF12-MCS < 42
3. SF12-PCS < 50
4. 6MWT-D < 400m
5. STST-R < 20
6. SGRQ-TS > 25
7. TB-SS > 4

Impaired QoL is analyzed descriptively, while the continuous scores are analyzed with regression models. 

**Exclusion:**

We exclude observations where we still wait for the next clinical visit.
That is, end of treatment or post treatment is still within 8mo since last visit.

**Missing observations**:

The outcomes can be missing for one of the following reasons:

1. *Death*: The patient died during or post treatment.
2. *Missing follow-up*: Missing QoL outcome because there was no follow-up visit.
3. *Unrecorded*: One or more QoL outcomes were not recorded.

**Patient characteristics**:

The predictors we consider are:

1. Age
2. Sex
3. HIV test result
4. High bacterial load on smear test.
5. Multi-drug resistant TB (MDR-TB)
6. Presence of cavitation on chest X-ray.
7. Relapse instead of new TB case.
8. ASSIST alcohol score
9. ASSIST tobacco score

**Additional variables::**

We further consider:

1. Any adverse event (AE) before, during, or post treatment.
2. Any mental health treatment (therapy or medication) during treatment.


**TB treatment outcome**:

The association with TB treatment outcome is currently not analyzed because it is mostly missing. 
Also, a treatment failure can result in death. 
Coding death as impaired QoL, dead patients would need to be excluded from the analysis.

## Descriptives

### Study population

```{r sample}
print(
  sprintf(
    "Total: %i patients with %i observations.",
    n_distinct(qol$record_id), nrow(qol)
  )
)
```

**Figure:** Number of observations by time.

```{r observations}
qol %>%
  group_by(time) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = time, y = n)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), size = 8 / cm(1), vjust = -1) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.05))
  ) +
  labs(y = "No. of observations") +
  theme_custom() +
  theme(
    axis.title.x = element_blank()
  )
```

**Table**: Proportion of patients with missing follow-up (MFU).

```{r lost-to-follow-up}
qol %>%
  group_by(time) %>%
  summarize(
    `no. of MFU` = sum(mfu),
    `proportion` = paste0(round(sum(mfu) / n() * 100), "%")
  ) %>%
  knitr::kable(align = "lrr")
```

**Table**: Patient characteristics.

```{r predictors}
qol_start %>%
  dplyr::select(all_of(names(predictor))) %>%
  gather() %>%
  mutate(
    key = recode(key, !!!predictor),
    key = factor(key, levels = predictor)
  ) %>%
  group_by(key) %>%
  summarize_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  arrange(key) %>%
  set_names(c("Variable", "Summary")) %>%
  knitr::kable(align = "lr")
```

**Table**: Share of sites.

```{r sites}
qol_start %>%
  group_by(site) %>%
  summarize(`no. of sites` = n()) %>%
  ungroup() %>%
  mutate(proportion = round(`no. of sites` / sum(`no. of sites`) * 100)) %>%
  knitr::kable(align = "lrr")
```

**Table**: List of patients with adverse events.

```{r adverse-events}
qol %>%
  group_by(record_id) %>%
  filter(any(nf_ae == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, date_visit, nf_ae_date) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "Visit date", "AE date")) %>%
  knitr::kable(align = "llrr")
```

**Table**: List of patients receiving mental health treatment.

```{r mental-health-treatment}
qol %>%
  group_by(record_id) %>%
  filter(any(ment_trt_yn == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, phq9_score, sf12_ment, death, mfu) %>%
  mutate(sf12_ment = round(sf12_ment)) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "PHQ9-S", "SF12-MCS", "Death", "MFU")) %>%
  knitr::kable(align = "llrrrr")
```

**Table**: TB Treatment outcomes.

```{r tb-treatment-outcomes}
qol %>%
  filter(time == "End") %>%
  mutate(
    `treatment outcome` = ifelse(is.na(treat_success), "Not available",
      ifelse(treat_success == 1, "Success", "Failure")
    ),
    `treatment outcome` = factor(`treatment outcome`,
      levels = c("Success", "Failure", "Not available")
    )
  ) %>%
  group_by(`treatment outcome`) %>%
  summarize(`no. of sites` = n()) %>%
  ungroup() %>%
  mutate(proportion = round(`no. of sites` / sum(`no. of sites`) * 100)) %>%
  knitr::kable(align = "lrr")
```

### Outcomes

#### Summary

**Table**: Summary of continuous QoL outcomes.

```{r summaries-1}
# start of treatment
qol_start %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment start")) %>%
  knitr::kable(align = "lr")
```

```{r summaries-2}
# end of treatment
qol_end %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment end")) %>%
  knitr::kable(align = "lr")
```

```{r summaries-3}
# post treatment
qol_post %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) post treatment")) %>%
  knitr::kable(align = "lr")
```

#### Distribution

**Figure**: Distribution of continuous QoL outcomes, excluding missings.

```{r density-distribution, fig.width=6.3, fig.height=8.7}
qol_denesity <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value, group = time)) +
  ggh4x::facet_grid2(outcome ~ time, scales = "free", independent = "x") +
  geom_histogram(aes(y = ..density..)) +
  coord_cartesian(expand = FALSE) +
  labs(y = "Density") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

save_plot(
  qol_denesity,
  pdf_file = "results/outcome-density-distribution.png",
  w = 16, h = 22
)
```

**Figure:** Proportion of patients with impaired QoL.

```{r proportions, fig.width=6.3, fig.height=3.9}
var_names <- c(
  "Y" = "Yes (impaired QoL)",
  "N" = "No (QoL not impaired)",
  "D" = "Death before visit",
  "L" = "Missing follow-up",
  "U" = "Unrecorded"
)

var_colors <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1]
)

qol_bin_comp <- qol %>%
  dplyr::select(all_of(c("time", "mfu", "death", names(outcome_bin)))) %>%
  melt(c("time", "mfu", "death")) %>%
  group_by(time, variable) %>%
  summarize(
    Y = sum(value, na.rm = TRUE),
    N = sum(value == 0, na.rm = TRUE),
    D = sum(death),
    U = sum(is.na(value) & !mfu & !death, na.rm = TRUE),
    L = sum(mfu, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  rename(outcome = variable) %>%
  melt(c("time", "outcome")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin),
    variable = recode(variable, !!!var_names),
    variable = factor(variable, levels = var_names)
  ) %>%
  group_by(time, outcome) %>%
  mutate(p = value / sum(value) * 100) %>%
  ungroup()

qol_bin_comp_pl <- ggplot(data = qol_bin_comp, mapping = aes(x = time, y = p)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack(reverse = TRUE)
  ) +
  geom_text(
    data = filter(qol_bin_comp, variable == "Yes (impaired QoL)"),
    mapping = aes(group = time, label = paste0(round(p))),
    vjust = -.5, size = 6 / cm(1),
    color = var_colors[1],
    show.legend = FALSE
  ) +
  scale_fill_manual(
    values = var_colors,
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment",
    fill = "a"
  ) +
  theme_custom() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.key.width = unit(.2, "cm"),
    legend.key.height = unit(.4, "cm")
  )

save_plot(
  qol_bin_comp_pl,
  pdf_file = "results/impaired-qol.png",
  w = 16, h = 10
)
```

#### Patient trajectories for depression

**Figure**: Trajectories of patients who were depressed (defined as PHQ9-S > 10) at least once at the start of, end of, or post treatment. 
None of the depressed patients were receiving mental health treatment.

```{r depressed-flow, fig.width=6.3, fig.height=3.9}
var_names_dprs <- c(
  "Y" = "Depressed",
  "N" = "Not depressed",
  "D" = "Death before visit",
  "L" = "Missing follow-up",
  "U" = "Unrecorded"
)

var_colors_dprs <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1]
)

# create links
links_dprs <- qol %>%
  dplyr::select(
    time,
    record_id,
    ment_trt_yn,
    death,
    mfu,
    phq9_score_bin
  ) %>%
  rename(value = phq9_score_bin) %>%
  mutate(
    value =
      ifelse(death == 1 & is.na(value) & time != "Start", var_names_dprs["D"],
        ifelse(mfu, var_names_dprs["L"],
          ifelse(is.na(value), var_names_dprs["U"],
            ifelse(value == 1, var_names_dprs["Y"], var_names_dprs["N"])
          )
        )
      ),
    value = factor(value, levels = var_names_dprs),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No"),
    ment_trt_yn = factor(ment_trt_yn, levels = c("No", "Yes"))
  ) %>%
  # filter patients that were depressed at least once
  group_by(record_id) %>%
  filter(any(value == var_names_dprs["Y"])) %>%
  ungroup() %>%
  group_by(time, value) %>%
  mutate(freq = n()) %>%
  ungroup()

flow_dprs_pl <- links_dprs %>%
  ggplot(aes(
    x = time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = freq
  )) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(stat = "stratum", size = 8 / cm(1)) +
  scale_fill_manual(values = var_colors_dprs) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
  scale_x_discrete(labels = c("Start", "End", "Post")) +
  labs(x = "Treatment") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.title.y = element_blank()
  )

save_plot(
  flow_dprs_pl,
  pdf_file = "results/sankey-depressed.png",
  w = 16, h = 10
)
```


## Imputation

We impute the missing values in the continuous QoL outcomes.
Outcomes missing because of deaths or missing follow-up visit will not be imputed, only unrecorded ones.
However, we consider subsequent death or missing follow-up visit as a predictor during imputation.
Similarly, we consider any adverse adverse event at the start of, end of, or post treatment as a predictor during imputation.

**Figure**: Imputation check for a random sample of 30 patients, showing the imputed majority label across datasets.

```{r imputation, fig.height=12}
# wide format
qol_fu <- qol %>%
  group_by(record_id) %>%
  arrange(time) %>%
  mutate(mfu_lead = lead(mfu), death_lead = lead(death)) %>%
  ungroup() %>%
  filter(!mfu & !death) %>%
  ungroup() %>%
  mutate(
    across(
      c(
        mfu_lead, death_lead, nf_ae, ment_trt_yn, sex, hiv, mdr, cavity,
        highbact, clindiag, opacity, tbd_pat_cat
      ),
      ~ factor(ifelse(.x == 1, "Yes", "No"), levels = c("No", "Yes"))
    )
  ) %>%
  dplyr::select(all_of(c(
    "record_id",
    "time",
    "site",
    "mfu_lead",
    "death_lead",
    "nf_ae",
    "ment_trt_yn",
    names(outcome_cont),
    names(predictor)
  )))

# imputation
n_datasets <- 10
qol_fu_imp <- mice(
  qol_fu[, -1],
  m = n_datasets,
  maxit = 10,
  seed = 12345,
  print = FALSE
)

# plot(qol_fu_imp, layout = c(2, 16))

# data
qol_fu_imp <- complete(qol_fu_imp, "long") %>%
  mutate(record_id = rep(qol_fu$record_id, times = n_datasets))

qol_fu_imp_mode <- qol_fu_imp %>%
  dplyr::select(all_of(c(".imp", "record_id", "time", names(outcome_cont)))) %>%
  melt(c(".imp", "record_id", "time")) %>%
  group_by(record_id, time, variable) %>%
  summarize(
    value = mean(value)
  ) %>%
  rename(imputed = value) %>%
  left_join(
    qol_fu %>%
      dplyr::select(all_of(c("record_id", "time", names(outcome_cont)))) %>%
      melt(c("record_id", "time")) %>%
      rename(observed = value),
    by = c("record_id", "time", "variable")
  ) %>%
  mutate(is_observed = ifelse(is.na(observed), FALSE, TRUE)) %>%
  rename(outcome = variable)

check_imp_pl <- qol_fu_imp_mode %>%
  group_by(record_id) %>%
  filter(any(!is_observed)) %>%
  ungroup() %>%
  filter(record_id %in% sample(unique(record_id), 30)) %>%
  ggplot(aes(
    y = time,
    x = outcome,
    color = is_observed,
    label = round(imputed)
  )) +
  geom_text(size = 8 / cm(1)) +
  facet_wrap(~record_id, ncol = 3) +
  labs(color = "Is observed") +
  scale_x_discrete(labels = function(x) outcome_cont) +
  scale_y_discrete(labels = function(x) c("Start", "End", "Post")) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

save_plot(
  check_imp_pl,
  pdf_file = "results/imputation-check.png",
  w = 16, h = 30
)
```


## Modeling

### Association with baseline characteristics

We estimate the association between patient characteristics and QoL at treatment start.
The associations are estimated using a multivariate multivariable regression model using the log of the QoL outcomes.
The multivariate part of the model accounts for the correlation between the outcomes.
The multivariable part of the model accounts for the correlation between the predictors and allows for adjustments.
The log transform is used to stabilize the variance and to make the results more interpretable and comparable.
The estimated associations are reported as the percent change in QoL scores for a one-unit change in the predictor.
We report the median and 95% credible interval of the estimated change.

We define significant associations as those with a 95% credible interval (CrI) not overlapping zero.
Since we report many associations, significant ones have to be interpreted with caution.
The reason is that with some many comparisons, we should expect some false positives.
We could remedy this using shrinkage priors such as the horeshoe prior. 
These priors would shrink most estimated associations towards zero, except for the ones that appear strong.

The following predictors are transformed:

- Age: dichotomized into age < 30 and age >= 30.
- Drinker and Smoker: dichotomized into any alcohol or tobacco use denoted as an ASSIST score greater than zero.
- The numeric ASSIST alcohol and tobacco score are still also used as continuous predictors in the model.

The following adjustments are made:

- MFU: To check whether missing follow-up is associated with QoL at baseline.
- Death: To check whether subsequent death is associated with QoL at baseline.
- AE: To check whether any adverse event before, at the start of, end of, or post treatment is associated with QoL baseline.

**Figure**: Estimated association of QoL at baseline with patient characteristics. 

```{r association-baseline}
# prepare data
qol_imp_start <- qol_fu_imp %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(c(
    ".imp",
    "record_id",
    "site",
    "mfu_lead",
    "death_lead",
    "nf_ae",
    names(outcome_cont),
    names(predictor)
  ))) %>%
  mutate(
    alc_bin = ifelse(as_alc_calc > 0, 1, 0),
    tobacco_bin = ifelse(as_tobacco_calc > 0, 1, 0),
    age_bin = ifelse(age < 30, 1, 0),
    across(
      c(
        mfu_lead, death_lead, nf_ae,
        sex, hiv, mdr, cavity, highbact, tbd_pat_cat
      ),
      ~ ifelse(.x == "Yes", 1, 0)
    )
  ) %>%
  dplyr::select(-age) %>%
  mutate(
    across(c(all_of(names(outcome_cont))), log1p)
  ) %>%
  mutate(dummy = 1) %>%
  pivot_wider(names_from = site, values_from = dummy, values_fill = 0)

for (i in unique(qol_imp_start$.imp)) {
  qol_imp_start %>%
    filter(.imp == i) %>%
    dplyr::select(-.imp, -record_id) %>%
    write.csv(
      file = paste0("fitted-models/baseline-data/imp-data-", i, ".csv"),
      row.names = FALSE
    )
}

# ... run models in numpyro ... #

# read in samples
assoc_base_smpls <- data.frame(
  file = list.files("fitted-models/baseline-samples", full.names = TRUE)
) %>%
  mutate(
    imp = as.numeric(stringi::stri_extract(file, regex = "\\d")),
    data = lapply(file, read.csv)
  ) %>%
  unnest(data)

# plot associations
assoc_base_pl <- assoc_base_smpls %>%
  filter(predictor %in% names(predictor_bin)) %>%
  mutate(
    predictor = recode(predictor, !!!predictor_bin),
    predictor = factor(predictor, levels = predictor_bin),
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome, predictor) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ungroup() %>%
  ggplot(aes(x = median, y = outcome)) +
  facet_wrap(~predictor, ncol = 3) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point() +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = .25) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  theme_custom() +
  theme(axis.title.y = element_blank())

save_plot(
  assoc_base_pl,
  pdf_file = "results/association-predictors-baseline.png",
  w = 16, h = 14
)
```

Interpretation: 

- Female sex was associated with worse physical and mental QoL scores (note that higher PHQ-9 is worse).
- HIV+ was associated with worse symptom, physical and mental QoL scores.
- High bacterial load and cavitation were associated with worse symptom scores.
- Smoking was associated with worse symptom scores.
- Other associations were not significant or ambiguous within QoL categories (symptom, physical, mental).


**Table**: Estimated change in QoL at baseline for a one-unit increase in ASSIST alcohol score.

```{r assoc-alc-score}
assoc_base_smpls %>%
  filter(predictor == "as_alc_calc") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation: 

- A one-unit increase in the ASSIST alcohol score was associated with a 0.75% (95%-CrI -0.10% to 1.61%) increase in the SGRQ-TS.


**Table**: Estimated change in QoL at baseline for a one-unit increase in ASSIST tobacco score.

```{r assoc-tobacco-score}
assoc_base_smpls %>%
  filter(predictor == "as_tobacco_calc") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- ASSIST tobacco score was not significantly associated with any QoL outcome at baseline.


**Table**: Estimated association of any adverse events with QoL at baseline.

```{r assoc-adv-events}
assoc_base_smpls %>%
  filter(predictor == "nf_ae") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- The associations of any adverse event with QoL outcomes were mostly ambiguous.
- Adverse events tended to be associated with worse PHQ9-S and 6MWT-D, but better SF12-MCS and SF12-PCS, and STST-R.
- Adverse events tended to be associated with worse symptom scores.
- The associations should be interpreted with caution because it was not differentiated when the event happend and they were generally rare.


**Table**: Estimated association of subsequent death with QoL at baseline.

```{r assoc-subsequent-death}
assoc_base_smpls %>%
  filter(predictor == "death_lead") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent death was associated with worse QoL outcomes, except for TB-SS.


**Table**: Estimated association of subsequent missing follow-up with QoL at baseline.

```{r assoc-subsequent-mfu}
assoc_base_smpls %>%
  filter(predictor == "mfu_lead") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent missing follow-up was not associated with any QoL outcome at baseline.


### Treatment effect

We compute log-changes (%) in QoL outcomes between end and start of treatment.
We exclude patients with missing follow-up visits and deaths.

**Figure**: Estimated change in QoL outcomes following TB treatment in patients with follow-up visits. 

```{r treatment-effects}
# prepare data
qol_imp_trt <- qol_fu_imp %>%
  filter(time %in% c("Start", "End")) %>%
  group_by(.imp, record_id) %>%
  filter(n() == 2) %>%
  arrange(time) %>%
  summarize(
    across(
      c(all_of(names(outcome_cont))),
      ~ diff(log1p(.x))
    )
  ) %>%
  ungroup() %>%
  mutate(time = 1) %>%
  left_join(
    qol_imp_start %>%
      dplyr::select(all_of(
        c(
          ".imp",
          "record_id",
          unique(qol$site),
          names(predictor_bin),
          "as_alc_calc",
          "as_tobacco_calc"
        )
      )),
    by = c(".imp", "record_id")
  ) %>%
  left_join(
    qol %>%
      group_by(record_id) %>%
      summarise(
        ment_trt_yn = ifelse(any(ment_trt_yn == 1), 1, 0)
      ),
    by = "record_id"
  ) %>%
  dplyr::select(-`South Africa`)

for (i in unique(qol_imp_trt$.imp)) {
  qol_imp_trt %>%
    filter(.imp == i) %>%
    dplyr::select(-.imp, -record_id) %>%
    write.csv(
      file = paste0("fitted-models/treat-data/imp-data-", i, ".csv"),
      row.names = FALSE
    )
}

# ... run models in numpyro ... #

# read in samples
trt_smpls <- data.frame(
  file = list.files("fitted-models/treat-samples", full.names = TRUE)
) %>%
  mutate(
    imp = as.numeric(stringi::stri_extract(file, regex = "\\d")),
    data = lapply(file, read.csv)
  ) %>%
  unnest(data)


# plot
treat_effect_pl <- trt_smpls %>%
  filter(predictor == "time") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ggplot(aes(x = median, y = outcome)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point() +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = .25) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  theme_custom() +
  theme(axis.title.y = element_blank())

save_plot(
  treat_effect_pl,
  pdf_file = "results/treatment-effects.png",
  w = 8, h = 6
)
```

Interpretation:

- All QoL outcomes improved following TB treatment.
- The strongest improvement was seen in PHQ9-S.
- Improvements in SF12-MCS, 6MWT-D, and STST-R were not significant.
- Results should be interpreted with caution because we expect excluded patients (death and MFU) to have worse outcomes at the end of treatment.


**Figure**: Association of baseline characteristics with treatment effect.

```{r assoc-treatment-effect}
assoc_trt_pl <- trt_smpls %>%
  filter(predictor %in% names(predictor_bin)) %>%
  mutate(
    predictor = recode(predictor, !!!predictor_bin),
    predictor = factor(predictor, levels = predictor_bin),
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome, predictor) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ungroup() %>%
  ggplot(aes(x = median, y = outcome)) +
  facet_wrap(~predictor, ncol = 3) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point() +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = .25) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  theme_custom() +
  theme(axis.title.y = element_blank())

save_plot(
  assoc_trt_pl,
  pdf_file = "results/association-predictors-treat.png",
  w = 16, h = 14
)
```

Intepretation:

- Treatment effects were lower in relapse TB cases.
- Other patient characteristics at baseline were not significantly or ambiguously associated with treatment effects.


**Table**: Association of ASSIST alcohol score with treatment effect.

```{r assoc-alc-score-trt}
trt_smpls %>%
  filter(predictor == "as_alc_calc") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Treatment effects were not significantly associated with the ASSIST alcohol score at baseline.


**Table**: Association of ASSIST tobacco score with treatment effect.

```{r assoc-tobacco-score-trt}
trt_smpls %>%
  filter(predictor == "as_tobacco_calc") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Treatment effects were not significantly associated with the ASSIST alcohol score at baseline.


**Table**: Association of mental health treatment with treatment effect.

```{r assoc-mental-health-treatment-trt}
trt_smpls %>%
  filter(predictor == "ment_trt_yn") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
````

Intepretation:

- Treatment effects were not significantly associated with any mental health treatment received during TB treatment.


### Post-treatment effect

We compute log-changes (%) in QoL outcomes between post and end of treatment.
Again, we exclude patients with missing follow-up visits and deaths.

**Figure**: Estimated change in QoL outcomes post treatment in patients with follow-up visits. 

```{r post-treatment-effect}
qol_imp_pst <- qol_fu_imp %>%
  filter(time %in% c("End", "Post")) %>%
  group_by(.imp, record_id) %>%
  filter(n() == 2) %>%
  arrange(time) %>%
  summarize(
    across(
      c(all_of(names(outcome_cont))),
      ~ diff(log1p(.x))
    )
  ) %>%
  ungroup() %>%
  mutate(time = 1) %>%
  left_join(
    qol_imp_start %>%
      dplyr::select(all_of(
        c(
          ".imp",
          "record_id",
          unique(qol$site),
          names(predictor_bin),
          "as_alc_calc",
          "as_tobacco_calc"
        )
      )),
    by = c(".imp", "record_id")
  ) %>%
  left_join(
    qol %>%
      group_by(record_id) %>%
      summarise(
        ment_trt_yn = ifelse(any(ment_trt_yn == 1), 1, 0)
      ),
    by = "record_id"
  )

for (i in unique(qol_imp_pst$.imp)) {
  qol_imp_pst %>%
    filter(.imp == i) %>%
    dplyr::select(-.imp, -record_id) %>%
    write.csv(
      file = paste0("fitted-models/post-data/imp-data-", i, ".csv"),
      row.names = FALSE
    )
}

# ... run models in numpyro ... #

# read in samples
pst_smpls <- data.frame(
  file = list.files("fitted-models/post-samples", full.names = TRUE)
) %>%
  mutate(
    imp = as.numeric(stringi::stri_extract(file, regex = "\\d")),
    data = lapply(file, read.csv)
  ) %>%
  unnest(data)


# plot
pst_effect_pl <- pst_smpls %>%
  filter(predictor == "time") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ggplot(aes(x = median, y = outcome)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point() +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = .25) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  theme_custom() +
  theme(axis.title.y = element_blank())

save_plot(
  pst_effect_pl,
  pdf_file = "results/post-effects.png",
  w = 8, h = 6
)
```

Interpretation:

- No significant post-treatment effect in any of the continuous QoL outcomes.


### Association of QoL with treatment outcomes

**Figure**: Association of baseline characteristics with post-treatment effects.

```{r assoc-post-treat-effect}
assoc_pst_pl <- pst_smpls %>%
  filter(predictor %in% names(predictor_bin)) %>%
  mutate(
    predictor = recode(predictor, !!!predictor_bin),
    predictor = factor(predictor, levels = predictor_bin),
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome, predictor) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ungroup() %>%
  ggplot(aes(x = median, y = outcome)) +
  facet_wrap(~predictor, ncol = 3) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point() +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = .25) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  theme_custom() +
  theme(axis.title.y = element_blank())

save_plot(
  assoc_pst_pl,
  pdf_file = "results/association-predictors-post.png",
  w = 16, h = 14
)
```

Intepretation:

- Patient characteristics at baseline were not significantly or ambiguously associated with post-treatment effects.


**Table**: Association of ASSIST alcohol score with post-treatment effects.

```{r assoc-alc-score-pst}
pst_smpls %>%
  filter(predictor == "as_alc_calc") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Post-treatment effects were not significantly associated with the ASSIST alcohol score at baseline.


**Table**: Association of ASSIST tobacco score with post treatment effect.

```{r assoc-tobacco-score-pst}
pst_smpls %>%
  filter(predictor == "as_tobacco_calc") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Interpretation: 

- Post-treatment effects were not significantly associated with the ASSIST tobacco score at baseline.


**Table**: Association of mental health treatment with post treatment effect.

```{r assoc-mental-health-treatment-pst}
pst_smpls %>%
  filter(predictor == "ment_trt_yn") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 0.01) %>%
  knitr::kable(align = "lrrr")
```

Interpretation:

- Post-treatment effects were not significantly associated with any mental health treatment received during TB treatment.