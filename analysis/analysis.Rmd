---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2023-09-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "..")
```

## Libraries

Loading packages...

```{r, include=FALSE}
library(tidyverse)
library(reshape2)
library(rstanarm)
library(rstan)
library(tidybayes)
source("utils/plotting.R")
source("utils/summaries.r")
```


## Data

Loading data...

```{r, include=FALSE}
# data of patients with at least one outcome
qol <- readRDS("data-clean/phys-ment-data.rds")
qol_start <- filter(qol, time == "Start treatment")
qol_end <- filter(qol, time == "End treatment")
qol_post <- filter(qol, time == "Post treatment")

# labeling
outcome_cont <- c(
  "phq9_score" = "PHQ9-S",
  "sf12_ment" = "QoL-MCS",
  "sf12_phys" = "QoL-PCS",
  "smwt_dist" = "6MWT-D",
  "stst_nr" = "STST-R"
)

outcome_bin <- c(
  "phq9_score_bin" = "PHQ9-S>10",
  "sf12_ment_bin" = "QoL-MCS<42",
  "sf12_phys_bin" = "QoL-PCS<50",
  "smwt_dist_bin" = "6MWT-D<400m",
  "stst_nr_bin" = "STST-R<20"
)

predictor <- c(
  "age" = "Age",
  "sex" = "Female",
  "hiv" = "HIV+",
  "mdr" = "MDR",
  "cavity" = "Cavitation"
)
```

* We analyze all patients with complete data, i.e. data recorded at treatment start & end and post treatment.
* Thereby, we also include patients that are lost to follow-up, i.e. no recorded data in 8 months since last visit.
* Outcomes for those lost to follow-up are treated as NA (not available).
* There may be further NAs for single outcomes, i.e. some endpoints not recorded / measured.
* Additionally, we include deaths, which we impute during modeling with worst outcomes (i.e. maximum/mininum).

## Descriptives

### Study population

```{r, echo=F, warning=FALSE, message=FALSE}
print(
  sprintf(
    "Total: %i patients with %i observations.",
    nrow(qol) / 3, nrow(qol)
  )
)
```

**Figure**: Proportion of patients lost to follow-up (LTFU).

```{r, echo=F, warning=FALSE, message=FALSE}
# no ltfu
qol %>%
  group_by(time) %>%
  summarize(p = sum(ltfu, na.rm = T) / n()) %>%
  ungroup() %>%
  ggplot(aes(x = time, y = p)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(expand = c(0, 0)) +
  labs(y = "Proportion of patients (%)") +
  theme_custom() +
  theme(axis.title.x = element_blank())
```

**Figure**: Patient characteristics.

```{r, echo=F, warning=FALSE, message=FALSE}
# patient characteristics
qol_start %>%
  dplyr::select(all_of(names(predictor))) %>%
  gather() %>%
  mutate(
    key = recode(key, !!!predictor),
    key = factor(key, levels = predictor)
  ) %>%
  group_by(key) %>%
  summarize_all(
    ~ ifelse(max(.x, na.rm = T) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  arrange(key) %>%
  set_names(c("Variable", "Summary"))
```

```{r, echo=F, warning=FALSE, message=FALSE}
# sites
count_cat(qol_start$site)
```

### Outcomes

#### Summary

**Table**: Summary of continuous outcomes at treatment start and end and post treatment. NAs (including LTFU and deaths) excluded.

```{r, echo = F, warning=FALSE, message=FALSE}
# start of treatment
qol_start %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(key = recode(key, !!!outcome_cont)) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment start"))

# end of treatment
qol_end %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(key = recode(key, !!!outcome_cont)) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment end"))

# post treatment
qol_post %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(key = recode(key, !!!outcome_cont)) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) post treatment"))
```

#### Treatment comparison

**Figure**: Distribution of continuous outcomes at treatment start and end and post treatment. Deaths imputed with worst outcomes.

```{r, echo = F, warning=FALSE, message=FALSE}
qol %>%
  dplyr::select(all_of(c("time", "death", "ltfu", names(outcome_cont)))) %>%
  mutate(across(
    all_of(names(outcome_cont)),
    ~ ifelse(death == 1 & is.na(ltfu), max(.x, na.rm = TRUE), .x)
  )) %>%
  dplyr::select(-death, -ltfu) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  ggplot(aes(x = value, fill = time)) +
  facet_wrap(~outcome, scales = "free") +
  geom_density(alpha = .5) +
  coord_cartesian(expand = FALSE) +
  scale_fill_manual(values = wes_palette("Moonrise2")) +
  labs(y = "Density") +
  theme_custom() +
  theme(
    legend.position = c(.85, .25),
    legend.direction = "vertical",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )
```

**Figure:** Proportion of patients with health conditions.

```{r, echo = F, warning=FALSE, message=FALSE}
var_names <- c(
  "Y" = "Yes",
  "N" = "No",
  "D" = "Death",
  "U" = "Unrecorded",
  "L" = "LTFU"
)

qol_bin_comp <- qol %>%
  dplyr::select(all_of(c("time", "ltfu", "death", names(outcome_bin)))) %>%
  melt(c("time", "ltfu", "death")) %>%
  group_by(time, variable) %>%
  summarize(
    Y = sum(value, na.rm = TRUE),
    N = sum(value == 0, na.rm = TRUE),
    D = sum(death == 1 & is.na(value) & time != "Start treatment"),
    U = sum(is.na(value) & !ltfu & death == 0, na.rm = TRUE),
    L = sum(ltfu & death == 0, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  rename(outcome = variable) %>%
  melt(c("time", "outcome")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin),
    variable = recode(variable, !!!var_names),
    variable = factor(variable, levels = var_names)
  ) %>%
  group_by(time, outcome) %>%
  mutate(p = value / sum(value) * 100) %>%
  ungroup()

qol_bin_comp_pl <- ggplot(data = qol_bin_comp, mapping = aes(x = time, y = p)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack(reverse = TRUE)
  ) +
  geom_text(
    data = filter(qol_bin_comp, variable == "Yes"),
    mapping = aes(group = time, label = paste0(round(p), "%")),
    vjust = -.5, size = 8 / cm(1),
    color = wes_palette("AsteroidCity2")[1],
    show.legend = FALSE
  ) +
  scale_fill_manual(
    values = wes_palette("AsteroidCity2"),
  ) +
  scale_x_discrete(labels = c("Start", "End", "Post")) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment",
    fill = "a"
  ) +
  theme_custom() +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(title = element_blank())
  )

qol_bin_comp_pl

save_plot(
  qol_bin_comp_pl,
  pdf_file = "results/score-treatment-comparison.png",
  w = 16, h = 10
)
```

#### Changes

**Figure**: Changes in health conditions. Deaths are imputed with worst outcomes.

```{r, echo = F, warning=FALSE, message=FALSE}
qol_changes <- qol %>%
  dplyr::select(
    all_of(c("record_id", "time", "ltfu", "death", names(outcome_bin)))
  ) %>%
  mutate(across(
    all_of(names(outcome_bin)),
    ~ ifelse(death == 1 & is.na(value) & time != "Start treatment", 1, .x)
  )) %>%
  dplyr::select(-death, -ltfu) %>%
  melt(c("record_id", "time")) %>%
  dcast(record_id + variable ~ time) %>%
  mutate(
    change_end = `End treatment` - `Start treatment`,
    change_post = `Post treatment` - `End treatment`
  ) %>%
  dplyr::select(record_id, variable, change_end, change_post) %>%
  rename(outcome = variable) %>%
  melt(c("record_id", "outcome")) %>%
  mutate(
    variable = ifelse(variable == "change_end", "End vs Start", "Post vs End"),
    value =
      ifelse(is.na(value), "Unknown",
        ifelse(value == -1, "Improved",
          ifelse(value == 0, "Unchanged", "Worsened")
        )
      ),
    value = factor(value, levels = c("Unknown", "Worsened", "Unchanged", "Improved")), # nolint
    outcome = recode(gsub("_bin", "", outcome), !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  )

qol_changes_sum <- qol_changes %>%
  group_by(outcome, variable, value) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(outcome, variable) %>%
  mutate(p = 100 * n / sum(n)) %>%
  ungroup()

qol_changes_sum_pl <- ggplot(
  data = qol_changes_sum,
  mapping = aes(x = outcome, y = p, fill = value)
) +
  facet_wrap(~variable, nrow = 1) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(
    data = filter(qol_changes_sum, value == "Improved"),
    mapping = aes(group = value, label = paste0(round(p), "%")),
    vjust = -.5, size = 8 / cm(1),
    color = wes_palette("AsteroidCity2")[3],
    show.legend = F
  ) +
  scale_fill_manual(
    values = c(rev(wes_palette("AsteroidCity2")[1:3]), "grey"),
    breaks = c("Improved", "Unchanged", "Worsened", "Unknown")
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment", fill = "a", alpha = "a"
  ) +
  theme_custom() +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(title = element_blank()),
    alpha = guide_legend(title = element_blank())
  )

qol_changes_sum_pl
```


#### Stratum flow 

**Figure**: Patient flow between health stratums.

```{r, echo = F, warning=FALSE, message=FALSE}
# define categories
sankey_cats <- data.frame(
  outcome = outcome_cont,
  cutoff = c(10, 42, 50, 400, 20)
) %>%
  mutate(
    yes = paste(outcome, "smaller", cutoff),
    no = paste(outcome, "bigger", cutoff),
    death = paste(outcome, "death"),
    ltfu = paste(outcome, "ltfu"),
    unknown = paste(outcome, "unknown")
  ) %>%
  dplyr::select(yes, no, death, ltfu, unknown) %>%
  gather() %>%
  mutate(
    names = gsub("smaller \\d*", "yes", value),
    names = gsub("bigger \\d*", "no", names),
    value = gsub("smaller", "<", value),
    value = gsub("bigger", ">", value)
  )
sankey_cats_vec <- sankey_cats$value
names(sankey_cats_vec) <- sankey_cats$names

# create links
links <- qol %>%
  dplyr::select(
    all_of(c("time", "record_id", "death", "ltfu", names(outcome_bin)))
  ) %>%
  reshape2::melt(c("time", "record_id", "death", "ltfu")) %>%
  rename(outcome = variable) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin),
    value =
      ifelse(death == 1 & is.na(value) & time != "Start treatment", "Death",
        ifelse(ltfu, "LTFU",
          ifelse(is.na(value), "Unrecorded",
            ifelse(value == 1, "Yes", "No")
          )
        )
      ),
    value = factor(
      value,
      levels = c("Yes", "No", "Death", "Unrecorded", "LTFU")
    )
  ) %>%
  group_by(outcome, time, value) %>%
  mutate(freq = n()) %>%
  ungroup()

flow_pl <- links %>%
  ggplot(aes(
    x = time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = freq
  )) +
  facet_wrap(~outcome) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(stat = "stratum", size = 8 / cm(1)) +
  scale_fill_manual(values = wes_palette("AsteroidCity2")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_discrete(labels = c("Start", "End", "Post")) +
  labs(x = "Treatment") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = c(.8, .2),
    axis.title.y = element_blank()
  )

save_plot(
  flow_pl,
  pdf_file = "results/sankey.png",
  w = 16, h = 12
)
```

## Modeling

### Multivariate treatment effects

```{r}
# create stan data
sdmult <- list()
sdmult$y <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  as.matrix()
sdmult$y <- scale(sdmult$y, center = TRUE, scale = TRUE)
sdmult$y_means <- attr(sdmult$y, "scaled:center")
sdmult$y_sd <- attr(sdmult$y, "scaled:scale")
sdmult$y_cutoffs <- c(10, 42, 50, 400, 20)
sdmult$y_missing <- matrix(0, nrow(sdmult$y), ncol(sdmult$y))
m <- 1
for (i in 1:nrow(sdmult$y)) {
  for (k in 1:ncol(sdmult$y)) {
    if (is.na(sdmult$y[i, k])) {
      sdmult$y_missing[i, k] <- m
      m <- m + 1
    } else {
      sdmult$y_missing[i, k] <- 0
    }
  }
}
sdmult$y[is.na(sdmult$y)] <- -9999
sdmult$x <- qol %>%
  mutate(
    treat_end = ifelse(time == "End treatment", 1, 0),
    treat_post = ifelse(time == "Post treatment", 1, 0),
    age30 = ifelse(age <= 30, 1, 0)
  ) %>%
  dplyr::select(treat_end, treat_post, age30, sex, hiv_test_result, drug_resistant, cavity) %>%
  as.matrix()
sdmult$N <- nrow(sdmult$y)
sdmult$K <- ncol(sdmult$y)
sdmult$J <- ncol(sdmult$x)
sdmult$M <- max(sdmult$y_missing)

# model
mod_multi <- stan(
  file = "models/multivariate.stan",
  data = sdmult, seed = 12345, cores = 2
)

# summary
summary(mod_multi, probs = c(.025, .975), pars = c("beta", "L_Omega"))$summary
spread_draws(mod_multi, beta[k, t]) %>%
  mutate(t = ifelse(t == 1, "Start treatment", "Post treatment")) %>%
  left_join(data.frame(k = 1:5, outcome = outcome_cont), by = "k") %>%
  ggplot(aes(x = beta, y = outcome)) +
  facet_wrap(~ factor(t, levels = c("Start treatment", "Post treatment"))) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_pointinterval(point_size = 2, .width = c(0.95))

assoc_cont <- spread_draws(mod_multi, beta[k, j]) %>%
  filter(j > 2) %>%
  left_join(data.frame(k = 1:5, outcome = outcome_cont), by = "k") %>%
  left_join(
    data.frame(
      j = 3:ncol(sdmult$x),
      pred_var = predictor
    ),
    by = "j"
  ) %>%
  mutate(
    outcome = factor(outcome, levels = outcome_cont),
    pred_var = ifelse(pred_var == "Age", "Age<30", pred_var),
    preditor = factor(pred_var, levels = c("Age<30", predictor[-1]))
  )


assoc_cont_pl <- assoc_cont %>%
  ggplot(aes(x = beta, y = pred_var)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_pointinterval(
    .width = c(.5, 0.95),
    point_size = 1, shape = 21, point_fill = "white"
  ) +
  scale_x_continuous(breaks = scales::breaks_pretty(5), limits = c(-1, 1)) +
  labs(
    x = "Estimated association (z score)",
    title = "Estimated association between health scores and patient characteristics",
    subtitle = "Association shown as changes in z-scores of continuous outcomes"
  ) +
  theme_custom() +
  theme(axis.title.y = element_blank())

save_plot(
  assoc_cont_pl,
  pdf_file = "results/continuous-score-association.png",
  w = 16, h = 6
)

# binary changes
qol_pred <- spread_draws(mod_multi, y_pred[i, k]) %>%
  left_join(data.frame(
    k = 1:5,
    outcome = outcome_bin,
    y_mean = sdmult$y_means,
    y_sd = sdmult$y_sd,
    y_cut = sdmult$y_cutoffs
  ), by = "k") %>%
  left_join(
    qol %>%
      mutate(i = 1:n()) %>%
      dplyr::select(i, record_id, time),
    by = "i"
  ) %>%
  mutate(
    y_pred = y_pred * y_sd + y_mean,
    y_bin = ifelse(outcome == "PHQ9-S>10", y_pred > y_cut, y_pred < y_cut)
  ) %>%
  group_by(outcome, time, .draw) %>%
  summarize(
    n = sum(y_bin),
    p = sum(y_bin) / n()
  ) %>%
  ungroup() %>%
  mutate(outcome = factor(outcome, levels = outcome_bin))

# comparison
qol_pred_comp <- qol_pred %>%
  dplyr::select(outcome, time, p, .draw) %>%
  rename(draw = `.draw`) %>%
  dcast(formula = outcome + draw ~ time, value.var = "p") %>%
  mutate(
    es = `End treatment` < `Start treatment`,
    ep = `Post treatment` < `End treatment`
  ) %>%
  group_by(outcome) %>%
  summarise(
    es = sum(es) / n(),
    ep = sum(ep) / n()
  ) %>%
  ungroup() %>%
  melt("outcome") %>%
  rename(comparison = variable) %>%
  mutate(comparison = as.character(comparison))

# annotation
qol_pred_comp_annon <- data.frame(
  outcome = outcome_bin,
  xmin_es = c(0.75, 1.75, 2.75, 3.75, 4.75),
  xmin_ep = 1:5
) %>%
  mutate(
    xmax_es = xmin_es + 0.25,
    xmax_ep = xmin_ep + 0.25
  ) %>%
  mutate(
    ypos_es = qol_pred %>%
      filter(time %in% c("Start treatment", "End treatment")) %>%
      group_by(outcome, time) %>%
      summarize(ypos = quantile(p, .975)) %>%
      ungroup() %>%
      group_by(outcome) %>%
      summarize(ypos = max(ypos)) %>%
      ungroup() %>%
      dplyr::select(ypos) %>%
      unlist(),
    ypos_ep = qol_pred %>%
      filter(time %in% c("End treatment", "Post treatment")) %>%
      group_by(outcome, time) %>%
      summarize(ypos = quantile(p, .975)) %>%
      ungroup() %>%
      group_by(outcome) %>%
      summarize(ypos = max(ypos)) %>%
      ungroup() %>%
      dplyr::select(ypos) %>%
      unlist()
  ) %>%
  melt("outcome") %>%
  mutate(
    comparison = stringi::stri_extract(variable, regex = "_.*"),
    variable = gsub("_.*", "", variable),
    comparison = gsub("_", "", comparison)
  ) %>%
  dcast(outcome + comparison ~ variable)

qol_pred_comp <- qol_pred_comp %>%
  left_join(qol_pred_comp_annon, by = c("outcome", "comparison")) %>%
  mutate(
    lab = round(value * 100),
    lab = paste0("Pr.", ifelse(lab == 100, ">99", paste0("=", lab)), "%")
  ) %>%
  mutate(ypos = ypos + .05)

# plot
qol_pred_change_pl <- qol_pred %>%
  ggplot(aes(x = outcome, y = p, color = time)) +
  stat_interval(aes(fill_ramp = after_stat(level)),
    position = position_dodge(width = .75),
    .width = c(.5, .95),
    alpha = .5
  ) +
  stat_pointinterval(
    .width = NA,
    position = position_dodge(width = .75),
    shape = 21, fill = "white", size = 2,
    show.legend = FALSE
  ) +
  ggsignif::geom_signif(
    annotations = qol_pred_comp$lab,
    y_position = qol_pred_comp$ypos,
    xmin = qol_pred_comp$xmin,
    xmax = qol_pred_comp$xmax,
    textsize = 8 / cm(1), color = "black"
  ) +
  scale_color_manual(values = wes_palette("Moonrise2")) +
  scale_y_continuous(
    expand = expansion(add = c(0, 0.05)), limits = c(0, 1),
    labels = function(x) x * 100
  ) +
  labs(
    y = "Proportion of patients (%)",
    title = "Estimated changes in physical and mental health in TB patients",
    subtitle = "Proportion of patients by changes between treatment end vs start and post treatment vs treatment end" # nolint
  ) +
  theme_custom() +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    legend.key.width = unit(.3, "cm"), legend.key.height = unit(.6, "cm")
  )

save_plot(
  qol_pred_change_pl,
  pdf_file = "results/binary-score-estimated-treatment-change.png",
  w = 16, h = 10
)
```

