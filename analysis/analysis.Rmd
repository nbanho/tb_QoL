---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "..")
```

```{r libraries, include=FALSE}
library(tidyverse)
library(reshape2)
library(rstanarm)
library(brms)
library(rstan)
library(tidybayes)
library(mice)
library(klaR)
source("utils/plotting.R")
source("utils/summaries.r")
```


## Data

We analyze the quality of life (QoL) outcomes of tuberculosis (TB) patients 
at the start of, end of, and post treatment in IeDEA-SA cohorts:
South Africa, Malawi, Mozambique, Zambia, and Zimbabwe.
The  data is as of April 5, 2024.


```{r data, include=FALSE}
# data of patients with at least one outcome
qol <- readRDS("data-clean/phys-ment-data.rds") %>%
  arrange(time, record_id) %>%
  # cutoffs
  mutate(
    phq9_score_bin = ifelse(phq9_score > 10, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    tb_symp_score_bin = ifelse(tb_symp_score > 4, 1, 0)
  )
qol_start <- filter(qol, time == "Start")
qol_end <- filter(qol, time == "End")
qol_post <- filter(qol, time == "Post")

# labeling
outcome_cont <- c(
  "phq9_score" = "PHQ9-S",
  "sf12_ment" = "SF12-MCS",
  "sf12_phys" = "SF12-PCS",
  "smwt_dist" = "6MWT-D",
  "stst_nr" = "STST-R",
  "sgrq_tot_score" = "SGRQ-TS",
  "tb_symp_score" = "TB-SS"
)

outcome_bin <- c(
  "phq9_score_bin" = "PHQ9-S>10",
  "sf12_ment_bin" = "SF12-MCS<42",
  "sf12_phys_bin" = "SF12-PCS<50",
  "smwt_dist_bin" = "6MWT-D<400m",
  "stst_nr_bin" = "STST-R<20",
  "sgrq_tot_score_bin" = "SGRQ-TS>25",
  "tb_symp_score_bin" = "TB-SS>4"
)

predictor <- c(
  "age" = "Age",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "Relapse case",
  "as_alc_calc" = "Alcohol score",
  "as_tobacco_calc" = "Tobacco score"
)
predictor_bin <- c(
  "age_bin" = "Age<30",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "Relapse case",
  "alc_bin" = "Drinker",
  "tobacco_bin" = "Smoker"
)

predictor_sub <- predictor[-c(4, 6, 7)]
predictor_bin_sub <- predictor_bin[-c(4, 6, 7)]

sites <- c("South Africa", "Malawi", "Mosambique", "Zambia", "Zimbabwe")

treat_effect_lab <- c("End vs Start treatment", "Post vs End treatment")
```

**Outcomes**:

The quality of life **(QoL)** outcomes:

* PHQ9-S: Patient Health Questionnaire 9 - Score (Range: 0-27)
* SF12-MCS: Short form survey (SF12) - Mental Component Score (Range: 0-100)
* SF12-PCS: Short form survey (SF12) - Physical Component Score (Range: 0-100)
* 6MWT-D: 6 Minute Walk Test - Distance
* STST-R: Sit-to-Stand Test - Number of Repetitions
* SGRQ-S: St. George's Respiratory Questionnaire - Total Score (Range: 0-100)
* TB-SS: TB - Symptom Score (Range: 0-9)

We define impaired QoL per outcome as:

1. PHQ9-S > 10
2. SF12-MCS < 42
3. SF12-PCS < 50
4. 6MWT-D < 400m
5. STST-R < 20
6. SGRQ-TS > 25
7. TB-SS > 4

**Exclusion:**

We exclude observations where we still wait for the next clinical visit.
That is, end of treatment or post treatment is still within 8mo since last visit.

**Missing observations**:

The outcomes can be missing for one of the following reasons:

1. *Death*: The patient died during or post treatment.
2. *Missing follow-up* (MFU): Missing QoL outcome because there was no follow-up visit.
3. *Unrecorded*: One or more QoL outcomes were not recorded.

**Patient characteristics**:

The predictors we consider are:

1. Age
2. Sex
3. HIV test result
4. High bacterial load on smear test (not considered during modeling anymore)
5. Multi-drug resistant TB (MDR-TB)
6. Presence of cavitation on chest X-ray (not considered during modeling anymore)
7. Relapse instead of new TB case (not considered during modeling anymore)
8. ASSIST alcohol score
9. ASSIST tobacco score

**Additional variables::**

We further consider:

1. Any serious but non-fatal adverse event (AE) during treatment: 

* Life-threatining.
* Requires in-patient hospitalization or prolongation of existing hospitalization.
* Results in persistent or significant disability/incapacity.
* Results in congenital anomaly/birth defect.
* Other important medical event that may not be immediately life-threatening or result in death, or require hospitalisation, but may jeopardise the participant or may require intervention to prevent one of the other outcomes listed above.

2. Any mental health treatment (therapy or medication) since last visit:

* Mental health counselling, psychiatric medication, or hospital admission for mental illness.
* Treatment from a traditional healer for mental illness.
* Treatment from an outpatient health department (outpatient) for mental illness.
* Admission to a hospital or other health institution (inpatient) at least for one night for the treatment of mental illness
* Any medication for a mental illness.

Both AE and mental health treatment are currently very rare and thus not considered during modeling.

3. TB treatment outcome:

* The outcome of the last TB treatment categorized into successful (cured) or unsuccessful (failed, death).

Most TB treatment failres are death, therefore TB treatment outcome is not considered separately during modeling.

## Descriptives

### Study population

```{r sample}
print(
  sprintf(
    "Total: %i patients with %i observations.",
    n_distinct(qol$record_id), nrow(qol)
  )
)
```

**Figure:** Number of observations by time.

```{r observations}
qol %>%
  group_by(time) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = time, y = n)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), size = 8 / cm(1), vjust = -1) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.05))
  ) +
  labs(y = "No. of observations") +
  theme_custom() +
  theme(
    axis.title.x = element_blank()
  )
```

**Table**: Proportion of patients with missing follow-up (MFU).

```{r lost-to-follow-up}
qol %>%
  group_by(time) %>%
  summarize(
    `no. of MFU` = sum(mfu),
    `proportion` = paste0(round(sum(mfu) / n() * 100), "%")
  ) %>%
  knitr::kable(align = "lrr")
```

**Table**: Proportion of patients who died.

```{r deaths}
qol %>%
  group_by(time) %>%
  summarize(
    `no. of deaths` = sum(death),
    `proportion` = paste0(round(sum(death) / n() * 100), "%")
  ) %>%
  knitr::kable(align = "lrr")
```

**Table**: Patient characteristics at baseline.

```{r predictors}
qol_start %>%
  dplyr::select(all_of(names(predictor))) %>%
  gather() %>%
  mutate(
    key = recode(key, !!!predictor),
    key = factor(key, levels = predictor)
  ) %>%
  group_by(key) %>%
  summarize_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  arrange(key) %>%
  set_names(c("Variable", "Summary")) %>%
  knitr::kable(align = "lr")
```

**Table**: Distribution of patient characteristics by time.

```{r}
qol %>%
  filter(!mfu, !death) %>%
  mutate(
    age_bin = ifelse(age < 30, 1, 0),
    alc_bin = ifelse(as_alc_calc > 0, 1, 0),
    tobacco_bin = ifelse(as_tobacco_calc > 0, 1, 0)
  ) %>%
  dplyr::select(all_of(c("time", names(predictor_bin)))) %>%
  melt("time") %>%
  mutate(variable = recode(variable, !!!predictor_bin)) %>%
  group_by(time, variable) %>%
  summarise_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = time, values_from = value) %>%
  knitr::kable(align = "lrrr")
```

Note: 

- Almost no follow-up visits among MDR patients, therefore time interaction effects with MDR not modeled later.
- Lower prevalence of alcohol and tobacco use at the end of treatment (but not post treatment) compared with baseline.


**Table**: Share of sites.

```{r sites}
qol_start %>%
  group_by(site) %>%
  summarize(`no. of sites` = n()) %>%
  ungroup() %>%
  mutate(proportion = round(`no. of sites` / sum(`no. of sites`) * 100)) %>%
  knitr::kable(align = "lrr")
```

**Table**: Number of patients with non-fatal serious adverse events (AE). 

```{r no-adverse-events}
qol %>%
  group_by(time) %>%
  summarize(
    n_tot = sum(nf_ae == 1, na.rm = TRUE),
    n_only = sum(nf_ae == 1 & !death & !mfu, na.rm = TRUE),
    n_died = sum(nf_ae == 1 & death, na.rm = TRUE),
    n_mfu = sum(nf_ae == 1 & mfu, na.rm = TRUE)
  ) %>%
  set_names(c("Time", "Total AE", "Only AE", "AE and death", "AE and MFU")) %>%
  knitr::kable(align = "lrrrr")
```

Note:

- The actual number of adverse events is 29 but 21 are from patients where we still wait for the end of treatment visit.
- Since AE is very rare, it is currently not considered in subsequent modeling analyses.

**Table**: List of visits of patients with any AE.

```{r list-adverse-events}
qol %>%
  group_by(record_id) %>%
  filter(any(nf_ae == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, date_visit, nf_ae_date) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "Visit date", "AE date")) %>%
  knitr::kable(align = "llrr")
```

**Table**: Number of patients who received mental health treatments. 

```{r no-mental-health-treatment}
qol %>%
  group_by(time) %>%
  summarize(
    `no. of patients` = sum(ment_trt_yn == 1, na.rm = TRUE),
    `proportion` = paste0(round(sum(ment_trt_yn == 1, na.rm = TRUE) / n() * 100), "%")
  ) %>%
  knitr::kable(align = "lrr")
```

**Table**: List of visits of patients receiving mental health treatment.

```{r list-mental-health-treatment}
qol %>%
  group_by(record_id) %>%
  filter(any(ment_trt_yn == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, phq9_score, sf12_ment, death, mfu, ment_trt_yn) %>%
  mutate(
    death = ifelse(death, "Yes", "No"),
    mfu = ifelse(mfu, "Yes", "No"),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No")
  ) %>%
  mutate(sf12_ment = round(sf12_ment)) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "PHQ9-S", "SF12-MCS", "Death", "MFU", "Mental health treat.")) %>%
  knitr::kable(align = "llrrrr")
```

**Table**: TB Treatment outcomes.

```{r tb-treatment-outcomes}
qol %>%
  filter(time == "End") %>%
  mutate(
    `treatment outcome` = ifelse(is.na(treat_success), "Not available",
      ifelse(treat_success == 1, "Success",
        ifelse(death, "Death", "Other failure")
      )
    ),
    `treatment outcome` = factor(`treatment outcome`,
      levels = c("Success", "Death", "Other failure", "Not available")
    )
  ) %>%
  group_by(`treatment outcome`) %>%
  summarize(`no. of sites` = n()) %>%
  ungroup() %>%
  mutate(proportion = round(`no. of sites` / sum(`no. of sites`) * 100)) %>%
  knitr::kable(align = "lrr")
```

Note:

- Almost all treatment failures are death, therefore TB treatment outcome is currently not considered in subsequent modeling analyses.

### Outcomes

#### Summary

**Table**: Descriptive summaries of continuous QoL outcomes.

```{r summaries-1}
# start of treatment
qol_start %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment start")) %>%
  knitr::kable(align = "lr")
```

```{r summaries-2}
# end of treatment
qol_end %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) at treatment end")) %>%
  knitr::kable(align = "lr")
```

```{r summaries-3}
# post treatment
qol_post %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR) post treatment")) %>%
  knitr::kable(align = "lr")
```

#### Distribution

**Figure**: Boxplots of continuous QoL outcomes by time.

```{r qol-outcomes-boxplot-by-time}
qol_boxplot <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  mutate(
    outcome_cat = ifelse(
      outcome %in% c("PHQ9-S", "SF12-MCS"),
      "Mental health outcomes",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"),
        "Physical health outcomes", "TB symptoms scores"
      )
    ),
    outcome_cat = factor(outcome_cat, levels = c(
      "Mental health outcomes", "Physical health outcomes", "TB symptoms scores"
    ))
  ) %>%
  ggplot(aes(y = value, x = time, fill = time)) +
  facet_wrap(~outcome, scales = "free_y", ncol = 3) +
  geom_boxplot() +
  labs(y = "Score value") +
  scale_fill_brewer(palette = "Set2") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank()
  )

save_plot(
  qol_boxplot,
  pdf_file = "results/outcome-boxplot.png",
  w = 16, h = 16
)
```

**Figure**: Histograms of continuous QoL outcomes by time.

```{r histogram-by-time, fig.width=6.3, fig.height=8.7}
qol_denesity <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value, group = time)) +
  ggh4x::facet_grid2(outcome ~ time, scales = "free", independent = "x") +
  geom_histogram(aes(y = ..density..)) +
  coord_cartesian(expand = FALSE) +
  labs(y = "Density") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

save_plot(
  qol_denesity,
  pdf_file = "results/outcome-density-distribution.png",
  w = 16, h = 22
)
```

**Figure**: Pairwise correlations between QoL outcomes. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r pairwise-correlation, fig.width=7, fig.height=7}
# correlations
cor <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")

# p-values
cor_pval <- function(df) {
  p_value_matrix <- matrix(NA, ncol(df), ncol(df))
  rownames(p_value_matrix) <- colnames(df)
  colnames(p_value_matrix) <- colnames(df)
  for (i in seq_along(df)) {
    for (j in seq_along(df)) {
      tmp <- cor.test(df[[i]], df[[j]])
      p_value_matrix[i, j] <- tmp$p.value
    }
  }
  return(p_value_matrix)
}
cor_p <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, tb_symp_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()

# Melt the correlation matrix into a long format
cor_melt <- rbind(
  melt(cor) %>% mutate(time = "Overall"),
  melt(cor_start) %>% mutate(time = "Start"),
  melt(cor_end) %>% mutate(time = "End"),
  melt(cor_post) %>% mutate(time = "Post")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c("Overall", "Start", "End", "Post"))
  )

cor_p_melt <- rbind(
  melt(cor_p) %>% mutate(time = "Overall"),
  melt(cor_p_start) %>% mutate(time = "Start"),
  melt(cor_p_end) %>% mutate(time = "End"),
  melt(cor_p_post) %>% mutate(time = "Post")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c("Overall", "Start", "End", "Post"))
  )

cor_rp_melt <- left_join(
  cor_melt,
  cor_p_melt,
  by = c("Var1", "Var2", "time")
) %>%
  rename(value = value.x, p = value.y) %>%
  mutate(
    p_star = ifelse(p < .001, "***",
      ifelse(p < .01, "**",
        ifelse(p < .05, "*", "")
      )
    ),
    lab = paste0(round(value, 2), p_star),
    # lab = ifelse(Var1 == Var2, "", lab),
    across(c(value, lab), ~ ifelse(as.integer(Var1) <= as.integer(Var2), NA, .x))
  )

cor_ov_pl <- ggplot(
  data = filter(cor_rp_melt, time == "Overall"),
  aes(x = Var1, y = Var2, fill = value)
) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Pearson Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_ov_pl,
  pdf_file = "results/outcome-overall-correlation.png",
  w = 12, h = 12
)
```

**Figure**: Pairwise correlations between QoL outcomes by time. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r correlation-overall, fig.width=10, fig.height=10}
# Create the heatmap
cor_pl <- ggplot(data = cor_rp_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  facet_wrap(~time) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Pearson Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_pl,
  pdf_file = "results/outcome-correlation.png",
  w = 12, h = 12
)
```

**Figure:** Proportion of patients with impaired QoL.

```{r proportions, fig.width=6.3, fig.height=3.9}
var_names <- c(
  "Y" = "Yes (impaired QoL)",
  "N" = "No (QoL not impaired)",
  "D" = "Death before visit",
  "L" = "Missing follow-up",
  "U" = "Unrecorded"
)

var_colors <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1]
)

qol_bin_comp <- qol %>%
  dplyr::select(all_of(c("time", "mfu", "death", names(outcome_bin)))) %>%
  melt(c("time", "mfu", "death")) %>%
  group_by(time, variable) %>%
  summarize(
    Y = sum(value, na.rm = TRUE),
    N = sum(value == 0, na.rm = TRUE),
    D = sum(death),
    U = sum(is.na(value) & !mfu & !death, na.rm = TRUE),
    L = sum(mfu, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  rename(outcome = variable) %>%
  melt(c("time", "outcome")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin),
    variable = recode(variable, !!!var_names),
    variable = factor(variable, levels = var_names)
  ) %>%
  group_by(time, outcome) %>%
  mutate(p = value / sum(value) * 100) %>%
  ungroup()

qol_bin_comp_pl <- ggplot(data = qol_bin_comp, mapping = aes(x = time, y = p)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack(reverse = TRUE)
  ) +
  geom_text(
    data = filter(qol_bin_comp, variable == "Yes (impaired QoL)"),
    mapping = aes(group = time, label = paste0(round(p))),
    vjust = -.5, size = 6 / cm(1),
    color = var_colors[1],
    show.legend = FALSE
  ) +
  scale_fill_manual(
    values = var_colors,
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment",
    fill = "a"
  ) +
  theme_custom() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.key.width = unit(.2, "cm"),
    legend.key.height = unit(.4, "cm")
  )

save_plot(
  qol_bin_comp_pl,
  pdf_file = "results/impaired-qol.png",
  w = 16, h = 10
)
```

#### Patient trajectories for depression

**Figure**: Trajectories of patients who were depressed (defined as PHQ9-S > 10) once during the study.

```{r depressed-flow, fig.width=6.3, fig.height=3.9}
var_names_dprs <- c(
  "Y" = "Depressed",
  "N" = "Not depressed",
  "D" = "Death before visit",
  "L" = "Missing follow-up",
  "U" = "Unrecorded"
)

var_colors_dprs <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1]
)

# create links
links_dprs <- qol %>%
  dplyr::select(
    time,
    record_id,
    ment_trt_yn,
    death,
    mfu,
    phq9_score_bin
  ) %>%
  rename(value = phq9_score_bin) %>%
  mutate(
    value =
      ifelse(death == 1 & is.na(value) & time != "Start", var_names_dprs["D"],
        ifelse(mfu, var_names_dprs["L"],
          ifelse(is.na(value), var_names_dprs["U"],
            ifelse(value == 1, var_names_dprs["Y"], var_names_dprs["N"])
          )
        )
      ),
    value = factor(value, levels = var_names_dprs),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No"),
    ment_trt_yn = factor(ment_trt_yn, levels = c("No", "Yes"))
  ) %>%
  # filter patients that were depressed at least once
  group_by(record_id) %>%
  filter(any(value == var_names_dprs["Y"])) %>%
  ungroup() %>%
  group_by(time, value) %>%
  mutate(freq = n()) %>%
  ungroup()

flow_dprs_pl <- links_dprs %>%
  ggplot(aes(
    x = time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = freq
  )) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(stat = "stratum", size = 8 / cm(1)) +
  scale_fill_manual(values = var_colors_dprs) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
  scale_x_discrete(labels = c("Start", "End", "Post")) +
  labs(x = "Treatment") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.title.y = element_blank()
  )

save_plot(
  flow_dprs_pl,
  pdf_file = "results/sankey-depressed.png",
  w = 16, h = 10
)
```

Remark:

- Note that none of the depressed patients received any mental health treatment during TB treatment.

## Imputation

We impute the missing values in the continuous QoL outcomes.
Outcomes missing because of death or missing follow-up visit will not be imputed, only unrecorded ones.
However, we consider subsequent death or missing follow-up visit as a predictor during imputation.
Similarly, we consider any adverse adverse event at the start of, end of, or post treatment as a predictor during imputation.

**Figure**: Imputation check for a random sample of 30 patients, showing the imputed majority label across datasets.

```{r imputation, fig.height=12}
# wide format
qol_fu <- qol %>%
  group_by(record_id) %>%
  arrange(time) %>%
  mutate(mfu_lead = lead(mfu), death_lead = lead(death)) %>%
  ungroup() %>%
  filter(!mfu & !death) %>%
  ungroup() %>%
  arrange(record_id, time) %>%
  mutate(
    across(
      c(
        mfu_lead, death_lead, ment_trt_yn,
        sex, hiv, mdr, cavity, tbd_pat_cat
      ),
      ~ factor(ifelse(.x == 1, "Yes", "No"), levels = c("No", "Yes"))
    )
  ) %>%
  dplyr::select(all_of(c(
    "record_id",
    "time",
    "site",
    "mfu_lead",
    "death_lead",
    "nf_ae",
    "ment_trt_yn",
    names(outcome_cont),
    names(predictor)
  )))

# imputation
n_datasets <- 10
qol_fu_imp <- mice(
  qol_fu[, -1],
  m = n_datasets,
  maxit = 10,
  seed = 12345,
  print = FALSE
)

# plot(qol_fu_imp, layout = c(2, 16))

# data
qol_fu_imp <- complete(qol_fu_imp, "long") %>%
  mutate(record_id = rep(qol_fu$record_id, times = n_datasets))

qol_fu_imp_mode <- qol_fu_imp %>%
  dplyr::select(all_of(c(".imp", "record_id", "time", names(outcome_cont)))) %>%
  melt(c(".imp", "record_id", "time")) %>%
  group_by(record_id, time, variable) %>%
  summarize(
    value = mean(value)
  ) %>%
  rename(imputed = value) %>%
  left_join(
    qol_fu %>%
      dplyr::select(all_of(c("record_id", "time", names(outcome_cont)))) %>%
      melt(c("record_id", "time")) %>%
      rename(observed = value),
    by = c("record_id", "time", "variable")
  ) %>%
  mutate(is_observed = ifelse(is.na(observed), FALSE, TRUE)) %>%
  rename(outcome = variable)

check_imp_pl <- qol_fu_imp_mode %>%
  group_by(record_id) %>%
  filter(any(!is_observed)) %>%
  ungroup() %>%
  filter(record_id %in% sample(unique(record_id), 30)) %>%
  ggplot(aes(
    y = time,
    x = outcome,
    color = is_observed,
    label = round(imputed)
  )) +
  geom_text(size = 8 / cm(1)) +
  facet_wrap(~record_id, ncol = 3) +
  labs(color = "Is observed") +
  scale_x_discrete(labels = function(x) outcome_cont) +
  scale_y_discrete(labels = function(x) c("Start", "End", "Post")) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

save_plot(
  check_imp_pl,
  pdf_file = "results/imputation-check.png",
  w = 16, h = 30
)
```


## Modeling

We model QoL as a multivariate outcome to consider correlation between the outcomes.
We model the log outcomes to make the results more interpretable and comparable.
Estimates differences in QoL over time are reported as the percent changes in QoL outcomes. 
Estimates associations are reported as percent change in QoL for a one-unit change in the predictor.
We report the median and 95% credible interval (CrI) of the posterior draws for each model parameter.

```{r model}
# prepare data
qol_mdat <- qol_fu_imp %>%
  dplyr::select(all_of(c(
    ".imp",
    "record_id",
    "time",
    "site",
    "mfu_lead",
    "death_lead",
    names(outcome_cont),
    names(predictor_sub)
  ))) %>%
  mutate(
    alc_bin = ifelse(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = ifelse(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = ifelse(age < 30, "Yes", "No"),
    across(
      c("mfu_lead", "death_lead", names(predictor_bin_sub)),
      ~ ifelse(.x == "Yes", 1, 0)
    )
  ) %>%
  dplyr::select(
    -age,
    -as_alc_calc,
    -as_tobacco_calc
  ) %>%
  mutate(
    across(c(all_of(names(outcome_cont))), log1p)
  ) %>%
  mutate(dummy = 1) %>%
  pivot_wider(names_from = site, values_from = dummy, values_fill = 0) %>%
  mutate(dummy = 1) %>%
  pivot_wider(names_from = time, values_from = dummy, values_fill = 0) %>%
  mutate(
    across(
      c(names(predictor_bin_sub)),
      ~ .x * End,
      .names = "{.col}_end"
    ),
    across(
      c(names(predictor_bin_sub)),
      ~ .x * Post,
      .names = "{.col}_post"
    )
  ) %>%
  dplyr::select(
    -`South Africa`,
    -`Start`,
    -mdr_end,
    -mdr_post
  )

for (i in unique(qol_mdat$.imp)) {
  qol_mdat %>%
    filter(.imp == i) %>%
    dplyr::select(
      -.imp, -record_id
    ) %>%
    write.csv(
      file = paste0("fitted-models/model-data/imp-data-", i, ".csv"),
      row.names = FALSE
    )
}

# ... run models in numpyro ... #

# collect posterior samples
mod_smpls <- data.frame(
  file = list.files("fitted-models/model-samples", full.names = TRUE)
) %>%
  mutate(
    imp = as.numeric(stringi::stri_extract(file, regex = "\\d")),
    data = lapply(file, read.csv)
  ) %>%
  unnest(data)
```

### QoL changes over time

**Figure**: Estimated change (median and 95%-CrI in %) in QoL outcomes at the end of and post treatment in comparison to start of treatment.

```{r modeled-qol-changes}
# plot
treat_effect_pl <- mod_smpls %>%
  filter(predictor %in% c("End", "Post")) %>%
  mutate(
    predictor = recode(predictor, End = "End vs Start", Post = "Post vs Start"),
    predictor = factor(predictor, levels = c("End vs Start", "Post vs Start")),
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont),
    beta = expm1(beta)
  ) %>%
  group_by(outcome, predictor) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ggplot(aes(x = median, y = outcome, color = predictor)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point(position = position_dodge(width = .66)) +
  geom_errorbarh(
    aes(xmin = lower, xmax = upper),
    position = position_dodge(width = .66),
    height = .25
  ) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  scale_color_manual(values = RColorBrewer::brewer.pal(name = "Set2", n = 3)[-1]) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_pl,
  pdf_file = "results/qol-changes.png",
  w = 8, h = 8
)
```

Interpretation:

- All QoL outcomes improved from the start to the end of treatment.
- Improvements post treatment were small.


### Sensitivity check for death and MFU patients

In the following, we estimate for each outcome the change in QoL that would be needed 
in patients who died or with missing follow-up visits 
to offset the estimated QoL changes in patients with follow-up visits.
Basically, what we compute is *-beta x (n_fu / n_nfu)* for each outcome,
where n_fu is the number of follow-up patients and n_nfu is the number of patients with missing follow-up or death.

**Figure:** Estimated change (posterior distribution; median and 95%-CrI in %) in QoL (grey) vs offsetting hypothetical change in QoL for patients with missing follow-up visits or death (red).

```{r sensitivity-check}
n_end <- n_distinct(qol$record_id[qol$time == "End"])
n_end_mfu <- sum(qol$mfu[qol$time == "End"])
n_end_death <- sum(qol$death[qol$time == "End"])
n_end_fu <- n_end - n_end_mfu - n_end_death
scale_fct <- 1

null_treat_effect_pl <- mod_smpls %>%
  filter(predictor == "End") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  mutate(beta = expm1(beta)) %>%
  mutate(
    n_nfu = n_end_mfu + n_end_death,
    n_fu = n_end_fu,
    beta_zero = -(n_fu / n_nfu) * beta
  ) %>%
  dplyr::select(outcome, beta_zero, beta) %>%
  melt("outcome") %>%
  mutate(
    group = ifelse(variable == "beta",
      "Follow-up patients (estimated)",
      "Missing follow-up/death (hypothetical)"
    ),
    group = factor(group, levels = c(
      "Follow-up patients (estimated)",
      "Missing follow-up/death (hypothetical)"
    ))
  ) %>%
  ggplot(aes(x = value, y = outcome, fill = group)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye() +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  scale_fill_manual(values = wes_palette("Royal1")) +
  labs(x = "Estimated change (%)") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

null_treat_effect_pl
```

Interpretation:

- The deterioration in QoL for patients with missing follow-up visits or death would need to be extremely large 
to offset the improvements at the end of treatment.
- It is unlikely that patients with missing follow-up have such diametrically different changes in QoL outcomes than patients with follow-up visits.


### Association with patient characteristics

We define significant associations as those with a 95% credible interval (CrI) not overlapping zero.
Since we report many associations, significant ones have to be interpreted with caution.
The reason is that with so many comparisons, we should expect some false positives.
We have also excluded the following predictors from the analysis due to collinearity and for simplicity:

- High bacterial load
- Cavity
- Relapse TB cases
- Continuous scores from the ASSIST Questionnaire for alcohol and tobacco use (only the binary variables were kept, see below).

The following predictors are transformed:

- Age: dichotomized into age < 30 and age >= 30.
- Drinker and Smoker: dichotomized into any alcohol or tobacco use denoted as an ASSIST score greater than zero.

We include time interaction effects for all predictors to estimate the association with baseline, end of treatment, and post treatment QoL. 

The following variables are also included:

- Subsequent MFU: To check whether missing follow-up is associated with QoL at baseline.
- Subsequent death: To check whether subsequent death is associated with QoL at baseline.

**Figure**: Estimated association (median and 95%-CrI in %) of QoL outcomes with patient characteristics. 

```{r association-by-outcome, fig.height=12, fig.width=10}
# plot associations of binary predictors
assoc <- rbind(
  mod_smpls %>%
    filter(predictor %in% names(predictor_bin_sub)) %>%
    mutate(time = "Start"),
  mod_smpls %>%
    filter(predictor %in% paste0(names(predictor_bin_sub), "_end")) %>%
    mutate(predictor = gsub("_end", "", predictor)) %>%
    mutate(time = "End"),
  mod_smpls %>%
    filter(predictor %in% paste0(names(predictor_bin_sub), "_post")) %>%
    mutate(predictor = gsub("_post", "", predictor)) %>%
    mutate(time = "Post")
) %>%
  pivot_wider(values_from = beta, names_from = time) %>%
  mutate(End = Start + End, Post = Start + Post) %>%
  pivot_longer(
    cols = c("Start", "End", "Post"),
    names_to = "time",
    values_to = "beta"
  ) %>%
  mutate(
    predictor = recode(predictor, !!!predictor_bin_sub),
    predictor = factor(predictor, levels = predictor_bin_sub),
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  filter(!(predictor == "MDR" & time %in% c("End", "Post")))

assoc_pl <- assoc %>%
  mutate(beta = expm1(beta)) %>%
  group_by(outcome, predictor, time) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  ungroup() %>%
  ggplot(aes(x = median, y = outcome, color = time)) +
  facet_wrap(~predictor, ncol = 3) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  geom_point(position = position_dodge(width = .66)) +
  geom_errorbarh(
    aes(xmin = lower, xmax = upper),
    position = position_dodge(width = .66),
    height = .25
  ) +
  labs(x = "Estimated change (%)") +
  scale_x_continuous(labels = scales::percent_format(suffix = "")) +
  scale_color_brewer(palette = "Set2") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  assoc_pl,
  pdf_file = "results/association.png",
  w = 16, h = 21
)
```

Interpretation: 

- The plot shows the estimated percent change in the QoL outcome for each binary predictor at each time point.
- For example, smoking was associated with a roughly 25% increase in the PHQ9-S score at the end of treatment, similar at start of and post treatment.
- Since there are many associatons, we subsequently summarize the probability that the predictors are associated with worse QoL outcomes overall and by category. 


**Figure** Probability (proportion of posterior draws in %) that predictors are associated with a decrease in overall QoL.

```{r assoc-prob-overall}
assoc_overall_pl <- assoc %>%
  mutate(beta = ifelse(
    outcome %in% c("PHQ9-S", "SGRQ-TS", "TB-SS"),
    -beta, beta
  )) %>%
  group_by(time, predictor) %>%
  summarise(prob = mean(expm1(beta) < 0)) %>%
  ungroup() %>%
  ggplot(aes(x = prob, y = predictor, fill = time)) +
  geom_bar(
    stat = "identity",
    position = position_dodge2(width = 1, padding = .1)
  ) +
  geom_text(
    aes(label = scales::percent(prob, accuracy = 1)),
    position = position_dodge2(width = 1, padding = .1),
    hjust = 1,
    size = 8 / cm(1)
  ) +
  labs(x = "Probability of a decrease in QoL (%)") +
  scale_x_continuous(
    labels = function(x) x * 100,
    limits = c(0, 1),
    expand = c(0, 0)
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  assoc_overall_pl,
  pdf_file = "results/association-prob-overall.png",
  w = 16, h = 16
)
```

Interpretation:

- Smoking was associated with a decrease in overall QoL with a probability of 94%, 91% and 82% at start of, end of and post treatment, respectively.
- MDR was not associated with overall QoL (probability around 50%).
- Drinking (85% probability) and HIV+ (92% probability) were only associated with a decrease in overall QoL at baseline.
- Female sex was associated with a decrease in overall QoL at start (83% probability) and end of treatment (90% probability).
- Probabilities smaller than 50% suggest a positive association with overall QoL (we just take the inverse). So, for example, age<30 was associated with an increase in overall QoL at start (75%) and end of treatment (probability 91%). 


**Figure:** Probability (proportion of posterior draws in %) that predictors are associated with a decrease in mental, physical or symptom scores.

```{r assoc-prob-category}
assoc_cat_pl <- assoc %>%
  mutate(
    beta = ifelse(
      outcome %in% c("PHQ9-S", "SGRQ-TS", "TB-SS"),
      -beta, beta
    ),
    category = ifelse(outcome %in% c("PHQ9-S", "SF12-MCS"),
      "Mental health scores", ifelse(outcome %in% c("SGRQ-TS", "TB-SS"),
        "TB symptom scores", "Physicial health scores"
      )
    ),
    category = factor(category, levels = c(
      "Mental health scores", "Physicial health scores", "TB symptom scores"
    ))
  ) %>%
  group_by(category, time, predictor) %>%
  summarise(prob = mean(expm1(beta) < 0)) %>%
  ungroup() %>%
  ggplot(aes(x = prob, y = predictor, fill = time)) +
  facet_wrap(~category, ncol = 3) +
  geom_bar(
    stat = "identity",
    position = position_dodge2(width = 1, padding = .1)
  ) +
  geom_text(
    aes(label = scales::percent(prob, accuracy = 1, suffix = "")),
    position = position_dodge2(width = 1, padding = .1),
    hjust = -.5,
    size = 6 / cm(1)
  ) +
  labs(x = "Probability of association with worse QoL (%)") +
  scale_x_continuous(
    labels = function(x) x * 100,
    limits = c(0, 1),
    breaks = seq(0, 1, .25),
    expand = expansion(add = c(0, 0.175))
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  assoc_cat_pl,
  pdf_file = "results/association-prob-by-category.png",
  w = 16, h = 16
)
```

Interpretation:

- By QoL category, we get a better understanding of the associations.
- For example, smoking was more strongly associated with worse mental and TB symptom scores.
- Female sex was more strongly associated with worse mental and physical scores at baseline and with physical and TB symptom scores at the end of treatment.
- Age<30 was more strongly associated with worse physical scores at the start and end of treatment.



**Table**: Estimated association of subsequent death with QoL.

```{r assoc-subsequent-death}
mod_smpls %>%
  filter(predictor == "death_lead") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarise(beta = expm1(beta)) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 1) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent death was associated with worse QoL outcomes, except for TB-SS.
- The strongest association was with the PHQ9-S score, i.e. subsequent death was associated with an increase of 42% (95%-CrI 18% to 72%) in the current PHQ9-S score.


**Table**: Estimated association of subsequent missing follow-up with QoL at baseline.

```{r assoc-subsequent-mfu}
mod_smpls %>%
  filter(predictor == "mfu_lead") %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont)
  ) %>%
  group_by(outcome) %>%
  summarize(
    median = median(beta),
    lower = quantile(beta, 0.025),
    upper = quantile(beta, 0.975)
  ) %>%
  mutate_if(is.numeric, scales::percent, accuracy = 1) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent missing follow-up was overall not strongly associated with QoL.
- Only a signification association with 6MWT-D was found, i.e. subsequent missing follow-up was associated with an decrease of 6% (95%-CrI 1% to 11%) in the current 6MWT distance.


### QoL impairement over time

**Figure**: Estimated proportion (in %) of patients with impaired QoL. Pr = Bayesian probability that the proportions are smaller at the end of and post treatment vs the start and end of treatment, respectively.

```{r model-qol-impairment, results = 'hide'}
# prepare data
qol_imp_bin <- qol_fu_imp %>%
  dplyr::select(
    .imp,
    record_id,
    time,
    names(outcome_cont)
  ) %>%
  mutate(
    phq9_score_bin = ifelse(phq9_score > 10, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    tb_symp_score_bin = ifelse(tb_symp_score > 4, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0)
  ) %>%
  group_by(.imp, time) %>%
  summarize(
    across(names(outcome_bin), sum),
    N = n()
  ) %>%
  melt(c(".imp", "time", "N")) %>%
  ungroup() %>%
  rename(n = value) %>%
  mutate(
    end = ifelse(time %in% c("End", "Post"), 1, 0),
    post = ifelse(time == "Post", 1, 0)
  ) %>%
  dplyr::select(-time) %>%
  nest(data = -.imp)

# run models
qol_bin_smpls <- tibble(
  outcome = c(),
  end_v_start = c(),
  post_v_end = c(),
)
for (out in names(outcome_bin)) {
  mod_out <- brm_multiple(
    formula = bf(
      n | trials(N) ~ end + post,
      family = binomial
    ),
    data = lapply(qol_imp_bin$data, function(x) filter(x, variable == out)),
    iter = 2000,
    warmup = 1000,
    chains = 1,
    cores = 1,
    seed = 12345,
    file = paste0("fitted-models/binary-models/", out, ".rds")
  )
  qol_bin_smpls_out <- tibble(
    outcome = out,
    end_v_start = unlist(posterior_samples(mod_out, "b_end")),
    post_v_end = unlist(posterior_samples(mod_out, "b_post"))
  )
  qol_bin_smpls <- rbind(qol_bin_smpls, qol_bin_smpls_out)
}
```

```{r qol-impairment-over-time, fig.width=7.9, fig.height=4}
# Bayesian posterior probability
qol_bin_pp <- qol_bin_smpls %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin)
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr" = value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
qol_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin)
  ) %>%
  arrange(outcome, time)

pval_ypos_end <- qol_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post <- qol_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos <- rbind(
  pval_ypos_end %>% mutate(time = "End"),
  pval_ypos_post %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_comp <- qol_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = qol_bin_pp,
    y_position = pval_ypos,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6, 6.75, 7),
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25, 7, 7.25),
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)", x = "Pericardial changes") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_comp,
  pdf_file = "results/qol-impairment-prevalence-by-time.pdf",
  w = 20, h = 10
)
```

Intepretation:

- Prevalence of impaired QoL decreased from the start to the end of treatment for all outcomes.
- Prevalene decreased further post treatment for physical scores and TB symptom scores.
- Mental scores (PHQ9-S and SF12-MCS) did not decrease further, but there was only little potential for improvement because they were already low at the end of treatment. 


### Non-improvers

We are primarily interested in patients whose QoL did not improve through anti-TB treatment. 
To investigate, we standardise each score and compute the total change between start and end and between post and end of treatment.
PHQ9 score and TB symptom scores have been multiplied by -1 so that a negative change indicates deteroration as well. 
We compute the total change across types of scores, i.e. mental health, physical health, and TB symptom scores.


**Figure**: Total change in standardised scores between start and end and between post and end of anti-TB treatment.
Dots shows the total change, stacked bars show the change for each individual score. Imputed data as has been averaged.

```{r non-improvers-treatment, fig.width=6.3, fig.height=8.3}
# compute standardised changes by score types
total_change <- function(data, times = c("Start", "End")) {
  qol_fu_imp %>%
    mutate(mutate(across(c(phq9_score, sgrq_tot_score, tb_symp_score), ~ .x * (-1)))) %>%
    mutate(across(matches(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))) %>%
    group_by(record_id, .imp) %>%
    arrange(time) %>%
    summarise(
      across(matches(names(outcome_cont)), ~ .x[time == times[2]] - .x[time == times[1]]),
      across(matches(names(predictor_sub)), ~ .x[time == "Start"])
    ) %>%
    ungroup() %>%
    filter(!is.na(phq9_score)) %>%
    mutate(
      alc_bin = ifelse(as_alc_calc > 0, "Yes", "No"),
      tobacco_bin = ifelse(as_tobacco_calc > 0, "Yes", "No"),
      age_bin = ifelse(age < 30, "Yes", "No"),
      across(
        c(names(predictor_bin_sub)),
        ~ ifelse(.x == "Yes", 1, 0)
      ),
      ment_sum = phq9_score + sf12_ment,
      phys_sum = sf12_phys + smwt_dist + stst_nr,
      symp_sum = sgrq_tot_score + tb_symp_score,
      qol_sum = rowSums(across(matches(names(outcome_cont))))
    )
}

qol_fu_tc <- total_change(qol_fu_imp, c("Start", "End"))
qol_fu_pt <- total_change(qol_fu_imp, c("End", "Post"))

# compute average across imputed datasets
qol_fu_tc_mean <- qol_fu_tc %>%
  group_by(record_id) %>%
  summarise(across(c(matches("_sum"), matches(names(outcome_cont))), mean)) %>%
  ungroup()
qol_fu_pt_mean <- qol_fu_pt %>%
  group_by(record_id) %>%
  summarise(across(c(matches("_sum"), matches(names(outcome_cont))), mean)) %>%
  ungroup()

# generate plots
y_lim <- c(
  rbind(
    qol_fu_tc_mean %>% dplyr::select(ment_sum, phys_sum, symp_sum),
    qol_fu_pt_mean %>% dplyr::select(ment_sum, phys_sum, symp_sum)
  ) %>%
    sapply(min) %>%
    min(),
  rbind(
    qol_fu_tc_mean %>% dplyr::select(ment_sum, phys_sum, symp_sum),
    qol_fu_pt_mean %>% dplyr::select(ment_sum, phys_sum, symp_sum)
  ) %>%
    sapply(max) %>%
    max()
)
x_lab <- "Patient"
y_lab <- "Total change in standardised scores"
theme_adaptions <- theme(
  legend.position = c(0.6, 0.1),
  legend.direction = "horizontal",
  legend.key.width = unit(0.1, "cm"),
  legend.key.height = unit(0.2, "cm"),
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  legend.title = element_blank()
)
annotate_change_pl <- function(pl, n, N, ttl, col) {
  p <- round(100 * (n / N))
  x_a <- n + 0.01 * N
  x_at <- n + 0.05 * N
  x_b <- 0.8 * N
  pl +
    geom_vline(
      aes(xintercept = n),
      linetype = "dashed"
    ) +
    geom_segment(
      aes(x = x_a, xend = x_b, y = y_lim[2] - 1.5),
      arrow = arrow(length = unit(0.3, "cm"))
    ) +
    annotate("text",
      x = x_at, y = y_lim[2] - .5,
      label = paste0("Improvers: ", 100 - p, "%"),
      size = 8 / cm(1), hjust = 0
    ) +
    labs(x = x_lab, y = y_lab, title = ttl) +
    scale_fill_manual(values = rainbow(10)[col]) +
    scale_y_continuous(limits = y_lim) +
    theme_custom() +
    theme_adaptions
}

n_ment_noni <- sum(qol_fu_tc_mean$ment_sum < 0)
mental_health_change_pl <- qol_fu_tc_mean %>%
  dplyr::select(record_id, ment_sum, phq9_score, sf12_ment) %>%
  melt(c("record_id", "ment_sum")) %>%
  mutate(variable = recode(variable, !!!outcome_cont)) %>%
  ggplot(aes(x = reorder(record_id, ment_sum), y = value)) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack()
  ) +
  geom_point(aes(y = ment_sum), size = .5)
mental_health_change_pl <- annotate_change_pl(
  mental_health_change_pl,
  n_ment_noni, nrow(qol_fu_tc_mean), "Mental health", 1:2
)

n_phys_noni <- sum(qol_fu_tc_mean$phys_sum < 0)
physical_health_change_pl <- qol_fu_tc_mean %>%
  dplyr::select(record_id, phys_sum, sf12_phys, smwt_dist, stst_nr) %>%
  melt(c("record_id", "phys_sum")) %>%
  mutate(variable = recode(variable, !!!outcome_cont)) %>%
  ggplot(aes(x = reorder(record_id, phys_sum), y = value)) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack()
  ) +
  geom_point(aes(y = phys_sum), size = .5)
physical_health_change_pl <- annotate_change_pl(
  physical_health_change_pl,
  n_phys_noni, nrow(qol_fu_tc_mean), "Physical health", c(3, 5, 7)
)

n_symp_noni <- sum(qol_fu_tc_mean$symp_sum < 0)
symptom_change_pl <- qol_fu_tc_mean %>%
  dplyr::select(record_id, symp_sum, sgrq_tot_score, tb_symp_score) %>%
  melt(c("record_id", "symp_sum")) %>%
  mutate(variable = recode(variable, !!!outcome_cont)) %>%
  ggplot(aes(x = reorder(record_id, symp_sum), y = value)) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack()
  ) +
  geom_point(aes(y = symp_sum), size = .5)
symptom_change_pl <- annotate_change_pl(
  symptom_change_pl,
  n_symp_noni, nrow(qol_fu_tc_mean), "Symptoms", 9:10
)

n_ment_post_noni <- sum(qol_fu_pt_mean$ment_sum < 0)
mental_health_postchange_pl <- qol_fu_pt_mean %>%
  dplyr::select(record_id, ment_sum, phq9_score, sf12_ment) %>%
  melt(c("record_id", "ment_sum")) %>%
  mutate(variable = recode(variable, !!!outcome_cont)) %>%
  ggplot(aes(x = reorder(record_id, ment_sum), y = value)) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack()
  ) +
  geom_point(aes(y = ment_sum), size = .5)
mental_health_postchange_pl <- annotate_change_pl(
  mental_health_postchange_pl,
  n_ment_post_noni, nrow(qol_fu_pt_mean), "Mental health", 1:2
) +
  theme(
    legend.position = "none",
    plot.title = element_blank()
  )

n_phys_post_noni <- sum(qol_fu_pt_mean$phys_sum < 0)
physical_health_postchange_pl <- qol_fu_pt_mean %>%
  dplyr::select(record_id, phys_sum, sf12_phys, smwt_dist, stst_nr) %>%
  melt(c("record_id", "phys_sum")) %>%
  mutate(variable = recode(variable, !!!outcome_cont)) %>%
  ggplot(aes(x = reorder(record_id, phys_sum), y = value)) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack()
  ) +
  geom_point(aes(y = phys_sum), size = .5)
physical_health_postchange_pl <- annotate_change_pl(
  physical_health_postchange_pl,
  n_phys_noni, nrow(qol_fu_pt_mean), "Physical health", c(3, 5, 7)
) +
  theme(
    legend.position = "none",
    plot.title = element_blank()
  )

n_symp_noni <- sum(qol_fu_pt_mean$symp_sum < 0)
symptom_postchange_pl <- qol_fu_pt_mean %>%
  dplyr::select(record_id, symp_sum, sgrq_tot_score, tb_symp_score) %>%
  melt(c("record_id", "symp_sum")) %>%
  mutate(variable = recode(variable, !!!outcome_cont)) %>%
  ggplot(aes(x = reorder(record_id, symp_sum), y = value)) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack()
  ) +
  geom_point(aes(y = symp_sum), size = .5)
symptom_postchange_pl <- annotate_change_pl(
  symptom_postchange_pl,
  n_symp_noni, nrow(qol_fu_pt_mean), "Symptoms", 9:10
) +
  theme(
    legend.position = "none",
    plot.title = element_blank()
  )

col_lab_1 <- wrap_elements(
  panel = textGrob("a | End vs Start",
    gp = gpar(fontface = "bold")
  )
)
col_lab_2 <- wrap_elements(
  panel = textGrob("b | Post vs End",
    gp = gpar(fontface = "bold")
  )
)

treat_change_pl <- col_lab_1 + col_lab_2 +
  mental_health_change_pl + mental_health_postchange_pl +
  physical_health_change_pl + physical_health_postchange_pl +
  symptom_change_pl + symptom_postchange_pl +
  plot_layout(ncol = 2, heights = c(.1, 1, 1, 1))

save_plot(
  treat_change_pl,
  pdf_file = "results/treat-change-by-patient.png",
  w = 16, h = 21
)
```

Interpretation:

- There are only few patients whose scores deteriorate between end and start of treatment. 
- Therare are more patients whose scores deteriorate between post and end of treatment. 
- For mental and physical health scores, the proportion of patients who deteriorate is generally larger than for TB symptom scores.


### Association with non-improvement

We dichotonomise the changes into improvement (positive change) and deterioration (negative change). 
We estimate the association of deterioration with patient characteristics.


**Figure:** Estimated association of deterioration in mental health, physical health or TB treatment scores 
between end and start and between post and end of anti-TB treatment
with patient characteristics.
Median odds ratio (OR) as dotes, 95%-CrI as whiskers. MDR was excluded post treatment because of too few cases.

```{r non-improvers-treatment-association, fig.width=6.3, fig.height=4.7}
create_formula <- function(outcome) {
  as.formula(
    paste(outcome, "~", "age_bin + sex + hiv + mdr + alc_bin + tobacco_bin")
  )
}

bin_dat_list <- function(data, outcome) {
  data %>%
    mutate(across(outcome, ~ ifelse(.x < 0, 1, 0))) %>%
    split(.$.imp)
}

est_models <- function(mod_form, stan_data) {
  brm_multiple(
    mod_form,
    data = stan_data,
    family = bernoulli(link = "logit"),
    recompile = FALSE,
    cores = 4,
    seed = 12345,
    backend = "rstan",
    open_progress = FALSE
  )
}

treat_ment_mod <- est_models(
  create_formula("ment_sum"),
  bin_dat_list(qol_fu_tc, "ment_sum")
)

treat_phys_mod <- est_models(
  create_formula("phys_sum"),
  bin_dat_list(qol_fu_tc, "phys_sum")
)

treat_symp_mod <- est_models(
  create_formula("symp_sum"),
  bin_dat_list(qol_fu_tc, "symp_sum")
)

posttreat_ment_mod <- est_models(
  create_formula("ment_sum"),
  bin_dat_list(qol_fu_pt, "ment_sum")
)

posttreat_phys_mod <- est_models(
  create_formula("phys_sum"),
  bin_dat_list(qol_fu_pt, "phys_sum")
)

posttreat_symp_mod <- est_models(
  create_formula("symp_sum"),
  bin_dat_list(qol_fu_pt, "symp_sum")
)

treat_mod_draws <- rbind(
  treat_ment_mod %>%
    spread_draws(b_age_bin, b_sex, b_hiv, b_mdr, b_alc_bin, b_tobacco_bin) %>%
    mutate(outcome = "Mental health", comparison = "End vs Start"),
  treat_phys_mod %>%
    spread_draws(b_age_bin, b_sex, b_hiv, b_mdr, b_alc_bin, b_tobacco_bin) %>%
    mutate(outcome = "Physical health", comparison = "End vs Start"),
  treat_symp_mod %>%
    spread_draws(b_age_bin, b_sex, b_hiv, b_mdr, b_alc_bin, b_tobacco_bin) %>%
    mutate(outcome = "TB symptoms", comparison = "End vs Start"),
  posttreat_ment_mod %>%
    spread_draws(b_age_bin, b_sex, b_hiv, b_mdr, b_alc_bin, b_tobacco_bin) %>%
    mutate(outcome = "Mental health", comparison = "Post vs End"),
  posttreat_phys_mod %>%
    spread_draws(b_age_bin, b_sex, b_hiv, b_mdr, b_alc_bin, b_tobacco_bin) %>%
    mutate(outcome = "Physical health", comparison = "Post vs End"),
  posttreat_symp_mod %>%
    spread_draws(b_age_bin, b_sex, b_hiv, b_mdr, b_alc_bin, b_tobacco_bin) %>%
    mutate(outcome = "TB symptoms", comparison = "Post vs End")
) %>%
  melt(c(".iteration", ".chain", ".draw", "outcome", "comparison")) %>%
  mutate(or = exp(value)) %>%
  rename(predictor = variable) %>%
  mutate(
    predictor = gsub("b_", "", predictor),
    predictor = recode(predictor, !!!predictor_bin_sub)
  ) %>%
  group_by(outcome, predictor, comparison) %>%
  summarize(
    median = median(or),
    lower = quantile(or, 0.025),
    upper = quantile(or, 0.975)
  ) %>%
  ungroup() %>%
  filter(!(predictor == "MDR" & comparison == "Post vs End")) # too few cases

treat_ment_pl <- treat_mod_draws %>%
  ggplot(aes(x = median, y = predictor, color = outcome)) +
  facet_wrap(~comparison, ncol = 3) +
  geom_vline(aes(xintercept = 1), linetype = "dotted", color = "red") +
  geom_point(position = position_dodge(width = .66)) +
  geom_errorbarh(
    aes(xmin = lower, xmax = upper),
    position = position_dodge(width = .66),
    height = .25
  ) +
  labs(x = "Odds ratio") +
  scale_color_manual(values = rainbow(10)[c(1, 6, 9)]) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  treat_ment_pl,
  pdf_file = "results/treat-deteroration-association.png",
  w = 16, h = 12
)
```

Interpretation:

- Patient characteristics are not really associated with deterioration. 
- At most, deterioration in mental scores post vs end of treatment is less likely for HIV+ patients. 
- Deterioration in physical scores and TB symptom scores post vs end of treatment tends to be more likely for HIV+ patients.
