---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "..")
```

```{r libraries, include=FALSE}
library(tidyverse)
library(reshape2)
library(rstanarm)
library(brms)
library(rstan)
library(tidybayes)
library(mice)
library(klaR)
source("utils/plotting.R")
source("utils/summaries.r")
```


## Data

We analyze the quality of life (QoL) outcomes of tuberculosis (TB) patients 
at the start of, end of, and post anti-TB treatment in IeDEA-SA cohorts:
South Africa, Malawi, Mozambique, Zambia, and Zimbabwe.
The  data is as of Sep 24, 2024.


```{r data, include=FALSE}
# data of patients with at least one outcome
qol <- readRDS("data-clean/phys-ment-data.rds") %>%
  arrange(time, record_id) %>%
  # cutoffs
  mutate(
    phq9_score_bin = ifelse(phq9_score >= 7, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0)
  )


qol_start <- filter(qol, time == "Start")
qol_end <- filter(qol, time == "End")
qol_post <- filter(qol, time == "Post")

# labeling
outcome_cont <- c(
  "phq9_score" = "PHQ-9",
  "sf12_ment" = "SF12-MCS",
  "sf12_phys" = "SF12-PCS",
  "smwt_dist" = "6MWT",
  "stst_nr" = "STST",
  "sgrq_tot_score" = "SGRQ"
)
outcome_cont2 <- outcome_cont
names(outcome_cont2) <- gsub("_", "", names(outcome_cont))

outcome_bin <- c(
  "phq9_score_bin" = "PHQ-9\u22657",
  "sf12_ment_bin" = "SF12-MCS<42",
  "sf12_phys_bin" = "SF12-PCS<50",
  "smwt_dist_bin" = "6MWT<400m",
  "stst_nr_bin" = "STST<20",
  "sgrq_tot_score_bin" = "SGRQ>25"
)
outcome_bin2 <- outcome_bin
names(outcome_bin2) <- gsub("_", "", names(outcome_bin))

predictor <- c(
  "age" = "Age",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "History of TB",
  "as_alc_calc" = "Alcohol score",
  "as_tobacco_calc" = "Tobacco score"
)
predictor_bin <- c(
  "age_bin" = "Age<30",
  "sex" = "Female",
  "hiv" = "HIV+",
  "highbact" = "High bact. load",
  "mdr" = "MDR",
  "cavity" = "Cavitation",
  "tbd_pat_cat" = "History of TB",
  "alc_bin" = "Drinking",
  "tobacco_bin" = "Smoking"
)

predictor_sub <- predictor[-c(4, 6)]
predictor_bin_sub <- predictor_bin[-c(4, 6)]

treat_effect_lab <- c("End vs Start treatment", "Post vs End treatment")
```

**Outcomes**:

The quality of life **(QoL)** outcomes:

* PHQ9-S: Patient Health Questionnaire 9 - Score (Range: 0-27; lower scores are better)
* SF12-MCS: Short form survey (SF12) - Mental Component Score (Range: 0-100; higher scores are better)
* SF12-PCS: Short form survey (SF12) - Physical Component Score (Range: 0-100; higher scores are better)
* 6MWT-D: 6 Minute Walk Test - Distance (longer distances are better)
* STST-R: Sit-to-Stand Test - Number of Repetitions (more repititions are better)
* SGRQ-S: St. George's Respiratory Questionnaire - Total Score (Range: 0-100; lower scores are better)
* ~~TB-SS: TB - Symptom Score (Range: 0-9)~~

We define impaired QoL per outcome as:

1. PHQ9-S ≥ 7
2. SF12-MCS < 42
3. SF12-PCS < 50
4. 6MWT-D < 400m
5. STST-R < 20
6. SGRQ-TS > 25
7. ~~TB-SS > 4~~

Note that later, during modelling, we transform PHQ9-S and SGRQ-S so that for all outcomes positive changes mean improvement.

**Exclusion:**

We do not impute or analyse observations where we still wait for the next clinical visit.
That is, end of treatment or post treatment is still within 8mo since last visit.

**Missing observations**:

The outcomes can be missing for one of the following reasons:

1. *Pending visit*: We still wait for the next clinical visit.
2. *Death*: The patient died during or post treatment.
3. *Missing follow-up* (MFU): Missing QoL outcome because there was no follow-up visit.
4. *Unrecorded*: One or more QoL outcomes were not recorded.

Pending visit data will not be imputed, other missings (death, MFU, unrecorded) will be. 

**Patient characteristics**:

The predictors we consider are:

1. Age
2. Sex
3. HIV test result
4. ~~High bacterial load~~
5. Multi-drug resistant TB (MDR-TB)
6. ~~Cavitation~~
7. Relapse instead of new TB case
8. ASSIST alcohol score
9. ASSIST tobacco score

Age and ASSIST scores will be further dichotomized during modeling analysis. 

**Additional variables::**

We further consider:

1. Any serious but non-fatal adverse event (AE) during treatment: 

* Life-threatining.
* Requires in-patient hospitalization or prolongation of existing hospitalization.
* Results in persistent or significant disability/incapacity.
* Results in congenital anomaly/birth defect.
* Other important medical event that may not be immediately life-threatening or result in death, or require hospitalisation, but may jeopardise the participant or may require intervention to prevent one of the other outcomes listed above.

2. Any mental health treatment (therapy or medication) since last visit:

* Mental health counselling, psychiatric medication, or hospital admission for mental illness.
* Treatment from a traditional healer for mental illness.
* Treatment from an outpatient health department (outpatient) for mental illness.
* Admission to a hospital or other health institution (inpatient) at least for one night for the treatment of mental illness
* Any medication for a mental illness.

3. TB treatment outcome:

* The outcome of the last TB treatment. 
* Can be categorized into successful (cured) or unsuccessful (failed, death).

Almost all TB treatment failures are death, therefore we do not model TB treatment outcome further.

&nbsp;

## Descriptives

### Study population

**Table 1**: Number and proportion of visits, missing visits, deceased patients, and pending visits over time.

```{r sample}
qol %>%
  group_by(time) %>%
  summarise(
    N = sum(!wfu & !mfu & !death),
    MFU = sum(mfu),
    Death = sum(death),
    WFU = sum(wfu)
  ) %>%
  ungroup() %>%
  mutate(
    Total = N + MFU + Death + WFU,
    N = paste0(N, " (", round(100 * N / Total), "%)"),
    MFU = paste0(MFU, " (", round(100 * MFU / Total), "%)"),
    Death = paste0(Death, " (", round(100 * Death / Total), "%)"),
    WFU = paste0(WFU, " (", round(100 * WFU / Total), "%)")
  ) %>%
  dplyr::select(-Total) %>%
  set_names(c(
    "Time",
    "Visit",
    "Missing visit",
    "Deceased",
    "Pending visit"
  )) %>%
  knitr::kable()
```

**Table 2**: Number and proportion of patients per site.

```{r sites}
qol_start %>%
  group_by(site) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  mutate(Proportion = round(Count / sum(Count) * 100)) %>%
  knitr::kable(align = "lrr")
```

**Table 3**: Patient characteristics at baseline.

```{r predictors}
qol_start %>%
  dplyr::select(all_of(names(predictor_sub))) %>%
  gather() %>%
  mutate(
    key = recode(key, !!!predictor_sub),
    key = factor(key, levels = predictor_sub)
  ) %>%
  group_by(key) %>%
  summarize_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  arrange(key) %>%
  set_names(c("Variable", "Summary")) %>%
  knitr::kable(align = "lr")
```

&nbsp;

```{r baseline}
base_df <- qol_start %>%
  mutate(
    smoking = ifelse(as_tobacco_calc > 0, 1, 0),
    drinking = ifelse(as_alc_calc > 0, 1, 0),
    across(c(mdr, cavity, highbact, smoking, drinking, hiv_viral_load), ~
      factor(
        ifelse(.x == 0, "No", "Yes"),
        levels = c("Yes", "No")
      )),
    tbd_pat_cat = factor(
      ifelse(tbd_pat_cat == 1, "Relapse", "New case"),
      levels = c("Relapse", "New case")
    ),
    hiv = factor(
      ifelse(is.na(hiv), "Unknown", ifelse(hiv == 1, "Positive", "Negative")),
      levels = c("Positive", "Negative", "Unknown")
    ),
    sex = factor(
      ifelse(sex == 1, "Female", "Male"),
      levels = c("Female", "Male")
    )
  ) %>%
  dplyr::select(
    record_id,
    site,
    age,
    sex,
    tbd_pat_cat,
    tbd_diagnosis,
    mdr,
    hiv,
    hiv_cd4_mm3_nr,
    hiv_viral_load,
    hiv_viral_load_nr,
    cavity,
    highbact,
    obesity,
    smoking,
    drinking
  ) %>%
  left_join(
    qol %>%
      filter(time %in% c("End", "Post")) %>%
      group_by(site, record_id) %>%
      summarise(ment = ifelse(
        all(is.na(ment_trt_yn)), "Unknown", ifelse(
          any(ment_trt_yn == 1, na.rm = TRUE), "Yes", "No"
        )
      )) %>%
      ungroup() %>%
      mutate(ment = factor(ment, levels = c("Yes", "No", "Unknown"))),
    by = c("site", "record_id")
  ) %>%
  dplyr::select(-record_id)

var_names <- c(
  "age" = "Age",
  "sex" = "Sex",
  "tbd_pat_cat" = "Type of case",
  "tbd_diagnosis" = "TB manifestation",
  "mdr" = "Multi-drugresistance",
  "hiv" = "HIV status",
  "hiv_cd4_mm3_nr" = "CD4 cell count",
  "hiv_viral_load" = "Detectable HIV viral load",
  "hiv_viral_load_nr" = "HIV viral load",
  "highbact" = "High bacterial load",
  "cavity" = "Cavitation",
  "obesity" = "BMI",
  "smoking" = "Smoking",
  "drinking" = "Drinking",
  "ment" = "Mental treatment"
)

base_tbl <- list()
for (v in colnames(base_df)[-1]) {
  if (is.numeric(base_df[[v]])) {
    cty <- var_names[v]
  } else {
    cty <- levels(base_df[[v]])
  }
  values <- matrix(
    NA,
    nrow = length(cty),
    ncol = 3 + n_distinct(base_df$site),
    dimnames = list(
      cty,
      c("Variable", "Category", "All", levels(base_df$site))
    )
  )
  values[, 1] <- v
  values[, 2] <- cty
  for (s in c("All", levels(base_df$site))) {
    if (s == "All") {
      sub <- levels(base_df$site)
    } else {
      sub <- s
    }
    if (cty[1] == var_names[v]) {
      values[cty, s] <- paste0(
        round(median(base_df[[v]][base_df$site %in% sub], na.rm = TRUE)),
        " (IQR ",
        round(quantile(base_df[[v]][base_df$site %in% sub], .25, na.rm = TRUE)),
        " - ",
        round(quantile(base_df[[v]][base_df$site %in% sub], .75, na.rm = TRUE)),
        ")"
      )
    } else {
      n_c <- table(base_df[[v]][base_df$site %in% sub])
      N_c <- sum(n_c)
      for (c in cty) {
        values[c, s] <- paste0(
          n_c[c],
          "/",
          N_c,
          " (",
          round(n_c[c] / N_c * 100, 0),
          "%)"
        )
      }
    }
  }
  base_tbl[[v]] <- values
}

do.call(rbind, base_tbl) %>%
  as.data.frame() %>%
  `rownames<-`(NULL) %>%
  mutate(
    Variable = recode(Variable, !!!var_names)
  ) %>%
  knitr::kable(align = "llrrrrr")
```

**Table 4**: Distribution of patient characteristics by time of patients with visits.

```{r}
qol %>%
  filter(!mfu, !death, !wfu) %>%
  mutate(
    age_bin = ifelse(age < 30, 1, 0),
    alc_bin = ifelse(as_alc_calc > 0, 1, 0),
    tobacco_bin = ifelse(as_tobacco_calc > 0, 1, 0)
  ) %>%
  dplyr::select(all_of(c("time", names(predictor_bin)))) %>%
  melt("time") %>%
  mutate(variable = recode(variable, !!!predictor_bin)) %>%
  group_by(time, variable) %>%
  summarise_all(
    ~ ifelse(max(.x, na.rm = TRUE) > 1, median_iqr(.x), count_bin(.x))
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = time, values_from = value) %>%
  rename(Variable = variable) %>%
  knitr::kable(align = "lrrr")
```

Note: 

- Few MDR patients at baseline, proportionally even less at the end of anti-TB treatment and post treatment.
- Lower prevalence of alcohol and tobacco use at the end of treatment (but not post treatment) compared with baseline. 
- Strangely also proportionally many more missings in the alcohol and tobacco score at the end of treatment.

&nbsp;

**Table 5**: Number of patients with non-fatal serious adverse events (AE). 

```{r no-adverse-events}
qol %>%
  group_by(time) %>%
  summarize(
    n_tot = sum(nf_ae == 1, na.rm = TRUE),
    n_only = sum(nf_ae == 1 & !death & !mfu, na.rm = TRUE),
    n_died = sum(nf_ae == 1 & death, na.rm = TRUE),
    n_mfu = sum(nf_ae == 1 & mfu, na.rm = TRUE)
  ) %>%
  set_names(c("Time", "Total AE", "Only AE", "AE and death", "AE and MFU")) %>%
  knitr::kable(align = "lrrrr")
```

Note:

- Roughly a third of patients with any AE also died.
- Few patients with AE have missing follow-up visits.

&nbsp;

**Table 6**: Number and proportion of patients who received mental health treatments. 

```{r no-mental-health-treatment}
qol %>%
  group_by(time) %>%
  summarize(
    `No. of patients` = sum(ment_trt_yn == 1, na.rm = TRUE),
    `Proportion` = paste0(round(sum(ment_trt_yn == 1, na.rm = TRUE) / n() * 100), "%")
  ) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

Note:

- Very few patients received mental health treatment, most of them at the end of anti-TB treatment.
- Internal check showed that treatment outcome was success for all patients who received mental health treatment.

&nbsp;

**Table 7**: List of visits of patients receiving mental health treatment, their mental health outcomes (PHQ9-S and SF12-MCS) and whether they died or had missing follow-up visits.

```{r list-mental-health-treatment}
qol %>%
  group_by(record_id) %>%
  filter(any(ment_trt_yn == 1)) %>%
  ungroup() %>%
  dplyr::select(record_id, time, phq9_score, sf12_ment, death, mfu, ment_trt_yn) %>%
  mutate(
    death = ifelse(death, "Yes", "No"),
    mfu = ifelse(mfu, "Yes", "No"),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No")
  ) %>%
  mutate(sf12_ment = round(sf12_ment)) %>%
  arrange(record_id, time) %>%
  set_names(c("Record ID", "Time", "PHQ9-S", "SF12-MCS", "Death", "MFU", "Mental health treat.")) %>%
  knitr::kable(align = "llrrrr")
```

**Table 8**: TB Treatment outcomes.

```{r tb-treatment-outcomes}
qol %>%
  filter(time == "End") %>%
  mutate(eot_outcome = case_when(
    eot_outcome == 1 ~ "Cured",
    eot_outcome == 2 ~ "Treatment completed",
    eot_outcome == 3 ~ "Treatment failed",
    eot_outcome == 4 ~ "Died",
    eot_outcome == 5 ~ "Lost to follow-up",
    eot_outcome == 6 ~ "Transferred out from study site",
    eot_outcome == 99 ~ "Not known",
    is.na(eot_outcome) ~ "Not available"
  )) %>%
  mutate(eot_outcome = factor(eot_outcome, levels = c(
    "Cured",
    "Treatment completed",
    "Treatment failed",
    "Died",
    "Lost to follow-up",
    "Transferred out from study site",
    "Not known",
    "Not available"
  ))) %>%
  group_by(eot_outcome) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(p = round(n / sum(n) * 100)) %>%
  dplyr::select(eot_outcome, n, p) %>%
  set_names(c("Anti-TB treatment outcome", "No. of patients", "Proportion")) %>%
  knitr::kable(align = "lrr")
```

Note:

- Almost all treatment failures are death, therefore TB treatment outcome is currently not considered in subsequent modeling analyses.

&nbsp;

### Outcomes

#### Summary

**Table 9**: QoL scores at the start of anti-TB treatment.

```{r summaries-1}
# start of treatment
qol_start %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR)")) %>%
  knitr::kable(align = "lr")
```

**Table 10**: QoL scores at the end of anti-TB treatment.

```{r summaries-2}
# end of treatment
qol_end %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR)")) %>%
  knitr::kable(align = "lr")
```

**Table 11**: QoL scores post anti-TB treatment.

```{r summaries-3}
# post treatment
qol_post %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  gather() %>%
  group_by(key) %>%
  summarize(median_and_iqr = median_iqr(value)) %>%
  ungroup() %>%
  mutate(
    key = recode(key, !!!outcome_cont),
    key = factor(key, levels = outcome_cont)
  ) %>%
  arrange(key) %>%
  set_names(c("Outcome", "Median (IQR)")) %>%
  knitr::kable(align = "lr")
```

#### Distribution

**Figure 1**: QoL scores by time.

```{r qol-outcomes-boxplot-by-time, fig.height=6.3, fig.width=6.3}
qol_boxplot <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  mutate(
    outcome_cat = ifelse(
      outcome %in% c("PHQ9-S", "SF12-MCS"),
      "Mental health outcomes",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"),
        "Physical health outcomes", "TB symptoms scores"
      )
    ),
    outcome_cat = factor(outcome_cat, levels = c(
      "Mental health outcomes", "Physical health outcomes", "TB symptoms scores"
    ))
  ) %>%
  ggplot(aes(y = value, x = time, fill = time)) +
  facet_wrap(~outcome, scales = "free_y", ncol = 3) +
  geom_boxplot() +
  labs(y = "Score value", x = "Treatment") +
  scale_fill_brewer(palette = "Set2") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

save_plot(
  qol_boxplot,
  pdf_file = "results/outcome-boxplot.png",
  w = 16, h = 16
)
```

**Figure 2**: Histogram of QoL scores by time.

```{r histogram-by-time, fig.width=6.3, fig.height=8.7}
qol_denesity <- qol %>%
  dplyr::select(all_of(c("time", names(outcome_cont)))) %>%
  melt("time") %>%
  rename(outcome = variable) %>%
  mutate(outcome = recode(outcome, !!!outcome_cont)) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value, group = time)) +
  ggh4x::facet_grid2(outcome ~ time, scales = "free", independent = "x") +
  geom_histogram(aes(y = ..density..)) +
  coord_cartesian(expand = FALSE) +
  labs(y = "Density", x = "Number of patients") +
  theme_custom() +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.title = element_blank()
  )

save_plot(
  qol_denesity,
  pdf_file = "results/outcome-density-distribution.png",
  w = 16, h = 22
)
```

**Figure 3**: Pairwise correlations between QoL scores. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r pairwise-correlation, fig.width=7, fig.height=7}
# correlations
cor <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")
cor_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor(use = "pairwise.complete.obs")

# p-values
cor_pval <- function(df) {
  p_value_matrix <- matrix(NA, ncol(df), ncol(df))
  rownames(p_value_matrix) <- colnames(df)
  colnames(p_value_matrix) <- colnames(df)
  for (i in seq_along(df)) {
    for (j in seq_along(df)) {
      tmp <- cor.test(df[[i]], df[[j]])
      p_value_matrix[i, j] <- tmp$p.value
    }
  }
  return(p_value_matrix)
}
cor_p <- qol %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_start <- qol %>%
  filter(time == "Start") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_end <- qol %>%
  filter(time == "End") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()
cor_p_post <- qol %>%
  filter(time == "Post") %>%
  dplyr::select(all_of(names(outcome_cont))) %>%
  mutate(across(c(phq9_score, sgrq_tot_score), ~ .x * -1)) %>%
  cor_pval()

# Melt the correlation matrix into a long format
cor_melt <- rbind(
  melt(cor) %>% mutate(time = "Overall"),
  melt(cor_start) %>% mutate(time = "Start of treatment"),
  melt(cor_end) %>% mutate(time = "End of treatment"),
  melt(cor_post) %>% mutate(time = "Post treatment")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c(
      "Overall",
      "Start of treatment",
      "End of treatment",
      "Post treatment"
    ))
  )

cor_p_melt <- rbind(
  melt(cor_p) %>% mutate(time = "Overall"),
  melt(cor_p_start) %>% mutate(time = "Start of treatment"),
  melt(cor_p_end) %>% mutate(time = "End of treatment"),
  melt(cor_p_post) %>% mutate(time = "Post treatment")
) %>%
  mutate(
    Var1 = recode(Var1, !!!outcome_cont),
    Var2 = recode(Var2, !!!outcome_cont),
    time = factor(time, levels = c(
      "Overall",
      "Start of treatment",
      "End of treatment",
      "Post treatment"
    ))
  )

cor_rp_melt <- left_join(
  cor_melt,
  cor_p_melt,
  by = c("Var1", "Var2", "time")
) %>%
  rename(value = value.x, p = value.y) %>%
  mutate(
    p_star = ifelse(p < .001, "***",
      ifelse(p < .01, "**",
        ifelse(p < .05, "*", "")
      )
    ),
    lab = paste0(round(value, 2), p_star),
    # lab = ifelse(Var1 == Var2, "", lab),
    across(
      c(value, lab),
      ~ ifelse(as.integer(Var1) <= as.integer(Var2), NA, .x)
    )
  )

cor_ov_pl <- ggplot(
  data = filter(cor_rp_melt, time == "Overall"),
  aes(x = Var1, y = Var2, fill = value)
) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Pearson Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_ov_pl,
  pdf_file = "results/outcome-overall-correlation.png",
  w = 12, h = 12
)
```

**Figure 4**: Pairwise correlations between QoL scores by time. Stars indicate significance levels: p < 0.05 (\*), p < 0.01 (\*\*), p < 0.001 (\*\*\*).

```{r correlation-overall, fig.width=10, fig.height=10}
# Create the heatmap
cor_pl <- ggplot(data = cor_rp_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  geom_text(
    aes(label = lab),
    color = "black",
    size = 6 / cm(1)
  ) +
  facet_wrap(~time) +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-.1, 1), space = "Lab",
    na.value = "grey80",
    name = "Pearson Correlation"
  ) +
  theme_custom() +
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1,
      hjust = 1
    ),
    axis.title = element_blank(),
    legend.position = "top",
    legend.title = element_text(vjust = .9),
    legend.key.width = unit(1.6, "cm"),
    legend.key.height = unit(0.3, "cm")
  ) +
  coord_fixed()

save_plot(
  cor_pl,
  pdf_file = "results/outcome-correlation.png",
  w = 16, h = 16
)
```

**Figure 5:** Proportion of patients with impaired QoL.

```{r proportions, fig.width=6.3, fig.height=3.9}
var_names <- c(
  "Y" = "Yes (impaired QoL)",
  "N" = "No (not impaired)",
  "D" = "Deceased",
  "L" = "Missing follow-up",
  "U" = "Unrecorded",
  "W" = "Pending visit"
)

var_colors <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1],
  "grey"
)

qol_bin_comp <- qol %>%
  dplyr::select(all_of(c(
    "time",
    "mfu", "death", "wfu",
    names(outcome_bin)
  ))) %>%
  melt(c("time", "mfu", "death", "wfu")) %>%
  group_by(time, variable) %>%
  summarize(
    Y = sum(value, na.rm = TRUE),
    N = sum(value == 0, na.rm = TRUE),
    D = sum(death),
    U = sum(is.na(value) & !mfu & !death & !wfu),
    L = sum(mfu),
    W = sum(wfu)
  ) %>%
  ungroup() %>%
  rename(outcome = variable) %>%
  melt(c("time", "outcome")) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin),
    variable = recode(variable, !!!var_names),
    variable = factor(variable, levels = var_names)
  ) %>%
  group_by(time, outcome) %>%
  mutate(p = value / sum(value) * 100) %>%
  ungroup()

qol_bin_comp_pl <- ggplot(data = qol_bin_comp, mapping = aes(x = time, y = p)) +
  facet_wrap(~outcome, nrow = 1) +
  geom_bar(
    aes(fill = variable),
    stat = "identity",
    position = position_stack(reverse = TRUE)
  ) +
  geom_text(
    data = filter(qol_bin_comp, variable == "Yes (impaired QoL)"),
    mapping = aes(group = time, label = paste0(round(p))),
    vjust = -.5, size = 6 / cm(1),
    color = var_colors[1],
    show.legend = FALSE
  ) +
  scale_fill_manual(
    values = var_colors,
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(
    y = "Proportion of patients (%)",
    x = "Treatment",
    fill = "a"
  ) +
  theme_custom() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    legend.key.width = unit(.2, "cm"),
    legend.key.height = unit(.4, "cm")
  ) +
  guides(fill = guide_legend(nrow = 1))

save_plot(
  qol_bin_comp_pl,
  pdf_file = "results/impaired-qol.png",
  w = 16, h = 10
)
```

Here are the counts and proportions shown in the plot:

```{r proportions-table}
qol_bin_comp %>%
  arrange(outcome, time, variable) %>%
  dplyr::select(
    outcome,
    time,
    variable,
    value,
    p
  ) %>%
  mutate(p = round(p)) %>%
  rename(
    Outcome = outcome,
    Time = time,
    Category = variable,
    Count = value,
    Proportion = p
  ) %>%
  knitr::kable(align = "lllrr")
```

&nbsp;

#### Patient trajectories for depression

**Figure 6**: Trajectories of patients who were depressed (defined as PHQ9-S ≥ 7) once during the study.

```{r depressed-flow, fig.width=8, fig.height=10}
var_names_dprs <- c(
  "Y" = "Depressed",
  "N" = "Not depressed",
  "D" = "Deceased",
  "L" = "Missing follow-up",
  "U" = "Unrecorded",
  "W" = "Pending visit"
)

var_colors_dprs <- c(
  wes_palette("Zissou1")[5],
  wes_palette("Zissou1")[2],
  wes_palette("Zissou1")[3],
  wes_palette("Royal1")[3],
  wes_palette("Royal1")[1],
  "grey"
)

# create links
links_dprs <- qol %>%
  dplyr::select(
    time,
    record_id,
    ment_trt_yn,
    death,
    mfu,
    wfu,
    phq9_score_bin
  ) %>%
  rename(value = phq9_score_bin) %>%
  mutate(
    value =
      ifelse(death == 1 & is.na(value) & time != "Start", var_names_dprs["D"],
        ifelse(mfu, var_names_dprs["L"],
          ifelse(wfu, var_names_dprs["W"],
            ifelse(is.na(value), var_names_dprs["U"],
              ifelse(value == 1, var_names_dprs["Y"], var_names_dprs["N"])
            )
          )
        )
      ),
    value = factor(value, levels = var_names_dprs),
    ment_trt_yn = ifelse(ment_trt_yn == 1, "Yes", "No"),
    ment_trt_yn = factor(ment_trt_yn, levels = c("No", "Yes"))
  ) %>%
  # filter patients that were depressed at least once
  group_by(record_id) %>%
  filter(any(value == var_names_dprs["Y"])) %>%
  ungroup() %>%
  group_by(time, value) %>%
  mutate(freq = n()) %>%
  ungroup()

flow_dprs_pl <- links_dprs %>%
  ggplot(aes(
    x = time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = freq
  )) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(stat = "stratum", size = 8 / cm(1)) +
  scale_fill_manual(values = var_colors_dprs) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
  scale_x_discrete(labels = c(
    "Start of treatment",
    "End of treatment",
    "Post treatment"
  )) +
  labs(y = "Number of patients") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.title.x = element_blank()
  ) +
  guides(fill = guide_legend(nrow = 2))

save_plot(
  flow_dprs_pl,
  pdf_file = "results/sankey-depressed.png",
  w = 16, h = 18
)
```

&nbsp;

## Imputation

We impute missing values in continuous QoL scores using multivariate imputation by chained equations.
We impute per patient ID using all outcomes from all time points, patient characteristics at baseline, received mental health treatment, and non-fatal serious adverse events.
Alcohol and tobacco use were also considered only at baseline because of too many missings at the end of treatment.
Data from incomplete patients (i.e. deceased patients, patients with missing follow-up visits or pending end of or post treatment visits) are ignored in the imputation model. 
However, data from deceased patients and patients with missing follow-up visits are still imputed and analysed later. 


**Figure 7**: Imputation check for a random sample of 30 patients with complete follow-up visits. Shown is the mean of imputed scores across datasets.

```{r imputation, fig.height=12}
# wide format
qol_fu <- qol %>%
  dplyr::select(all_of(c(
    "record_id", "time",
    names(outcome_cont),
    "ment_trt_yn",
    "nf_ae",
    "mfu",
    "death",
    "wfu"
  ))) %>%
  pivot_wider(
    names_from = time,
    values_from = c(
      names(outcome_cont),
      "ment_trt_yn",
      "nf_ae",
      "mfu",
      "death",
      "wfu"
    )
  ) %>%
  left_join(
    qol %>%
      filter(time == "Start") %>%
      dplyr::select(all_of(c(
        "record_id", "site",
        names(predictor_sub)
      ))),
    by = "record_id"
  ) %>%
  mutate(
    nf_ae_Start = 0,
    nf_ae_Post = 0,
    across(
      c(
        nf_ae_Start, nf_ae_End, nf_ae_Post,
        ment_trt_yn_Start, ment_trt_yn_End, ment_trt_yn_Post,
        sex, hiv, mdr, tbd_pat_cat
      ),
      ~ factor(ifelse(.x == 1, "Yes", "No"), levels = c("No", "Yes"))
    )
  )

# complete patients used for imputation model
complete_patients <- qol %>%
  group_by(record_id) %>%
  summarise(
    died = any(death),
    mfu = any(mfu),
    wfv = any(wfu)
  ) %>%
  ungroup() %>%
  mutate(
    not_complete = (died | mfu | wfv),
    complete = !not_complete
  )
complete_patients <- left_join(
  qol_fu %>% dplyr::select(record_id),
  complete_patients,
  by = "record_id"
)


# matrix which values should be imputed
where_impute <- is.na(qol_fu)
colnames(where_impute) <- colnames(qol_fu)
row.names(where_impute) <- qol_fu$record_id
where_impute[, grepl("death", colnames(where_impute))] <- FALSE
where_impute[, grepl("mfu", colnames(where_impute))] <- FALSE
where_impute[, grepl("wfu", colnames(where_impute))] <- FALSE

# predictor matrix
pred_mat <- matrix(1, ncol = ncol(qol_fu), nrow = ncol(qol_fu))
colnames(pred_mat) <- colnames(qol_fu)
row.names(pred_mat) <- colnames(qol_fu)
pred_mat[, 1] <- 0
pred_mat[1, ] <- 0
diag(pred_mat) <- 0
not_impute_cols <- c(
  paste("mfu", levels(qol$time), sep = "_"),
  paste("death", levels(qol$time), sep = "_"),
  paste("wfu", levels(qol$time), sep = "_")
)
pred_mat[not_impute_cols, ] <- 0
pred_mat[, not_impute_cols] <- 0

# methods
imp_meth <- c(
  "", # record_id (not imputed)
  rep("pmm", length(outcome_cont) * length(levels(qol$time))), # outcomes by time
  rep("pmm", length(levels(qol$time))), # ment_trt at end by time
  rep("", length(levels(qol$time))), # mfu (not imputed)
  rep("pmm", length(levels(qol$time))), # nf_ae at end
  rep("", length(levels(qol$time))), # death (not imputed)
  rep("", length(levels(qol$time))), # wfu (not imputed)
  "pmm", # site
  "pmm", # age
  "pmm", # sex
  "pmm", # hiv,
  "pmm", # mdr
  "pmm", # tbd_pat_cat
  rep("pmm", 2) # assisst alcohol and tobacco score
)

# imputation
n_datasets <- 20
qol_fu_imp <- mice(
  qol_fu,
  method = imp_meth,
  predictorMatrix = pred_mat,
  m = n_datasets,
  maxit = 10,
  seed = 12345,
  print = FALSE,
  ignore = complete_patients$not_complete,
  where = where_impute
)

# plot(qol_fu_imp, layout = c(2, 16))

# data
qol_fu_imp_long <- complete(qol_fu_imp, "long") %>%
  pivot_longer(
    cols = ends_with("_End") | ends_with("_Post") | ends_with("_Start"),
    names_to = c(".value", "time"),
    names_pattern = "(.*)_(.*)"
  ) %>%
  mutate(
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  group_by(.imp, record_id) %>%
  tidyr::fill(c(names(predictor_sub), "site"), .direction = "downup") %>%
  ungroup()

qol_fu_imp_mode <- qol_fu_imp_long %>%
  filter(!wfu, !mfu, !death) %>%
  dplyr::select(all_of(c(".imp", "record_id", "time", names(outcome_cont)))) %>%
  melt(c(".imp", "record_id", "time")) %>%
  group_by(record_id, time, variable) %>%
  summarize(
    value = mean(value)
  ) %>%
  rename(imputed = value) %>%
  left_join(
    qol %>%
      dplyr::select(all_of(c("record_id", "time", names(outcome_cont)))) %>%
      melt(c("record_id", "time")) %>%
      rename(observed = value),
    by = c("record_id", "time", "variable")
  ) %>%
  mutate(is_observed = ifelse(is.na(observed), FALSE, TRUE)) %>%
  rename(outcome = variable)

check_imp_pl <- qol_fu_imp_mode %>%
  group_by(record_id) %>%
  filter(any(!is_observed)) %>%
  ungroup() %>%
  filter(record_id %in% sample(unique(.$record_id), 30)) %>%
  ggplot(aes(
    y = time,
    x = outcome,
    color = is_observed,
    label = round(imputed)
  )) +
  geom_text(size = 8 / cm(1)) +
  facet_wrap(~record_id, ncol = 3) +
  labs(color = "Is observed") +
  scale_x_discrete(labels = function(x) outcome_cont) +
  scale_y_discrete(labels = function(x) c("Start", "End", "Post")) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

save_plot(
  check_imp_pl,
  pdf_file = "results/imputation-check.png",
  w = 16, h = 30
)
```

&nbsp;

## Estimation

- We estimate QoL changes over time, first excluding missing follow-up visits and missing visits because the patient died.
Specifically, if a patient had a baseline visit but missing follow-up, the baseline visit is still included but the follow-up is not. 
- We use Bayesian linear regression models to estimate the average QoL outcome by time point (start of, end of, and post treatment).
The average change over time is estimated by comparing the estimated average QoL outcomes between end vs start of treatment and between post and end of treatment.
- Since the outcomes are on different scales, we first compute z-scores (y - mean(y)) / sd(y) of each outcome, to make the estimation results more comparable across.
We also invert PHQ9-S and SGRQ-TS using (max_y - y) so that all changes>0 imply an QoL improvement. 
- We report the median and 95% credible interval (CrI) of the posterior draws from the Bayesian model for each estimate.

```{r model}
# prepare data
qol_fu_imp_prep <- qol_fu_imp_long %>%
  mutate(
    alc_bin = ifelse(as_alc_calc > 0, "Yes", "No"),
    tobacco_bin = ifelse(as_tobacco_calc > 0, "Yes", "No"),
    age_bin = ifelse(age < 30, "Yes", "No"),
    across(
      c(age_bin, alc_bin, tobacco_bin),
      ~ factor(.x, levels = c("No", "Yes"))
    )
  ) %>%
  mutate(
    phq9_score = 27 - phq9_score,
    sgrq_tot_score = 100 - sgrq_tot_score
  ) %>%
  group_by(.imp) %>%
  mutate(
    across(matches(names(outcome_cont)), ~ (.x - mean(.x)) / sd(.x))
  ) %>%
  ungroup()

# model
mod_qol <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score
    )
    ~ site + nf_ae + ment_trt_yn +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = qol_fu_imp_prep %>%
    filter(!mfu, !death, !wfu) %>%
    split(.$.imp),
  chains = 4,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/gaussian-regression-qol-time"
)

# posterior samples
mod_qol_smpls <- mod_qol %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration"))
```

&nbsp;

### QoL changes in survivors with follow-up visits

**Figure 8**: Estimated change in QoL outcomes between end vs start and post vs end of anti-TB treatment.

```{r modeled-qol-changes, fig.width=6.3, fig.height=4.7}
# posterior samples subset
time_smpls <- mod_qol_smpls %>%
  filter(!grepl(":", variable)) %>%
  filter(grepl("time", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    time = ifelse(grepl("End", variable), "End", "Post")
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = time, values_from = value) %>%
  mutate(
    Post = Post - End
  ) %>%
  ungroup() %>%
  pivot_longer(cols = c(End, Post)) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    name = recode(name, End = "End vs Start", Post = "Post vs End"),
    name = factor(name, levels = c("End vs Start", "Post vs End"))
  )

# plot
treat_effect_pl <- time_smpls %>%
  mutate(pos = ifelse(value > 0, "Y", "N")) %>%
  ggplot(aes(x = value, y = outcome)) +
  facet_wrap(~name) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye(
    aes(fill = after_stat(x < 0)),
    .width = 0.95,
    point_size = 1,
    linewidth = .5,
    position = position_identity()
  ) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  labs(x = "Estimated change in z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_pl,
  pdf_file = "results/qol-changes.png",
  w = 16, h = 12
)
```

Interpretation:

- All QoL outcomes improved from the start to the end of anti-TB treatment.
- The improvement at the end of treatment was smaller for 6MWT and STSTR. 
- SF12-PCS improved further post treatment.

&nbsp;

Here are the estimated changes shown in the plot:

```{r modeled-qol-changes-table}
time_smpls %>%
  group_by(outcome, name) %>%
  median_qi(.width = .95) %>%
  ungroup() %>%
  dplyr::select(
    name,
    outcome,
    value,
    .lower,
    .upper
  ) %>%
  mutate(
    across(c(value, .lower, .upper), round, 2)
  ) %>%
  arrange(name, outcome) %>%
  set_names(c(
    "Comparison", "Outcome",
    "Median", "Lower", "Upper"
  )) %>%
  knitr::kable(align = "llrrr")
```

&nbsp;

### Simulation: hypothetical changes in patients without follow-up visits to offset improvements

As a simulation exercise, we estimate for each outcome the change in QoL that would be needed 
in patients who died or with missing follow-up visits in order to offset the positive estimated QoL changes in patients with follow-up visits.
We compute this as *-beta (n_fu / n_nfu)*, where beta is the model-estimated effect, n_fu is the number of patients *with* and n_nfu is the number of patients *without* follow-up or death.


**Figure 9:** Estimated change in QoL for patients with follow-up visits (blue) vs hypothetical change in QoL for patients without missing follow-up visit or death so that net effect would be zero (red).

```{r simulation-check}
n_end <- n_distinct(qol$record_id[qol$time == "End"])
n_end_mfu <- sum(qol$mfu[qol$time == "End"])
n_end_death <- sum(qol$death[qol$time == "End"])
n_end_fu <- n_end - n_end_mfu - n_end_death
scale_fct <- 1

null_treat_effect <- time_smpls %>%
  filter(name == "End vs Start") %>%
  mutate(
    n_nfu = n_end_mfu + n_end_death,
    n_fu = n_end_fu,
    value_zero = -(n_fu / n_nfu) * value
  ) %>%
  dplyr::select(outcome, value_zero, value) %>%
  melt("outcome") %>%
  mutate(
    group = ifelse(variable == "value",
      "Follow-up patients (estimated)",
      "Missing follow-up/death (hypothetical)"
    ),
    group = factor(group, levels = c(
      "Follow-up patients (estimated)",
      "Missing follow-up/death (hypothetical)"
    ))
  )

null_treat_effect_pl <- null_treat_effect %>%
  ggplot(aes(x = value, y = outcome, fill = group)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye() +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  scale_y_discrete(limits = rev) +
  labs(x = "Estimated difference in z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )

save_plot(
  null_treat_effect_pl,
  pdf_file = "results/sensitivity-check-mfu-hypothetical-effect.png",
  w = 16, h = 14
)
```

Interpretation:

- QoL decrease for patients without follow-up would often need to be extremely large so that the net effect is zero.
- We could probably assume that such diametrically different changes in QoL for patients without follow-up visits are unlikely.

&nbsp;

Here are the estimated in blue and hypothetical offsetting changes shown in red in the plot:

```{r simulation-check-table}
null_treat_effect %>%
  dplyr::select(-variable) %>%
  group_by(outcome, group) %>%
  median_qi(.width = .95) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(
    across(c(value, .lower, .upper), round, 2),
    median_ci = paste0(value, " (95%-CrI ", .lower, "–", .upper, ")")
  ) %>%
  dplyr::select(outcome, group, median_ci) %>%
  ungroup() %>%
  pivot_wider(
    names_from = group, values_from = median_ci
  ) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrr")
```

&nbsp;

### Sensitivity check: including missing follow-up visits

As a sensitivity check, we re-estimate QoL changes including missing follow-ups and deaths (i.e. their imputed QoL outcomes).
We consider missing-follow-ups and deceased patients only once, i.e. if both end of and post-treatment visits are missing, we only consider the end of treatment visit.


**Figure 10**: Estimated change in QoL when including missing follow-up visits and death.

```{r sensitivity-full-imputation}
# modeling
mod_qol_full <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score
    )
    ~ site + nf_ae + ment_trt_yn +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = qol_fu_imp_prep %>%
    filter(!wfu) %>%
    group_by(record_id) %>%
    arrange(time) %>%
    mutate(
      death_cum = cumsum(death),
      mfu_cum = cumsum(mfu)
    ) %>%
    ungroup() %>%
    filter(death_cum < 2, mfu_cum < 2) %>%
    split(.$.imp),
  chains = 1,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/sensitivity-gaussian-regression-qol-time-with-mfu-death"
)

# posterior samples
time_full_smpls <- mod_qol_full %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration")) %>%
  filter(!grepl(":", variable)) %>%
  filter(grepl("time", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    time = ifelse(grepl("End", variable), "End", "Post")
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = time, values_from = value) %>%
  mutate(
    Post = Post - End
  ) %>%
  ungroup() %>%
  pivot_longer(cols = c(End, Post)) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    name = recode(name, End = "End vs Start", Post = "Post vs End"),
    name = factor(name, levels = c("End vs Start", "Post vs End"))
  )

# plot
treat_effect_full_pl <- time_full_smpls %>%
  mutate(pos = ifelse(value > 0, "Y", "N")) %>%
  ggplot(aes(x = value, y = outcome)) +
  facet_wrap(~name) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", color = "red") +
  stat_halfeye(
    aes(fill = after_stat(x < 0)),
    .width = 0.95,
    point_size = 1,
    linewidth = .5,
    position = position_identity()
  ) +
  scale_fill_manual(values = c("skyblue", "rosybrown2")) +
  scale_y_discrete(limits = rev) +
  labs(x = "Estimated difference in z-score") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none",
    legend.title = element_blank()
  )

save_plot(
  treat_effect_full_pl,
  pdf_file = "results/sensitivity-qol-changes-full.png",
  w = 16, h = 8
)
```

Interpretation:

- Changes are very similar.

&nbsp;

Here are the estimated changes shown in the plot:

```{r sensitivity-full-imputation-table}
time_full_smpls %>%
  group_by(outcome, name) %>%
  median_qi(.width = .95) %>%
  ungroup() %>%
  dplyr::select(
    name,
    outcome,
    value,
    .lower,
    .upper
  ) %>%
  mutate(
    across(c(value, .lower, .upper), round, 2)
  ) %>%
  arrange(name, outcome) %>%
  set_names(c(
    "Comparison", "Outcome",
    "Median", "Lower", "Upper"
  )) %>%
  knitr::kable(align = "llrrr")
```

&nbsp;

### Association with patient characteristics

In above model, the estimated QoL changes were already adjusted for patients characteristics at baseline, received mental health treatment and non-fatal serious adverse events during treatment.
Now we look into the association of QoL scores with patient characteristics.


The following predictors were transformed:

- Age: dichotomized into age < 30 and age >= 30.
- Drinker and Smoker: dichotomized into any alcohol or tobacco use denoted as an ASSIST score greater than zero.

We include time interaction effects for all predictors to estimate the association with baseline, end of treatment, and post treatment QoL. 


We report primarily the probability that patient characteristics are associated with lower or higher QoL scores. 
This probability is computed as the proportion of posterior draws from the model-estimated parameter that are smaller (lower QoL scores) or larger (higher QoL scores) than zero.


**Figure 11**: Probability that patient characteristics are associated with lower (red) or higher (blue) QoL scores. 

```{r association-by-outcome, fig.height=12, fig.width=10}
# associations of binary predictors
assoc_smpls <- mod_qol_smpls %>%
  filter(grepl(paste0(names(predictor_bin), collapse = "|"), variable)) %>%
  mutate(
    time = ifelse(
      grepl("End", variable), "End",
      ifelse(grepl("Post", variable), "Post",
        "Start"
      )
    ),
    predictor = stringi::stri_extract(
      variable,
      regex = paste0(names(predictor_bin), collapse = "|")
    ),
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    )
  ) %>%
  dplyr::select(-variable) %>%
  pivot_wider(
    names_from = time, values_from = value
  ) %>%
  mutate(
    End = Start + End,
    Post = Start + Post
  ) %>%
  pivot_longer(cols = c(Start, End, Post)) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2),
    name = factor(name, levels = c("Start", "End", "Post")),
    predictor = recode(predictor, !!!predictor_bin),
    predictor = factor(predictor, levels = predictor_bin_sub)
  )

assoc_bin <- assoc_smpls %>%
  group_by(outcome, predictor, name) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100)
  )

assoc_bin_pl <- assoc_bin %>%
  pivot_longer(
    cols = c(p_pos, p_neg),
    names_to = "direction",
    values_to = "prob"
  ) %>%
  mutate(
    direction = factor(
      ifelse(direction == "p_pos", "Positive", "Negative"),
      levels = c("Negative", "Positive")
    )
  ) %>%
  ggplot(aes(x = prob, y = name, fill = direction)) +
  facet_grid(outcome ~ predictor) +
  geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
  geom_vline(aes(xintercept = 20), linetype = "dashed", alpha = .5) +
  geom_vline(aes(xintercept = 50), linetype = "dashed", alpha = .5) +
  geom_vline(aes(xintercept = 80), linetype = "dashed", alpha = .5) +
  scale_x_continuous(expand = c(0, 0), breaks = c(0, 20, 50, 80, 100)) +
  scale_y_discrete(expand = c(0, 0), limits = rev) +
  scale_fill_manual(
    values = c(
      "Positive" = "skyblue",
      "Negative" = "rosybrown2"
    ),
    labels = c(
      "Positive" = "Higher QoL score",
      "Negative" = "Lower QoL score"
    )
  ) +
  labs(
    x = "Probability (%)",
    fill = ""
  ) +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.key.width = unit(1, "cm"),
    legend.key.height = unit(.25, "cm"),
    panel.spacing = unit(0.4, "cm"),
    strip.text.y = element_text(margin = margin(l = 10, r = 10))
  )

save_plot(
  assoc_bin_pl,
  pdf_file = "results/association-direction.png",
  w = 18, h = 18
)
```

Interpretation: 

- The plot shows whether patient characteristics are associated with a higher (blue bar left of the middle dashed line) or lower (red bar right of the middle dashed line) QoL score.
Bars left (20%) or right (80%) of the outer dashed lines show more significant associations, i.e. the odds for the association are greater than 80%/20% = 4.
- Age<30 is typically associated with higher QoL scores. 
- Female sex and relapse TB cases are typically associated with lower QoL scores.
- For HIV+ and MDR, the associations vary more.
- Since the plot shows only the direction of the association, we provide the full estimation results with the magnitude in the table below.

&nbsp;

**Table 12**: Estimation results for the change in the QoL z-scores by predictor and time. Median and 95%-CrI of the association and posterior probability that change in QoL score "dz" is smaller or greater than zero.

```{r assoc-estimation-results}
assoc_cont <- assoc_smpls %>%
  group_by(outcome, predictor, name) %>%
  median_qi(.width = .95) %>%
  ungroup()

assoc_cont %>%
  dplyr::select(outcome, predictor, name, value, .lower, .upper) %>%
  left_join(assoc_bin, by = c("outcome", "predictor", "name")) %>%
  mutate(
    across(c(value, .lower, .upper), round, 2),
    across(c(p_neg, p_pos), round)
  ) %>%
  rename(
    Outcome = outcome,
    Predictor = predictor,
    Time = name,
    Median = value,
    Lower = .lower,
    Upper = .upper,
    `Prob. dz < 0` = p_neg,
    `Prob. dz > 0` = p_pos
  ) %>%
  arrange(Predictor, Outcome, Time) %>%
  dplyr::select(
    Predictor,
    Outcome,
    Time,
    Median,
    Lower,
    Upper,
    `Prob. dz < 0`,
    `Prob. dz > 0`
  ) %>%
  knitr::kable(align = "lllrrrrr")
```


Here are the probabilities across time and outcomes per predictor:

```{r association-across-outcomes}
assoc_smpls %>%
  group_by(predictor) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "lrr")
```

Here are the probabilities across time by outcome category (mental health: PHQ9 and SF12-MCS; physical health: SF12-PCS, SMWT, and STST; overall health: SGRQ) per predictor:

```{r association-across-categories}
assoc_smpls %>%
  mutate(
    category = ifelse(outcome %in% c("PHQ9-S", "SF12-MCS"), "Mental health",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"), "Physical health",
        "Overall health"
      )
    ),
    category = factor(category,
      levels = c("Mental health", "Physical health", "Overall health")
    )
  ) %>%
  group_by(category, predictor) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, category, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Outcome category",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "llrr")
```

Here are the probabilities across outcomes by time and per predictor:

```{r association-across-outcomes-time}
assoc_smpls %>%
  group_by(predictor, name) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, name, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Time",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "llrr")
```

Here are the probabilities by time and outcome category per predictor:

```{r association-across-categories-time}
assoc_smpls %>%
  mutate(
    category = ifelse(outcome %in% c("PHQ9-S", "SF12-MCS"), "Mental health",
      ifelse(outcome %in% c("SF12-PCS", "6MWT-D", "STST-R"), "Physical health",
        "Overall health"
      )
    ),
    category = factor(category,
      levels = c("Mental health", "Physical health", "Overall health")
    )
  ) %>%
  group_by(category, predictor, name) %>%
  summarise(
    p_pos = sum(value > 0) / n()
  ) %>%
  ungroup() %>%
  mutate(
    p_neg = 1 - p_pos,
    across(c(p_pos, p_neg), ~ .x * 100),
    across(c(p_pos, p_neg), round)
  ) %>%
  dplyr::select(
    predictor, category, name, p_pos, p_neg
  ) %>%
  set_names(c(
    "Predictor",
    "Outcome category",
    "Time",
    "Prob. dz > 0",
    "Prob. dz < 0"
  )) %>%
  knitr::kable(align = "lllrr")
```

&nbsp;

### Association with adverse events

Based on the same model as before, we now look into the association of QoL scores with non-fatal serious adverse events during treatment and received mental health treatment.


**Table 13**: Estimated association of non-fatal serious adverse events with QoL at baseline and end of treatment.

```{r assoc-adverse-events}
mod_qol_smpls %>%
  filter(grepl("nf_ae", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Any non-fatal adverse events was *not* associated with QoL outcomes.

&nbsp;

**Table 14**: Estimated association of meantal health treatment with QoL.

```{r assoc-mental-health-treatment}
mod_qol_smpls %>%
  filter(grepl("ment", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Mental health treatment was *not* associated with QoL outcomes.

&nbsp;

### Association with subsequent death or missing follow-up

With the same model but only considering baseline and end of treatment visits, we now look into the association between QoL score and subsequent missing follow-up or death at the end of or post treatment.

**Table 15**: Estimated association of subsequent death with QoL at baseline and end of treatment.

```{r assoc-subsequent-death}
# model
mod_qol_mfu_lead <- brm_multiple(
  bf(
    mvbind(
      phq9_score, sf12_ment,
      sf12_phys, smwt_dist, stst_nr,
      sgrq_tot_score
    )
    ~ site + nf_ae + ment_trt_yn +
      mfu_lead + death_lead +
      age_bin * time + sex * time +
      hiv * time + mdr * time + tbd_pat_cat * time +
      alc_bin * time + tobacco_bin * time
  )
  + set_rescor(rescor = FALSE),
  data = qol_fu_imp_prep %>%
    group_by(.imp, record_id) %>%
    arrange(time) %>%
    mutate(
      mfu_lead = lead(mfu),
      death_lead = lead(death)
    ) %>%
    filter(!mfu & !death, !wfu, time != "Post") %>%
    split(.$.imp),
  chains = 4,
  prior = c(
    set_prior("normal(0, 1)", class = "sigma", resp = names(outcome_cont2)),
    set_prior("student_t(3, 0, 2.5)", class = "b", resp = names(outcome_cont2))
  ),
  iter = 1000,
  cores = 4,
  seed = 12345,
  open_progress = FALSE,
  file = "fitted-models/gaussian-regression-qol-lead-mfu-death"
)

# posterior samples
mod_qol_mfu_lead_smpls <- mod_qol_mfu_lead %>%
  spread_draws(`b_.*`, regex = TRUE) %>%
  melt(c(".chain", ".draw", ".iteration"))

mod_qol_mfu_lead_smpls %>%
  filter(grepl("death", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent death at the end of or post treatment was associated with worse QoL outcomes at baseline or end of treatment.

&nbsp;

**Table 16**: Estimated association of subsequent missing follow-up with QoL  at baseline and end of treatment.

```{r assoc-subsequent-mfu}
mod_qol_mfu_lead_smpls %>%
  filter(grepl("mfu", variable)) %>%
  mutate(
    outcome = stringi::stri_extract(
      variable,
      regex = "[a-z,0-9]{2,}"
    ),
    outcome = recode(outcome, !!!outcome_cont2),
    outcome = factor(outcome, levels = outcome_cont2)
  ) %>%
  group_by(outcome) %>%
  summarize(
    Median = median(value),
    Lower = quantile(value, 0.025),
    Upper = quantile(value, 0.975)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(Outcome = outcome) %>%
  knitr::kable(align = "lrrr")
```

Intepretation:

- Subsequent missing follow-up at the end of or post treatment was *not* associated with QoL outcomes at baseline or end of treatment.

&nbsp;

### QoL impairement over time

We now estimate and compare the proportion of patients with QoL impairment over time.
Again, we exclude missing follow-up visits and missing visits because the patient died.


**Figure 12**: Estimated proportion of patients with impaired QoL. Pr = Probability that the proportions are smaller at the end vs start of and end of vs post treatment.

```{r model-qol-impairment, results = 'hide'}
# prepare data
qol_imp_bin <- qol_fu_imp_long %>%
  filter(!mfu, !death, !wfu) %>%
  dplyr::select(
    .imp,
    record_id,
    time,
    names(outcome_cont)
  ) %>%
  mutate(
    phq9_score_bin = ifelse(phq9_score >= 7, 1, 0),
    phq9_score_bin_alt = ifelse(phq9_score >= 10, 1, 0),
    sgrq_tot_score_bin = ifelse(sgrq_tot_score > 25, 1, 0),
    smwt_dist_bin = ifelse(smwt_dist < 400, 1, 0),
    stst_nr_bin = ifelse(stst_nr < 20, 1, 0),
    sf12_phys_bin = ifelse(sf12_phys < 50, 1, 0),
    sf12_ment_bin = ifelse(sf12_ment < 42, 1, 0)
  ) %>%
  group_by(.imp, time) %>%
  summarize(
    across(c(names(outcome_bin), "phq9_score_bin_alt"), sum),
    N = n()
  ) %>%
  melt(c(".imp", "time", "N")) %>%
  ungroup() %>%
  rename(n = value) %>%
  mutate(
    end = ifelse(time %in% c("End", "Post"), 1, 0),
    post = ifelse(time == "Post", 1, 0)
  ) %>%
  dplyr::select(-time) %>%
  nest(data = -.imp)

# run models
qol_bin_smpls <- tibble(
  outcome = c(),
  end_v_start = c(),
  post_v_end = c(),
)
for (out in c(names(outcome_bin), "phq9_score_bin_alt")) {
  mod_out <- brm_multiple(
    formula = bf(
      n | trials(N) ~ end + post,
      family = binomial
    ),
    data = lapply(qol_imp_bin$data, function(x) filter(x, variable == out)),
    iter = 1000,
    chains = 1,
    cores = 1,
    seed = 12345,
    file = paste0("fitted-models/", out, ".rds")
  )
  qol_bin_smpls_out <- tibble(
    outcome = out,
    end_v_start = unlist(posterior_samples(mod_out, "b_end")),
    post_v_end = unlist(posterior_samples(mod_out, "b_post"))
  )
  qol_bin_smpls <- rbind(qol_bin_smpls, qol_bin_smpls_out)
}
```

```{r qol-impairment-over-time, fig.width=7.9, fig.height=4}
# Bayesian posterior probability
qol_bin_pp <- qol_bin_smpls %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin),
    outcome = factor(outcome, levels = outcome_bin)
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr=", value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
qol_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(outcome != "phq9_score_bin_alt") %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = recode(outcome, !!!outcome_bin)
  ) %>%
  arrange(outcome, time)

pval_ypos_end <- qol_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post <- qol_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos <- rbind(
  pval_ypos_end %>% mutate(time = "End"),
  pval_ypos_post %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_comp <- qol_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = qol_bin_pp,
    y_position = pval_ypos,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6),
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25),
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_comp,
  pdf_file = "results/qol-impairment-prevalence-by-time.png",
  w = 20, h = 10
)
```

Intepretation:

- Prevalence of impaired QoL decreased from the start to the end of treatment for all outcomes.
- Prevalene decreased further post treatment for physical scores and SGRQ.
- Mental scores (PHQ9-S and SF12-MCS) did not decrease further, but there was barely room for improvement because they were already low at the end of treatment. 

&nbsp;

Here are the mean and SD of the proportions across imputed datasets shown in the plot:

```{r qol-impairment-over-time-table}
qol_imp_prop %>%
  arrange(outcome, time) %>%
  mutate(p_m = round(p_m), p_s = round(p_s, 1)) %>%
  set_names(c(
    "Outcome",
    "Time",
    "Mean proportion",
    "SD proportion"
  )) %>%
  knitr::kable(align = "llrr")
```

&nbsp;

**Figure 13**: Estimated proportion of patients with depression for different cutoff values. Pr = Probability that the proportions are smaller at the end of and post treatment vs the start and end of treatment, respectively.

```{r sensitivity-phq9-cutoff, fig.height=4, fig.width=4}
# Bayesian posterior probability
phq9_bin_pp <- qol_bin_smpls %>%
  filter(grepl("phq9", outcome)) %>%
  group_by(outcome) %>%
  summarize(
    Pr_end = 100 * mean(end_v_start < 0),
    Pr_post = 100 * mean(post_v_end < 0)
  ) %>%
  mutate(
    outcome = ifelse(grepl("alt", outcome), "PHQ-9\u226510", "PHQ-9\u22657"),
    outcome = factor(outcome, levels = c("PHQ-9\u22657", "PHQ-9\u226510"))
  ) %>%
  melt("outcome") %>%
  mutate(
    variable = recode(variable, Pr_end = "End", Pr_post = "Post"),
    variable = factor(
      variable,
      levels = c("End", "Post")
    )
  ) %>%
  mutate(
    value = scales::percent(value / 100, accuracy = 1),
    value = ifelse(value == "100%", "Pr>99%", paste0("Pr=", value))
  ) %>%
  rename(time = variable) %>%
  arrange(outcome, time) %>%
  pull(value)


# proportion of impairments
phq9_imp_prop <- qol_imp_bin %>%
  unnest(data) %>%
  mutate(p = 100 * n / N) %>%
  mutate(
    time = ifelse(end == 0, "Start", ifelse(post == 1, "Post", "End")),
    time = factor(time, levels = c("Start", "End", "Post"))
  ) %>%
  rename(outcome = variable) %>%
  filter(grepl("phq9", outcome)) %>%
  group_by(outcome, time) %>%
  summarise(
    p_m = mean(p),
    p_s = sd(p)
  ) %>%
  mutate(
    outcome = ifelse(grepl("alt", outcome), "PHQ-9\u226510", "PHQ-9\u22657")
  ) %>%
  arrange(outcome, time)

pval_ypos_end_phq9 <- phq9_imp_prop %>%
  filter(time %in% c("Start", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_post_phq9 <- phq9_imp_prop %>%
  filter(time %in% c("Post", "End")) %>%
  mutate(p_pos = p_m + p_s) %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(p_pos)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 5)

pval_ypos_phq9 <- rbind(
  pval_ypos_end_phq9 %>% mutate(time = "End"),
  pval_ypos_post_phq9 %>% mutate(time = "Post")
) %>%
  arrange(outcome, time) %>%
  pull(p_pos)

# plot
pl_phq9_comp <- phq9_imp_prop %>%
  ggplot(aes(x = outcome, fill = time, y = p_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = p_m - p_s, ymax = p_m + p_s),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = phq9_bin_pp,
    y_position = pval_ypos_phq9,
    xmin = c(.75, 1, 1.75, 2, 2.75, 3, 3.75, 4, 4.75, 5, 5.75, 6)[1:4],
    xmax = c(1, 1.25, 2, 2.25, 3, 3.25, 4, 4.25, 5, 5.25, 6, 6.25)[1:4],
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)", x = "Pericardial changes") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_phq9_comp,
  pdf_file = "results/sensitivity-depression-prevalence-by-time.png",
  w = 10, h = 10
)
```

Interpretation:

- Naturally, there are fewer depressed patients because of the lower cutoff.
- But otherwise, the changes over time are very similar.
- No further analysis thus conducted.

&nbsp;

Here are the mean (SD) of the proportions across imputed datasets shown in the plot:

```{r sensitivity-phq9-cutoff-table}
phq9_imp_prop %>%
  rowwise() %>%
  mutate(
    p_m = round(p_m),
    p_s = round(p_s, 1),
    mean_sd = paste0(p_m, " (", p_s, ")")
  ) %>%
  ungroup() %>%
  dplyr::select(-p_m, -p_s) %>%
  pivot_wider(
    names_from = outcome,
    values_from = mean_sd
  ) %>%
  arrange(time) %>%
  rename(Time = time) %>%
  knitr::kable(align = "lrr")
```

&nbsp;

### Quantile regression

We are primarily interested in patients whose QoL did not improve through anti-TB treatment. 
To investigate, we estimate the association of patient characteristics with different quantiles 
of the QoL score distribution at the end of anti-TB treatment using quantile regression.
We adjust for the baseline QoL score, non-fatal serious adverse events and mental health treatment.
Again, we exclude missing follow-up visits and missing visits because the patient died.


**Figure 14**: Estimated change in QoL z-score (median as dot, 95%-CrI as lines) per quantile of the QoL score distribution at the end of anti-TB treatment by patient characteristic.

```{r quantile-regression, fig.width=7.9, fig.height=7.9}
qol_fu_change <- qol_fu_imp_prep %>%
  filter(
    !mfu,
    !death,
    !wfu,
    time != "Post"
  ) %>%
  group_by(.imp, record_id) %>%
  filter(n() == 2) %>%
  ungroup()

qr_post_draws <- tibble(
  outcome = character(),
  predictor = character(),
  quantile = numeric(),
  .chain = numeric(),
  .iteration = numeric(),
  .draw = numeric(),
  value = numeric()
)

for (out in names(outcome_cont)) {
  qol_fu_change_out <- left_join(
    qol_fu_change %>%
      filter(time == "End") %>%
      dplyr::select(all_of(c(
        ".imp", "record_id", out,
        "nf_ae", "ment_trt_yn"
      ))) %>%
      rename(End = !!sym(out)),
    qol_fu_change %>%
      filter(time == "Start") %>%
      dplyr::select(all_of(c(
        ".imp", "record_id", "site", out, names(predictor_bin_sub)
      ))) %>%
      rename(Start = !!sym(out)),
    by = c(".imp", "record_id")
  ) %>%
    dplyr::select(-record_id) %>%
    split(.$.imp)

  for (q in c(0.1, 0.25, 0.5, 0.75, 0.9)) {
    qr_tc <- brm_multiple(
      bf(End ~ Start + site +
        nf_ae + ment_trt_yn +
        age_bin + sex + hiv + mdr + tbd_pat_cat +
        alc_bin + tobacco_bin, quantile = q),
      data = qol_fu_change_out,
      family = asym_laplace(),
      prior = c(
        set_prior("normal(0, 1)", class = "sigma"),
        set_prior("student_t(3, 0, 2.5)", class = "b")
      ),
      chains = 4,
      iter = 1000,
      cores = 4,
      seed = 12345,
      open_progress = FALSE,
      recompile = FALSE,
      file = paste("fitted-models/quantile-regression", out, 100 * q, sep = "-")
    )

    post_draws <- qr_tc %>%
      spread_draws(`b_.*`, regex = TRUE) %>%
      melt(c(".chain", ".draw", ".iteration")) %>%
      mutate(
        variable = gsub("b_", "", variable),
        variable = gsub("Yes", "", variable),
        outcome = out,
        quantile = q
      ) %>%
      filter(variable %in% names(predictor_bin_sub)) %>%
      rename(predictor = variable) %>%
      dplyr::select(
        outcome, predictor, quantile,
        .chain, .iteration, .draw, value
      )

    qr_post_draws <- rbind(qr_post_draws, post_draws)
  }
}

qr_post_sum <- qr_post_draws %>%
  mutate(
    outcome = recode(outcome, !!!outcome_cont),
    outcome = factor(outcome, levels = outcome_cont),
    predictor = recode(predictor, !!!predictor_bin_sub),
    predictor = factor(predictor, levels = predictor_bin_sub)
  ) %>%
  group_by(outcome, predictor, quantile) %>%
  summarise(
    median = median(value),
    lower = quantile(value, 0.025),
    upper = quantile(value, 0.975)
  ) %>%
  ungroup()

qr_assoc_pl <- qr_post_sum %>%
  mutate(
    q_cat = ifelse(
      quantile < 0.5, "Bottom",
      ifelse(quantile > 0.5, "Top",
        "Middle"
      )
    ),
    q_cat = factor(q_cat, levels = c("Bottom", "Middle", "Top"))
  ) %>%
  ggplot(aes(x = quantile, color = q_cat, shape = q_cat)) +
  facet_grid(outcome ~ predictor) +
  geom_point(aes(y = median)) +
  geom_segment(aes(y = lower, yend = upper)) +
  scale_y_continuous(
    trans = "sqrt_sign",
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    labels = function(x) x * 100,
    breaks = c(0.1, 0.25, 0.5, 0.75, 0.9)
  ) +
  scale_color_manual(
    values = c(
      "Bottom" = wes_palette("Royal1")[2],
      "Middle" = "black",
      "Top" = "grey"
    )
  ) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "grey") +
  labs(
    x = "Quantile",
    y = "Estimated change in z score",
    color = "Quantile",
    shape = "Quantile"
  ) +
  theme_custom() +
  theme(
    panel.spacing = unit(0.25, "cm"),
    legend.position = "top",
    strip.text.y = element_text(margin = margin(l = 10, r = 10))
  )


save_plot(
  qr_assoc_pl,
  pdf_file = "results/quantile-regression-association.png",
  w = 18, h = 18
)
```

Interpretation:

- We focus on associations that vary between quantiles.
- PHQ9-S of patients with low scores (Q10 and Q25) at treatment end was negatively associated with HIV+ and relapse TB cases.
- PHQ9-S of patients with low scores was positively associated with MDR.
- Patients with low scores were usually negatively associated with female sex and relapse TB cases.
- Physical health of patients with low scores was positively associated with age<30.
- SF12-PCS and SGRQ-TS of patients with low scores was positively associated with HIV+.

&nbsp;

Here are the numeric estimation results of the quantile regression shown in the plot:

```{r quantile-regression-table}
qr_post_sum %>%
  mutate(across(c(median, lower, upper), round, 2)) %>%
  rename(
    Predictor = predictor,
    Outcome = outcome,
    Quantile = quantile,
    Median = median,
    Lower = lower,
    Upper = upper
  ) %>%
  dplyr::select(
    Predictor,
    Outcome,
    Quantile,
    Median,
    Lower,
    Upper
  ) %>%
  arrange(Predictor, Outcome, Quantile) %>%
  knitr::kable(align = "lllrrr")
```